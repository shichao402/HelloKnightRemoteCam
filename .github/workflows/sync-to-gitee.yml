name: Sync Release to Gitee

# å½“ GitHub Release åˆ›å»ºåŽï¼Œè‡ªåŠ¨åŒæ­¥åˆ° Gitee
on:
  release:
    types: [published]  # å½“ Release å‘å¸ƒæ—¶è§¦å‘
  workflow_call:  # å…è®¸è¢«å…¶ä»–å·¥ä½œæµè°ƒç”¨
    inputs:
      release_tag:
        description: 'è¦åŒæ­¥çš„ Release æ ‡ç­¾ï¼ˆä¾‹å¦‚ï¼šv1.0.7ï¼‰'
        required: true
        type: string
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      release_tag:
        description: 'è¦åŒæ­¥çš„ Release æ ‡ç­¾ï¼ˆä¾‹å¦‚ï¼šv1.0.7ï¼‰'
        required: true
        type: string

jobs:
  sync-release:
    name: Sync Release to Gitee
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Check Gitee Secrets
        env:
          GITEE_REPO_OWNER: ${{ secrets.GITEE_REPO_OWNER }}
          GITEE_REPO_NAME: ${{ secrets.GITEE_REPO_NAME }}
        run: |
          echo "ðŸ” æ£€æŸ¥ Gitee Secrets é…ç½®..."
          
          # æ£€æŸ¥ GITEE_TOKENï¼ˆä¸æ˜¾ç¤ºæ˜Žæ–‡ï¼‰
          if [ -z "${{ secrets.GITEE_TOKEN }}" ]; then
            echo "âŒ GITEE_TOKEN æœªé…ç½®"
            exit 1
          else
            TOKEN_LEN=${#GITEE_TOKEN}
            TOKEN_PREFIX="${GITEE_TOKEN:0:4}"
            TOKEN_SUFFIX="${GITEE_TOKEN: -4}"
            echo "âœ… GITEE_TOKEN å·²é…ç½® (é•¿åº¦: ${TOKEN_LEN}, å‰ç¼€: ${TOKEN_PREFIX}..., åŽç¼€: ...${TOKEN_SUFFIX})"
          fi
          
          # æ¸…ç†å¹¶æ˜¾ç¤º GITEE_REPO_OWNERï¼ˆæ˜¾ç¤ºå®Œæ•´å€¼ï¼Œå› ä¸ºè¿™ä¸æ˜¯æ•æ„Ÿä¿¡æ¯ï¼‰
          GITEE_REPO_OWNER_CLEAN=$(printf '%s' "${GITEE_REPO_OWNER}" | tr -d '\n\r\t' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          if [ -z "${GITEE_REPO_OWNER_CLEAN}" ]; then
            echo "âŒ GITEE_REPO_OWNER æœªé…ç½®"
            exit 1
          else
            echo "âœ… GITEE_REPO_OWNER å·²é…ç½®: ${GITEE_REPO_OWNER_CLEAN}"
          fi
          
          # æ¸…ç†å¹¶æ˜¾ç¤º GITEE_REPO_NAMEï¼ˆæ˜¾ç¤ºå®Œæ•´å€¼ï¼Œå› ä¸ºè¿™ä¸æ˜¯æ•æ„Ÿä¿¡æ¯ï¼‰
          GITEE_REPO_NAME_CLEAN=$(printf '%s' "${GITEE_REPO_NAME}" | tr -d '\n\r\t' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          if [ -z "${GITEE_REPO_NAME_CLEAN}" ]; then
            echo "âŒ GITEE_REPO_NAME æœªé…ç½®"
            exit 1
          else
            echo "âœ… GITEE_REPO_NAME å·²é…ç½®: ${GITEE_REPO_NAME_CLEAN}"
          fi
          
          GITEE_REPO="${GITEE_REPO_OWNER_CLEAN}/${GITEE_REPO_NAME_CLEAN}"
          echo "ðŸ“¦ Gitee ä»“åº“: ${GITEE_REPO}"
          echo "âœ… æ‰€æœ‰ Gitee Secrets é…ç½®æ£€æŸ¥é€šè¿‡"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # éœ€è¦å®Œæ•´åŽ†å²è®°å½•ä»¥æŽ¨é€åˆ° Gitee
          ref: main  # åˆ‡æ¢åˆ° main åˆ†æ”¯ä»¥èŽ·å–æœ€æ–°çš„ update_config_github.json

      - name: Extract version from release
        id: get_version
        run: |
          echo "ðŸ” æå– Release ç‰ˆæœ¬ä¿¡æ¯..."
          echo "  äº‹ä»¶ç±»åž‹: ${{ github.event_name }}"
          echo "  GITHUB_REF: ${GITHUB_REF}"
          
          # å¦‚æžœæ˜¯ workflow_callï¼ˆè¢«å…¶ä»–å·¥ä½œæµè°ƒç”¨ï¼‰ï¼Œä½¿ç”¨è¾“å…¥çš„ release_tag
          if [ "${{ github.event_name }}" == "workflow_call" ]; then
            TAG_NAME="${{ inputs.release_tag }}"
            echo "ðŸ“Œ å·¥ä½œæµè°ƒç”¨: ä½¿ç”¨æ ‡ç­¾ ${TAG_NAME}"
          # å¦‚æžœæ˜¯æ‰‹åŠ¨è§¦å‘ï¼Œä½¿ç”¨è¾“å…¥çš„ release_tag
          elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TAG_NAME="${{ github.event.inputs.release_tag }}"
            echo "ðŸ“Œ æ‰‹åŠ¨è§¦å‘: ä½¿ç”¨æ ‡ç­¾ ${TAG_NAME}"
          else
            # ä»Ž release äº‹ä»¶èŽ·å– tag åç§°
            # release äº‹ä»¶çš„ GITHUB_REF æ ¼å¼å¯èƒ½æ˜¯ refs/tags/v1.0.0
            TAG_NAME=${GITHUB_REF#refs/tags/}
            echo "  [è°ƒè¯•] ä»Ž GITHUB_REF æå–: ${TAG_NAME}"
            
            # å¦‚æžœæ²¡æœ‰ä»Ž GITHUB_REF èŽ·å–åˆ°ï¼Œå°è¯•ä»ŽçŽ¯å¢ƒå˜é‡èŽ·å–
            if [ -z "$TAG_NAME" ] || [ "$TAG_NAME" == "$GITHUB_REF" ]; then
              # release äº‹ä»¶å¯èƒ½ä½¿ç”¨ä¸åŒçš„ ref
              TAG_NAME=${GITHUB_REF#refs/heads/}
              echo "  [è°ƒè¯•] ä»Ž refs/heads/ æå–: ${TAG_NAME}"
            fi
            
            # å¦‚æžœè¿˜æ˜¯èŽ·å–ä¸åˆ°ï¼Œä»Ž GitHub API èŽ·å–
            if [ -z "$TAG_NAME" ] || [ "$TAG_NAME" == "$GITHUB_REF" ]; then
              echo "  [è°ƒè¯•] ä»Ž GitHub API èŽ·å–æœ€æ–° Release..."
              TAG_NAME=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                "https://api.github.com/repos/${{ github.repository }}/releases/latest" | \
                jq -r '.tag_name // empty')
              echo "  [è°ƒè¯•] API è¿”å›ž: ${TAG_NAME}"
            fi
          fi
          
          # ç¡®ä¿ TAG_NAME ä¸ä¸ºç©º
          if [ -z "$TAG_NAME" ]; then
            echo "âŒ æ— æ³•èŽ·å– Release æ ‡ç­¾"
            exit 1
          fi
          
          VERSION=${TAG_NAME#v}  # åŽ»æŽ‰ v å‰ç¼€
          echo "TAG_NAME=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "âœ… Release æ ‡ç­¾: ${TAG_NAME}"
          echo "âœ… ç‰ˆæœ¬å·: ${VERSION}"

      - name: Get Release info
        uses: actions/github-script@v7
        id: release_info
        with:
          script: |
            // ä»Ž release äº‹ä»¶èŽ·å– release ä¿¡æ¯
            let release;
            const tagName = '${{ steps.get_version.outputs.TAG_NAME }}';
            const repoOwner = context.repo.owner;
            const repoName = context.repo.repo;
            
            console.log(`ðŸ” èŽ·å– Release ä¿¡æ¯:`);
            console.log(`  æ ‡ç­¾: ${tagName}`);
            console.log(`  ä»“åº“: ${repoOwner}/${repoName}`);
            console.log(`  äº‹ä»¶ç±»åž‹: ${context.eventName}`);
            
            if (context.payload.release && context.eventName === 'release') {
              // release äº‹ä»¶ç›´æŽ¥åŒ…å« release ä¿¡æ¯
              release = context.payload.release;
              console.log('âœ… ä»Žäº‹ä»¶è´Ÿè½½èŽ·å– Release ä¿¡æ¯');
            } else {
              // æ‰‹åŠ¨è§¦å‘æˆ–å…¶ä»–æƒ…å†µï¼Œé€šè¿‡ API èŽ·å–
              const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/releases/tags/${tagName}`;
              console.log(`ðŸ“¡ é€šè¿‡ GitHub API èŽ·å– Release ä¿¡æ¯...`);
              console.log(`  API URL: ${apiUrl}`);
              
              try {
                const { data } = await github.rest.repos.getReleaseByTag({
                  owner: repoOwner,
                  repo: repoName,
                  tag: tagName
                });
                release = data;
                console.log(`âœ… æˆåŠŸèŽ·å– Release ä¿¡æ¯`);
                console.log(`  Release ID: ${release.id}`);
                console.log(`  Release URL: ${release.html_url}`);
              } catch (error) {
                console.error(`âŒ èŽ·å– Release å¤±è´¥:`);
                console.error(`  é”™è¯¯ä¿¡æ¯: ${error.message}`);
                console.error(`  HTTP çŠ¶æ€ç : ${error.status || 'N/A'}`);
                core.setFailed(`Failed to get release for tag ${tagName}: ${error.message}`);
                throw error;
              }
            }
            
            // æ˜¾ç¤º Release è¯¦ç»†ä¿¡æ¯
            console.log(`\nðŸ“‹ Release è¯¦ç»†ä¿¡æ¯:`);
            console.log(`  ID: ${release.id}`);
            console.log(`  åç§°: ${release.name || release.tag_name}`);
            console.log(`  æ ‡ç­¾: ${release.tag_name}`);
            console.log(`  åˆ›å»ºæ—¶é—´: ${release.created_at}`);
            console.log(`  å‘å¸ƒæ—¶é—´: ${release.published_at || 'æœªå‘å¸ƒ'}`);
            console.log(`  ä½œè€…: ${release.author?.login || 'N/A'}`);
            console.log(`  URL: ${release.html_url}`);
            console.log(`  è‰ç¨¿: ${release.draft ? 'æ˜¯' : 'å¦'}`);
            console.log(`  é¢„å‘å¸ƒ: ${release.prerelease ? 'æ˜¯' : 'å¦'}`);
            
            const assets = release.assets || [];
            console.log(`\nðŸ“¦ æ‰¾åˆ° ${assets.length} ä¸ªæž„å»ºäº§ç‰©:`);
            assets.forEach((asset, index) => {
              const sizeMB = (asset.size / 1024 / 1024).toFixed(2);
              const downloadCount = asset.download_count || 0;
              console.log(`  ${index + 1}. ${asset.name}`);
              console.log(`     å¤§å°: ${sizeMB} MB`);
              console.log(`     ä¸‹è½½æ¬¡æ•°: ${downloadCount}`);
              console.log(`     ä¸‹è½½ URL: ${asset.browser_download_url}`);
            });
            
            // éªŒè¯ Release çŠ¶æ€
            if (release.draft) {
              console.log('\nâš ï¸ è­¦å‘Š: Release æ˜¯è‰ç¨¿çŠ¶æ€');
            }
            if (release.prerelease) {
              console.log('\nâš ï¸ è­¦å‘Š: Release æ˜¯é¢„å‘å¸ƒç‰ˆæœ¬');
            }
            
            // æ˜¾ç¤º Release æ­£æ–‡ï¼ˆå‰500å­—ç¬¦ï¼‰
            if (release.body) {
              const bodyPreview = release.body.length > 500 
                ? release.body.substring(0, 500) + '...' 
                : release.body;
              console.log(`\nðŸ“ Release æ­£æ–‡é¢„è§ˆ:`);
              console.log(bodyPreview);
            }
            
            // ä¿å­˜ release ä¿¡æ¯
            core.setOutput('release_body', release.body || '');
            core.setOutput('release_name', release.name || release.tag_name);
            
            // è¿”å›ž assets ä¿¡æ¯ä¾›åŽç»­æ­¥éª¤ä½¿ç”¨
            return JSON.stringify(assets.map(a => ({
              name: a.name,
              url: a.browser_download_url
            })));

      - name: Download assets files
        env:
          GH_TOKEN: ${{ github.token }}  # GitHub CLI éœ€è¦è¿™ä¸ª token
        run: |
          TAG_NAME="${{ steps.get_version.outputs.TAG_NAME }}"
          echo "ðŸ“¥ ä¸‹è½½æž„å»ºäº§ç‰©æ–‡ä»¶..."
          echo "  Release æ ‡ç­¾: ${TAG_NAME}"
          
          mkdir -p release-assets
          echo "  ç›®æ ‡ç›®å½•: $(realpath release-assets)"
          
          # ä½¿ç”¨ GitHub CLI ä¸‹è½½æ–‡ä»¶ï¼ˆå¦‚æžœå¯ç”¨ï¼‰
          if command -v gh &> /dev/null; then
            echo "  ä½¿ç”¨ GitHub CLI ä¸‹è½½æ–‡ä»¶..."
            echo "  å‘½ä»¤: gh release download \"${TAG_NAME}\" -D release-assets"
            
            DOWNLOAD_OUTPUT=$(gh release download "${TAG_NAME}" -D release-assets 2>&1)
            DOWNLOAD_EXIT_CODE=$?
            
            if [ $DOWNLOAD_EXIT_CODE -eq 0 ]; then
              echo "âœ… GitHub CLI ä¸‹è½½å®Œæˆ"
            else
              echo "âš ï¸ GitHub CLI ä¸‹è½½å¯èƒ½å¤±è´¥ (é€€å‡ºç : ${DOWNLOAD_EXIT_CODE})"
              echo "  è¾“å‡º: ${DOWNLOAD_OUTPUT}"
            fi
          else
            # æ‰‹åŠ¨ä¸‹è½½ï¼ˆä½¿ç”¨ curlï¼‰
            echo "  ä½¿ç”¨ curl æ‰‹åŠ¨ä¸‹è½½æ–‡ä»¶..."
            ASSETS='${{ steps.release_info.outputs.result }}'
            
            ASSET_COUNT=$(echo "$ASSETS" | jq 'length' 2>/dev/null || echo "0")
            echo "  éœ€è¦ä¸‹è½½ ${ASSET_COUNT} ä¸ªæ–‡ä»¶"
            
            DOWNLOAD_SUCCESS=0
            DOWNLOAD_FAILED=0
            
            echo "$ASSETS" | jq -r '.[] | "\(.url)|\(.name)"' | while IFS='|' read -r url name; do
              if [ -n "$url" ] && [ -n "$name" ]; then
                echo "  ðŸ“¦ ä¸‹è½½ ${name}..."
                echo "    ä¸‹è½½ URL: ${url}"
                
                DOWNLOAD_RESPONSE=$(curl -s -w "\n%{http_code}" -L \
                  -H "Authorization: token ${{ github.token }}" \
                  -o "release-assets/${name}" \
                  "${url}")
                
                HTTP_CODE=$(echo "$DOWNLOAD_RESPONSE" | tail -n1)
                
                if [ "$HTTP_CODE" = "200" ]; then
                  FILE_SIZE=$(du -h "release-assets/${name}" | cut -f1)
                  echo "    âœ… ${name} ä¸‹è½½æˆåŠŸ (${FILE_SIZE})"
                else
                  echo "    âŒ ${name} ä¸‹è½½å¤±è´¥ (HTTP ${HTTP_CODE})"
                fi
              fi
            done
          fi
          
          echo ""
          echo "ðŸ“‹ å·²ä¸‹è½½çš„æ–‡ä»¶åˆ—è¡¨:"
          ls -lh release-assets/ || echo "  ç›®å½•ä¸ºç©ºæˆ–ä¸å­˜åœ¨"
          
          FILE_COUNT=$(find release-assets -type f 2>/dev/null | wc -l)
          TOTAL_SIZE=$(du -sh release-assets 2>/dev/null | cut -f1 || echo "0")
          echo ""
          echo "  æ–‡ä»¶æ•°é‡: ${FILE_COUNT}"
          echo "  æ€»å¤§å°: ${TOTAL_SIZE}"

      - name: Create Gitee Release
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_REPO_OWNER: ${{ secrets.GITEE_REPO_OWNER }}
          GITEE_REPO_NAME: ${{ secrets.GITEE_REPO_NAME }}
        run: |
          TAG_NAME_RAW="${{ steps.get_version.outputs.TAG_NAME }}"
          RELEASE_NAME="${{ steps.release_info.outputs.release_name }}"
          RELEASE_BODY="${{ steps.release_info.outputs.release_body }}"
          
          # æ¸…ç† TAG_NAMEï¼šåŽ»é™¤æ¢è¡Œç¬¦ã€å›žè½¦ç¬¦å’Œå‰åŽç©ºæ ¼
          TAG_NAME=$(printf '%s' "${TAG_NAME_RAW}" | tr -d '\n\r\t' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          
          # æ¸…ç†å¹¶åŽ»é™¤æ¢è¡Œç¬¦ã€å›žè½¦ç¬¦å’Œå‰åŽç©ºæ ¼
          GITEE_REPO_OWNER=$(printf '%s' "${GITEE_REPO_OWNER}" | tr -d '\n\r\t' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          GITEE_REPO_NAME=$(printf '%s' "${GITEE_REPO_NAME}" | tr -d '\n\r\t' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          
          # URL ç¼–ç 
          GITEE_REPO_OWNER_ENCODED=$(printf '%s' "${GITEE_REPO_OWNER}" | jq -sRr @uri)
          GITEE_REPO_NAME_ENCODED=$(printf '%s' "${GITEE_REPO_NAME}" | jq -sRr @uri)
          TAG_NAME_ENCODED=$(printf '%s' "${TAG_NAME}" | jq -sRr @uri)
          GITEE_REPO="${GITEE_REPO_OWNER}/${GITEE_REPO_NAME}"
          
          echo "ðŸš€ åˆ›å»º Gitee Release..."
          echo "  æ ‡ç­¾: ${TAG_NAME}"
          echo "  åç§°: ${RELEASE_NAME}"
          echo "  ä»“åº“: ${GITEE_REPO}"
          echo "  Owner: ${GITEE_REPO_OWNER}"
          echo "  Repo Name: ${GITEE_REPO_NAME}"
          echo "  æ ‡ç­¾ (ç¼–ç åŽ): ${TAG_NAME_ENCODED}"
          
          # èŽ·å–æ ‡ç­¾å¯¹åº”çš„ commit SHAï¼ˆtarget_commitishï¼‰
          echo "ðŸ” èŽ·å–æ ‡ç­¾å¯¹åº”çš„ commit SHA..."
          TAG_SHA=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/git/refs/tags/${TAG_NAME}" | \
            jq -r '.object.sha // empty')
          
          # å¦‚æžœé€šè¿‡ refs/tags èŽ·å–ä¸åˆ°ï¼Œå°è¯•é€šè¿‡ tags API èŽ·å–
          if [ -z "$TAG_SHA" ] || [ "$TAG_SHA" == "null" ]; then
            echo "  [è°ƒè¯•] é€šè¿‡ refs/tags æœªèŽ·å–åˆ°ï¼Œå°è¯•é€šè¿‡ tags API..."
            TAG_SHA=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/git/tags/${TAG_NAME}" | \
              jq -r '.object.sha // empty')
          fi
          
          # å¦‚æžœè¿˜æ˜¯èŽ·å–ä¸åˆ°ï¼Œå°è¯•èŽ·å–æ ‡ç­¾å¯¹è±¡æŒ‡å‘çš„ commit
          if [ -z "$TAG_SHA" ] || [ "$TAG_SHA" == "null" ]; then
            echo "  [è°ƒè¯•] é€šè¿‡ tags API æœªèŽ·å–åˆ°ï¼Œå°è¯•èŽ·å–æ ‡ç­¾æŒ‡å‘çš„ commit..."
            TAG_INFO=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/git/refs/tags/${TAG_NAME}")
            TAG_OBJECT_SHA=$(echo "$TAG_INFO" | jq -r '.object.sha // empty')
            if [ -n "$TAG_OBJECT_SHA" ] && [ "$TAG_OBJECT_SHA" != "null" ]; then
              TAG_OBJECT=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                "https://api.github.com/repos/${{ github.repository }}/git/tags/${TAG_OBJECT_SHA}")
              TAG_SHA=$(echo "$TAG_OBJECT" | jq -r '.object.sha // empty')
            fi
          fi
          
          if [ -z "$TAG_SHA" ] || [ "$TAG_SHA" == "null" ]; then
            echo "âš ï¸ è­¦å‘Š: æ— æ³•èŽ·å–æ ‡ç­¾ ${TAG_NAME} å¯¹åº”çš„ commit SHAï¼Œå°†ä½¿ç”¨é»˜è®¤åˆ†æ”¯"
            TARGET_COMMITISH=""
          else
            TARGET_COMMITISH="${TAG_SHA}"
            echo "âœ… æ ‡ç­¾ ${TAG_NAME} å¯¹åº”çš„ commit SHA: ${TAG_SHA:0:7}..."
          fi
          
          # é¦–å…ˆéªŒè¯ä»“åº“æ˜¯å¦å­˜åœ¨
          echo "ðŸ” éªŒè¯ Gitee ä»“åº“æ˜¯å¦å­˜åœ¨..."
          REPO_API_URL="https://gitee.com/api/v5/repos/${GITEE_REPO_OWNER_ENCODED}/${GITEE_REPO_NAME_ENCODED}"
          echo "  API URL: ${REPO_API_URL}"
          
          REPO_CHECK=$(curl -s -w "\n%{http_code}" -X GET \
            -H "Authorization: token ${GITEE_TOKEN}" \
            "${REPO_API_URL}")
          
          REPO_CHECK_HTTP_CODE=$(echo "$REPO_CHECK" | tail -n1)
          REPO_CHECK_BODY=$(echo "$REPO_CHECK" | sed '$d')
          
          echo "  HTTP çŠ¶æ€ç : ${REPO_CHECK_HTTP_CODE}"
          
          if [ "$REPO_CHECK_HTTP_CODE" != "200" ]; then
            ERROR_MSG=$(echo "$REPO_CHECK_BODY" | jq -r '.message // .error // "æœªçŸ¥é”™è¯¯"' 2>/dev/null || echo "$REPO_CHECK_BODY")
            echo "âŒ Gitee ä»“åº“ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—® (HTTP ${REPO_CHECK_HTTP_CODE})"
            echo "  API URL: ${REPO_API_URL}"
            echo "  é”™è¯¯ä¿¡æ¯: ${ERROR_MSG}"
            echo "  å®Œæ•´å“åº”: ${REPO_CHECK_BODY}"
            echo ""
            echo "  è¯·æ£€æŸ¥ï¼š"
            echo "    1. GITEE_REPO_OWNER æ˜¯å¦æ­£ç¡®: ${GITEE_REPO_OWNER}"
            echo "    2. GITEE_REPO_NAME æ˜¯å¦æ­£ç¡®: ${GITEE_REPO_NAME}"
            echo "    3. GITEE_TOKEN æ˜¯å¦æœ‰è®¿é—®è¯¥ä»“åº“çš„æƒé™"
            exit 1
          fi
          
          REPO_FULL_NAME=$(echo "$REPO_CHECK_BODY" | jq -r '.full_name // empty' 2>/dev/null || echo "")
          REPO_DESCRIPTION=$(echo "$REPO_CHECK_BODY" | jq -r '.description // empty' 2>/dev/null || echo "")
          echo "âœ… Gitee ä»“åº“éªŒè¯é€šè¿‡"
          if [ -n "$REPO_FULL_NAME" ]; then
            echo "  ä»“åº“å…¨å: ${REPO_FULL_NAME}"
          fi
          if [ -n "$REPO_DESCRIPTION" ]; then
            echo "  ä»“åº“æè¿°: ${REPO_DESCRIPTION}"
          fi
          
          # æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æžœä¸å­˜åœ¨åˆ™åˆ›å»º
          echo "ðŸ” æ£€æŸ¥ Gitee æ ‡ç­¾æ˜¯å¦å­˜åœ¨..."
          TAG_CHECK_API_URL="https://gitee.com/api/v5/repos/${GITEE_REPO_OWNER_ENCODED}/${GITEE_REPO_NAME_ENCODED}/tags/${TAG_NAME_ENCODED}"
          echo "  æ ‡ç­¾æ£€æŸ¥ API URL: ${TAG_CHECK_API_URL}"
          
          TAG_CHECK=$(curl -s -w "\n%{http_code}" -X GET \
            -H "Authorization: token ${GITEE_TOKEN}" \
            "${TAG_CHECK_API_URL}")
          
          TAG_CHECK_HTTP_CODE=$(echo "$TAG_CHECK" | tail -n1)
          TAG_CHECK_BODY=$(echo "$TAG_CHECK" | sed '$d')
          
          echo "  HTTP çŠ¶æ€ç : ${TAG_CHECK_HTTP_CODE}"
          
          if [ "$TAG_CHECK_HTTP_CODE" != "200" ]; then
            echo "âš ï¸ æ ‡ç­¾ ${TAG_NAME} ä¸å­˜åœ¨ï¼Œéœ€è¦åˆ›å»º..."
            
            # ç¡®ä¿æœ‰ commit SHA
            if [ -z "$TARGET_COMMITISH" ] || [ "$TARGET_COMMITISH" == "" ]; then
              echo "âŒ é”™è¯¯: æ— æ³•åˆ›å»ºæ ‡ç­¾ï¼Œå› ä¸ºç¼ºå°‘ commit SHA"
              echo "  è¯·ç¡®ä¿æ ‡ç­¾ ${TAG_NAME} åœ¨ GitHub ä¸­å­˜åœ¨"
              exit 1
            fi
            
            # åˆ›å»ºæ ‡ç­¾
            echo "ðŸ“ åˆ›å»º Gitee æ ‡ç­¾ ${TAG_NAME}..."
            CREATE_TAG_API_URL="https://gitee.com/api/v5/repos/${GITEE_REPO_OWNER_ENCODED}/${GITEE_REPO_NAME_ENCODED}/tags"
            echo "  åˆ›å»ºæ ‡ç­¾ API URL: ${CREATE_TAG_API_URL}"
            
            CREATE_TAG_BODY=$(echo "{
              \"refs\": \"${TARGET_COMMITISH}\",
              \"tag_name\": \"${TAG_NAME}\",
              \"message\": \"Release ${TAG_NAME}\"
            }" | jq -c .)
            echo "  è¯·æ±‚ä½“: ${CREATE_TAG_BODY}"
            
            CREATE_TAG_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
              -H "Content-Type: application/json" \
              -H "Authorization: token ${GITEE_TOKEN}" \
              -d "${CREATE_TAG_BODY}" \
              "${CREATE_TAG_API_URL}")
            
            CREATE_TAG_HTTP_CODE=$(echo "$CREATE_TAG_RESPONSE" | tail -n1)
            CREATE_TAG_BODY_RESPONSE=$(echo "$CREATE_TAG_RESPONSE" | sed '$d')
            
            echo "  å“åº” HTTP çŠ¶æ€ç : ${CREATE_TAG_HTTP_CODE}"
            
            if [ "$CREATE_TAG_HTTP_CODE" = "200" ] || [ "$CREATE_TAG_HTTP_CODE" = "201" ]; then
              echo "âœ… æ ‡ç­¾ ${TAG_NAME} åˆ›å»ºæˆåŠŸ"
            else
              ERROR_MSG=$(echo "$CREATE_TAG_BODY_RESPONSE" | jq -r '.message // .error // "æœªçŸ¥é”™è¯¯"' 2>/dev/null || echo "$CREATE_TAG_BODY_RESPONSE")
              echo "âŒ åˆ›å»ºæ ‡ç­¾å¤±è´¥ (HTTP ${CREATE_TAG_HTTP_CODE})"
              echo "  é”™è¯¯ä¿¡æ¯: ${ERROR_MSG}"
              echo "  å®Œæ•´å“åº”: ${CREATE_TAG_BODY_RESPONSE}"
              
              # å¦‚æžœé”™è¯¯æ˜¯æ ‡ç­¾å·²å­˜åœ¨ï¼Œç»§ç»­æ‰§è¡Œ
              if echo "$ERROR_MSG" | grep -qi "å·²å­˜åœ¨\|already exists\|duplicate"; then
                echo "âš ï¸ æ ‡ç­¾å¯èƒ½å·²å­˜åœ¨ï¼Œç»§ç»­æ‰§è¡Œ..."
              else
                exit 1
              fi
            fi
          else
            TAG_COMMIT=$(echo "$TAG_CHECK_BODY" | jq -r '.commit.sha // empty' 2>/dev/null || echo "")
            echo "âœ… æ ‡ç­¾ ${TAG_NAME} å·²å­˜åœ¨"
            if [ -n "$TAG_COMMIT" ]; then
              echo "  æ ‡ç­¾æŒ‡å‘çš„ commit: ${TAG_COMMIT:0:7}..."
            fi
          fi
          
          # æ£€æŸ¥ Release æ˜¯å¦å·²å­˜åœ¨
          echo "ðŸ” æ£€æŸ¥ Gitee Release æ˜¯å¦å·²å­˜åœ¨..."
          RELEASE_CHECK_API_URL="https://gitee.com/api/v5/repos/${GITEE_REPO_OWNER_ENCODED}/${GITEE_REPO_NAME_ENCODED}/releases/tags/${TAG_NAME_ENCODED}"
          echo "  API URL: ${RELEASE_CHECK_API_URL}"
          
          EXISTING_RELEASE=$(curl -s -w "\n%{http_code}" -X GET \
            -H "Authorization: token ${GITEE_TOKEN}" \
            "${RELEASE_CHECK_API_URL}")
          
          EXISTING_HTTP_CODE=$(echo "$EXISTING_RELEASE" | tail -n1)
          EXISTING_BODY=$(echo "$EXISTING_RELEASE" | sed '$d')
          
          echo "  HTTP çŠ¶æ€ç : ${EXISTING_HTTP_CODE}"
          
          if [ "$EXISTING_HTTP_CODE" = "200" ] && echo "${EXISTING_BODY}" | grep -q '"id"'; then
            RELEASE_ID=$(echo "${EXISTING_BODY}" | jq -r '.id // empty')
            RELEASE_EXISTING_NAME=$(echo "${EXISTING_BODY}" | jq -r '.name // empty' 2>/dev/null || echo "")
            RELEASE_EXISTING_CREATED=$(echo "${EXISTING_BODY}" | jq -r '.created_at // empty' 2>/dev/null || echo "")
            echo "âš ï¸ Gitee Release å·²å­˜åœ¨ (ID: ${RELEASE_ID})ï¼Œå°†æ›´æ–°..."
            if [ -n "$RELEASE_EXISTING_NAME" ]; then
              echo "  çŽ°æœ‰ Release åç§°: ${RELEASE_EXISTING_NAME}"
            fi
            if [ -n "$RELEASE_EXISTING_CREATED" ]; then
              echo "  åˆ›å»ºæ—¶é—´: ${RELEASE_EXISTING_CREATED}"
            fi
            
            # æ›´æ–°çŽ°æœ‰ Release
            UPDATE_API_URL="https://gitee.com/api/v5/repos/${GITEE_REPO_OWNER_ENCODED}/${GITEE_REPO_NAME_ENCODED}/releases/${RELEASE_ID}"
            echo "  æ›´æ–° API URL: ${UPDATE_API_URL}"
            
            # æž„å»ºæ›´æ–°è¯·æ±‚ä½“
            UPDATE_BODY_JSON=$(echo "${RELEASE_BODY}" | jq -Rs .)
            if [ -n "$TARGET_COMMITISH" ]; then
              REQUEST_BODY=$(echo "{
                \"name\": \"${RELEASE_NAME}\",
                \"body\": ${UPDATE_BODY_JSON},
                \"target_commitish\": \"${TARGET_COMMITISH}\",
                \"prerelease\": false
              }" | jq -c .)
            else
              REQUEST_BODY=$(echo "{
                \"name\": \"${RELEASE_NAME}\",
                \"body\": ${UPDATE_BODY_JSON},
                \"prerelease\": false
              }" | jq -c .)
            fi
            echo "  è¯·æ±‚ä½“: ${REQUEST_BODY}"
            
            RESPONSE=$(curl -s -w "\n%{http_code}" -X PATCH \
              -H "Content-Type: application/json" \
              -H "Authorization: token ${GITEE_TOKEN}" \
              -d "${REQUEST_BODY}" \
              "${UPDATE_API_URL}")
          else
            # åˆ›å»ºæ–° Release
            echo "ðŸ“ åˆ›å»ºæ–°çš„ Gitee Release..."
            CREATE_API_URL="https://gitee.com/api/v5/repos/${GITEE_REPO_OWNER_ENCODED}/${GITEE_REPO_NAME_ENCODED}/releases"
            echo "  åˆ›å»º API URL: ${CREATE_API_URL}"
            
            # æž„å»ºåˆ›å»ºè¯·æ±‚ä½“
            CREATE_BODY_JSON=$(echo "${RELEASE_BODY}" | jq -Rs .)
            if [ -n "$TARGET_COMMITISH" ]; then
              REQUEST_BODY=$(echo "{
                \"tag_name\": \"${TAG_NAME}\",
                \"name\": \"${RELEASE_NAME}\",
                \"body\": ${CREATE_BODY_JSON},
                \"target_commitish\": \"${TARGET_COMMITISH}\",
                \"prerelease\": false
              }" | jq -c .)
            else
              REQUEST_BODY=$(echo "{
                \"tag_name\": \"${TAG_NAME}\",
                \"name\": \"${RELEASE_NAME}\",
                \"body\": ${CREATE_BODY_JSON},
                \"prerelease\": false
              }" | jq -c .)
            fi
            echo "  è¯·æ±‚ä½“: ${REQUEST_BODY}"
            
            RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
              -H "Content-Type: application/json" \
              -H "Authorization: token ${GITEE_TOKEN}" \
              -d "${REQUEST_BODY}" \
              "${CREATE_API_URL}")
          fi
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "  å“åº” HTTP çŠ¶æ€ç : ${HTTP_CODE}"
          
          # æ£€æŸ¥å“åº”
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
            if echo "${RESPONSE_BODY}" | grep -q '"id"'; then
              RELEASE_ID=$(echo "${RESPONSE_BODY}" | jq -r '.id // empty')
              RELEASE_TAG_NAME=$(echo "${RESPONSE_BODY}" | jq -r '.tag_name // empty' 2>/dev/null || echo "")
              RELEASE_CREATED=$(echo "${RESPONSE_BODY}" | jq -r '.created_at // empty' 2>/dev/null || echo "")
              echo "âœ… Gitee Release åˆ›å»º/æ›´æ–°æˆåŠŸ"
              echo "  Release ID: ${RELEASE_ID}"
              if [ -n "$RELEASE_TAG_NAME" ]; then
                echo "  æ ‡ç­¾: ${RELEASE_TAG_NAME}"
              fi
              if [ -n "$RELEASE_CREATED" ]; then
                echo "  åˆ›å»ºæ—¶é—´: ${RELEASE_CREATED}"
              fi
              echo "  å®Œæ•´å“åº”: ${RESPONSE_BODY}"
            else
              echo "âš ï¸ å“åº”æ ¼å¼å¼‚å¸¸ï¼Œä½† HTTP çŠ¶æ€ç ä¸º ${HTTP_CODE}"
              echo "  å“åº”å†…å®¹: ${RESPONSE_BODY}"
            fi
          else
            ERROR_MSG=$(echo "${RESPONSE_BODY}" | jq -r '.message // .error // "æœªçŸ¥é”™è¯¯"' 2>/dev/null || echo "${RESPONSE_BODY}")
            echo "âŒ Gitee Release åˆ›å»º/æ›´æ–°å¤±è´¥ (HTTP ${HTTP_CODE})"
            echo "  é”™è¯¯ä¿¡æ¯: ${ERROR_MSG}"
            echo "  å®Œæ•´å“åº”: ${RESPONSE_BODY}"
            exit 1
          fi

      - name: Upload assets to Gitee Release
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_REPO_OWNER: ${{ secrets.GITEE_REPO_OWNER }}
          GITEE_REPO_NAME: ${{ secrets.GITEE_REPO_NAME }}
        run: |
          TAG_NAME="${{ steps.get_version.outputs.TAG_NAME }}"
          
          # æ¸…ç†å¹¶åŽ»é™¤æ¢è¡Œç¬¦ã€å›žè½¦ç¬¦å’Œå‰åŽç©ºæ ¼
          GITEE_REPO_OWNER=$(printf '%s' "${GITEE_REPO_OWNER}" | tr -d '\n\r\t' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          GITEE_REPO_NAME=$(printf '%s' "${GITEE_REPO_NAME}" | tr -d '\n\r\t' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          
          # URL ç¼–ç 
          GITEE_REPO_OWNER_ENCODED=$(printf '%s' "${GITEE_REPO_OWNER}" | jq -sRr @uri)
          GITEE_REPO_NAME_ENCODED=$(printf '%s' "${GITEE_REPO_NAME}" | jq -sRr @uri)
          TAG_NAME_ENCODED=$(printf '%s' "${TAG_NAME}" | jq -sRr @uri)
          GITEE_REPO="${GITEE_REPO_OWNER}/${GITEE_REPO_NAME}"
          
          echo "ðŸ“¤ ä¸Šä¼ æž„å»ºäº§ç‰©åˆ° Gitee Release..."
          echo "  æ ‡ç­¾: ${TAG_NAME}"
          echo "  ä»“åº“: ${GITEE_REPO}"
          echo "  Owner: ${GITEE_REPO_OWNER}"
          echo "  Repo Name: ${GITEE_REPO_NAME}"
          
          # é¦–å…ˆèŽ·å– Release IDï¼ˆç”¨äºŽä¸Šä¼ æ–‡ä»¶ï¼‰
          echo "ðŸ” èŽ·å– Gitee Release ID..."
          RELEASE_INFO_API_URL="https://gitee.com/api/v5/repos/${GITEE_REPO_OWNER_ENCODED}/${GITEE_REPO_NAME_ENCODED}/releases/tags/${TAG_NAME_ENCODED}"
          echo "  API URL: ${RELEASE_INFO_API_URL}"
          
          RELEASE_INFO=$(curl -s -w "\n%{http_code}" -X GET \
            -H "Authorization: token ${GITEE_TOKEN}" \
            "${RELEASE_INFO_API_URL}")
          
          RELEASE_INFO_HTTP_CODE=$(echo "$RELEASE_INFO" | tail -n1)
          RELEASE_INFO_BODY=$(echo "$RELEASE_INFO" | sed '$d')
          
          echo "  HTTP çŠ¶æ€ç : ${RELEASE_INFO_HTTP_CODE}"
          
          if [ "$RELEASE_INFO_HTTP_CODE" != "200" ] || ! echo "${RELEASE_INFO_BODY}" | grep -q '"id"'; then
            echo "âŒ æ— æ³•èŽ·å– Gitee Release ä¿¡æ¯ (HTTP ${RELEASE_INFO_HTTP_CODE})"
            echo "  API URL: ${RELEASE_INFO_API_URL}"
            echo "  å“åº”: ${RELEASE_INFO_BODY}"
            exit 1
          fi
          
          RELEASE_ID=$(echo "${RELEASE_INFO_BODY}" | jq -r '.id // empty')
          RELEASE_NAME_FROM_API=$(echo "${RELEASE_INFO_BODY}" | jq -r '.name // empty' 2>/dev/null || echo "")
          echo "âœ… æ‰¾åˆ° Gitee Release"
          echo "  Release ID: ${RELEASE_ID}"
          if [ -n "$RELEASE_NAME_FROM_API" ]; then
            echo "  Release åç§°: ${RELEASE_NAME_FROM_API}"
          fi
          
          # æ£€æŸ¥æ–‡ä»¶æ•°é‡
          FILE_COUNT=$(find release-assets -type f 2>/dev/null | wc -l)
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "âš ï¸ æœªæ‰¾åˆ°éœ€è¦ä¸Šä¼ çš„æ–‡ä»¶"
            exit 0
          fi
          
          echo "  æ‰¾åˆ° ${FILE_COUNT} ä¸ªæ–‡ä»¶éœ€è¦ä¸Šä¼ "
          
          UPLOAD_SUCCESS=0
          UPLOAD_FAILED=0
          
          # ä¸Šä¼ æ‰€æœ‰æ–‡ä»¶
          UPLOAD_API_BASE_URL="https://gitee.com/api/v5/repos/${GITEE_REPO_OWNER_ENCODED}/${GITEE_REPO_NAME_ENCODED}/releases/${RELEASE_ID}/attach_files"
          echo "  ä¸Šä¼  API URL: ${UPLOAD_API_BASE_URL}"
          
          for file in release-assets/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              filesize=$(du -h "$file" | cut -f1)
              filepath=$(realpath "$file" 2>/dev/null || echo "$file")
              echo "  ðŸ“¦ ä¸Šä¼  ${filename} (${filesize})..."
              echo "    æ–‡ä»¶è·¯å¾„: ${filepath}"
              
              UPLOAD_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
                -H "Authorization: token ${GITEE_TOKEN}" \
                -F "file=@${file}" \
                "${UPLOAD_API_BASE_URL}")
              
              HTTP_CODE=$(echo "$UPLOAD_RESPONSE" | tail -n1)
              RESPONSE_BODY=$(echo "$UPLOAD_RESPONSE" | sed '$d')
              
              echo "    HTTP çŠ¶æ€ç : ${HTTP_CODE}"
              
              if [ "$HTTP_CODE" -eq 201 ] || [ "$HTTP_CODE" -eq 200 ]; then
                echo "    âœ… ${filename} ä¸Šä¼ æˆåŠŸ"
                echo "    å“åº”: ${RESPONSE_BODY}"
                UPLOAD_SUCCESS=$((UPLOAD_SUCCESS + 1))
              elif echo "$RESPONSE_BODY" | grep -q "already exists\|å·²å­˜åœ¨"; then
                echo "    âš ï¸ ${filename} å·²å­˜åœ¨ï¼Œè·³è¿‡"
                echo "    å“åº”: ${RESPONSE_BODY}"
                UPLOAD_SUCCESS=$((UPLOAD_SUCCESS + 1))
              else
                ERROR_MSG=$(echo "$RESPONSE_BODY" | jq -r '.message // .error // "æœªçŸ¥é”™è¯¯"' 2>/dev/null || echo "HTTP ${HTTP_CODE}")
                echo "    âŒ ${filename} ä¸Šä¼ å¤±è´¥: ${ERROR_MSG}"
                echo "    å®Œæ•´å“åº”: ${RESPONSE_BODY}"
                UPLOAD_FAILED=$((UPLOAD_FAILED + 1))
              fi
            fi
          done
          
          echo ""
          echo "ðŸ“Š ä¸Šä¼ ç»Ÿè®¡:"
          echo "  âœ… æˆåŠŸ: ${UPLOAD_SUCCESS}"
          echo "  âŒ å¤±è´¥: ${UPLOAD_FAILED}"
          
          if [ "$UPLOAD_FAILED" -gt 0 ]; then
            echo "âš ï¸ éƒ¨åˆ†æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡ŒåŽç»­æ­¥éª¤"
          else
            echo "âœ… æ‰€æœ‰æž„å»ºäº§ç‰©ä¸Šä¼ å®Œæˆ"
          fi

      - name: Sync update config to Gitee
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_REPO_OWNER: ${{ secrets.GITEE_REPO_OWNER }}
          GITEE_REPO_NAME: ${{ secrets.GITEE_REPO_NAME }}
        run: |
          echo "ðŸ”„ åŒæ­¥æ›´æ–°é…ç½®åˆ° Gitee..."
          
          # æ¸…ç†å¹¶åŽ»é™¤æ¢è¡Œç¬¦ã€å›žè½¦ç¬¦å’Œå‰åŽç©ºæ ¼
          GITEE_REPO_OWNER=$(printf '%s' "${GITEE_REPO_OWNER}" | tr -d '\n\r\t' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          GITEE_REPO_NAME=$(printf '%s' "${GITEE_REPO_NAME}" | tr -d '\n\r\t' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          GITEE_REPO="${GITEE_REPO_OWNER}/${GITEE_REPO_NAME}"
          TAG_NAME="${{ steps.get_version.outputs.TAG_NAME }}"
          
          echo "  Owner: ${GITEE_REPO_OWNER}"
          echo "  Repo Name: ${GITEE_REPO_NAME}"
          echo "  ä»“åº“: ${GITEE_REPO}"
          
          # ç¡®ä¿åœ¨ main åˆ†æ”¯ä¸Š
          CURRENT_BRANCH=$(git rev-parse --abbrev-ref HEAD)
          echo "  å½“å‰åˆ†æ”¯: ${CURRENT_BRANCH}"
          
          git checkout main || git checkout -b main origin/main
          git pull origin main || true
          
          # è¯»å– GitHub çš„æ›´æ–°é…ç½®æ–‡ä»¶
          if [ -f "update_config_github.json" ]; then
            echo "âœ… æ‰¾åˆ° GitHub æ›´æ–°é…ç½®æ–‡ä»¶"
            echo "  æ–‡ä»¶è·¯å¾„: $(realpath update_config_github.json 2>/dev/null || echo 'update_config_github.json')"
            
            # æ˜¾ç¤ºåŽŸå§‹é…ç½®å†…å®¹
            echo "  åŽŸå§‹é…ç½®å†…å®¹:"
            cat update_config_github.json | jq '.' 2>/dev/null || cat update_config_github.json
            
            # è½¬æ¢ä¸º Gitee æ ¼å¼
            echo ""
            echo "  è½¬æ¢é…ç½®ä¸º Gitee æ ¼å¼..."
            echo "  Gitee ä»“åº“: ${GITEE_REPO}"
            echo "  Release æ ‡ç­¾: ${TAG_NAME}"
            
            # ä½¿ç”¨ jq ä¿®æ”¹ URL
            cat update_config_github.json | jq "
              .updateCheckUrl = \"https://gitee.com/${GITEE_REPO}/raw/main/update_config_gitee.json\" |
              .client.platforms.macos.downloadUrl = (.client.platforms.macos.downloadUrl | gsub(\"github.com.*releases\"; \"gitee.com/${GITEE_REPO}/releases\")) |
              .client.platforms.windows.downloadUrl = (.client.platforms.windows.downloadUrl | gsub(\"github.com.*releases\"; \"gitee.com/${GITEE_REPO}/releases\")) |
              .server.platforms.android.downloadUrl = (.server.platforms.android.downloadUrl | gsub(\"github.com.*releases\"; \"gitee.com/${GITEE_REPO}/releases\"))
            " > update_config_gitee.json
            
            echo "âœ… å·²ç”Ÿæˆ Gitee æ›´æ–°é…ç½®æ–‡ä»¶"
            echo "  æ–‡ä»¶è·¯å¾„: $(realpath update_config_gitee.json 2>/dev/null || echo 'update_config_gitee.json')"
            echo "  æ›´æ–°æ£€æŸ¥ URL: https://gitee.com/${GITEE_REPO}/raw/main/update_config_gitee.json"
            echo ""
            echo "  Gitee é…ç½®å†…å®¹:"
            cat update_config_gitee.json | jq '.' 2>/dev/null || cat update_config_gitee.json
            
            # æäº¤åˆ° Gitee ä»“åº“
            git config --global user.name "GitHub Actions"
            git config --global user.email "actions@github.com"
            
            # æ·»åŠ  Gitee remoteï¼ˆå¦‚æžœè¿˜æ²¡æœ‰ï¼‰
            GITEE_REMOTE_URL="https://gitee.com/${GITEE_REPO}.git"
            if ! git remote get-url gitee >/dev/null 2>&1; then
              echo ""
              echo "  æ·»åŠ  Gitee remote..."
              echo "  Remote URL: ${GITEE_REMOTE_URL}"
              git remote add gitee https://${GITEE_TOKEN}@gitee.com/${GITEE_REPO}.git
            else
              EXISTING_REMOTE=$(git remote get-url gitee)
              echo ""
              echo "  Gitee remote å·²å­˜åœ¨"
              echo "  Remote URL: ${EXISTING_REMOTE}"
            fi
            
            # æ˜¾ç¤ºæ‰€æœ‰ remotes
            echo ""
            echo "  æ‰€æœ‰ remotes:"
            git remote -v
            
            # åˆ‡æ¢åˆ° main åˆ†æ”¯å¹¶æŽ¨é€
            echo ""
            echo "  èŽ·å– Gitee main åˆ†æ”¯..."
            git fetch gitee main || true
            
            CURRENT_BRANCH_BEFORE=$(git rev-parse --abbrev-ref HEAD)
            echo "  èŽ·å–å‰åˆ†æ”¯: ${CURRENT_BRANCH_BEFORE}"
            
            git checkout -b main gitee/main 2>/dev/null || git checkout main
            
            CURRENT_BRANCH_AFTER=$(git rev-parse --abbrev-ref HEAD)
            echo "  èŽ·å–åŽåˆ†æ”¯: ${CURRENT_BRANCH_AFTER}"
            
            echo ""
            echo "  æ£€æŸ¥æ–‡ä»¶æ›´æ”¹..."
            git add update_config_gitee.json
            
            if git diff --staged --quiet; then
              echo "âš ï¸ æ²¡æœ‰æ›´æ”¹éœ€è¦æäº¤ï¼ˆé…ç½®æ–‡ä»¶å¯èƒ½å·²æ˜¯æœ€æ–°ï¼‰"
              echo "  å½“å‰æ–‡ä»¶å†…å®¹:"
              cat update_config_gitee.json | jq '.' 2>/dev/null || cat update_config_gitee.json
            else
              echo "  æ£€æµ‹åˆ°æ›´æ”¹ï¼Œå‡†å¤‡æäº¤..."
              echo "  æ›´æ”¹å†…å®¹:"
              git diff --staged update_config_gitee.json || echo "  æ— æ³•æ˜¾ç¤º diff"
              
              COMMIT_MSG="Sync update config from GitHub Release ${TAG_NAME}"
              echo ""
              echo "  æäº¤æ›´æ”¹..."
              echo "  æäº¤ä¿¡æ¯: ${COMMIT_MSG}"
              git commit -m "${COMMIT_MSG}"
              
              echo ""
              echo "  æŽ¨é€åˆ° Gitee..."
              echo "  ç›®æ ‡åˆ†æ”¯: main"
              echo "  ç›®æ ‡ä»“åº“: gitee"
              
              if git push gitee main; then
                echo "âœ… æ›´æ–°é…ç½®å·²æŽ¨é€åˆ° Gitee"
                echo "  æŽ¨é€æˆåŠŸï¼Œå¯ä»¥åœ¨ä»¥ä¸‹ URL æŸ¥çœ‹:"
                echo "  https://gitee.com/${GITEE_REPO}/blob/main/update_config_gitee.json"
              else
                PUSH_ERROR=$?
                echo "âš ï¸ æŽ¨é€å¤±è´¥ (é€€å‡ºç : ${PUSH_ERROR})"
                echo "  å¯èƒ½åŽŸå› ï¼š"
                echo "    1. æƒé™ä¸è¶³"
                echo "    2. åˆ†æ”¯å·²æ˜¯æœ€æ–°ç‰ˆæœ¬"
                echo "    3. ç½‘ç»œé—®é¢˜"
                exit 1
              fi
            fi
            
            echo ""
            echo "âœ… æ›´æ–°é…ç½®åŒæ­¥å®Œæˆ"
          else
            echo "âš ï¸ update_config_github.json æœªæ‰¾åˆ°ï¼Œè·³è¿‡é…ç½®åŒæ­¥"
            echo "  å½“å‰ç›®å½•: $(pwd)"
            echo "  æ–‡ä»¶åˆ—è¡¨:"
            ls -la *.json 2>/dev/null || echo "  æœªæ‰¾åˆ° JSON æ–‡ä»¶"
            exit 1
          fi

