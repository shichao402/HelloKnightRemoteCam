name: Sync Release to Gitee

# å½“ GitHub Release åˆ›å»ºåï¼Œè‡ªåŠ¨åŒæ­¥åˆ° Gitee
on:
  release:
    types: [published]  # å½“ Release å‘å¸ƒæ—¶è§¦å‘
  workflow_call:  # å…è®¸è¢«å…¶ä»–å·¥ä½œæµè°ƒç”¨
    inputs:
      release_tag:
        description: 'è¦åŒæ­¥çš„ Release æ ‡ç­¾ï¼ˆä¾‹å¦‚ï¼šv1.0.7ï¼‰'
        required: true
        type: string
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      release_tag:
        description: 'è¦åŒæ­¥çš„ Release æ ‡ç­¾ï¼ˆä¾‹å¦‚ï¼šv1.0.7ï¼‰'
        required: true
        type: string

jobs:
  sync-release:
    name: Sync Release to Gitee
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Check Gitee Secrets
        run: |
          echo "ğŸ” æ£€æŸ¥ Gitee Secrets é…ç½®..."
          
          # æ£€æŸ¥ GITEE_TOKENï¼ˆä¸æ˜¾ç¤ºæ˜æ–‡ï¼‰
          if [ -z "${{ secrets.GITEE_TOKEN }}" ]; then
            echo "âŒ GITEE_TOKEN æœªé…ç½®"
            exit 1
          else
            TOKEN_LEN=${#GITEE_TOKEN}
            TOKEN_PREFIX="${GITEE_TOKEN:0:4}"
            TOKEN_SUFFIX="${GITEE_TOKEN: -4}"
            echo "âœ… GITEE_TOKEN å·²é…ç½® (é•¿åº¦: ${TOKEN_LEN}, å‰ç¼€: ${TOKEN_PREFIX}..., åç¼€: ...${TOKEN_SUFFIX})"
          fi
          
          # æ£€æŸ¥ GITEE_REPO_OWNERï¼ˆæ˜¾ç¤ºæ˜æ–‡ï¼Œå› ä¸ºè¿™åªæ˜¯ç”¨æˆ·åï¼‰
          if [ -z "${{ secrets.GITEE_REPO_OWNER }}" ]; then
            echo "âŒ GITEE_REPO_OWNER æœªé…ç½®"
            exit 1
          else
            echo "âœ… GITEE_REPO_OWNER å·²é…ç½®: ${{ secrets.GITEE_REPO_OWNER }}"
          fi
          
          # æ£€æŸ¥ GITEE_REPO_NAMEï¼ˆæ˜¾ç¤ºæ˜æ–‡ï¼Œå› ä¸ºè¿™åªæ˜¯ä»“åº“åï¼‰
          if [ -z "${{ secrets.GITEE_REPO_NAME }}" ]; then
            echo "âŒ GITEE_REPO_NAME æœªé…ç½®"
            exit 1
          else
            echo "âœ… GITEE_REPO_NAME å·²é…ç½®: ${{ secrets.GITEE_REPO_NAME }}"
          fi
          
          GITEE_REPO="${{ secrets.GITEE_REPO_OWNER }}/${{ secrets.GITEE_REPO_NAME }}"
          echo "ğŸ“¦ Gitee ä»“åº“: ${GITEE_REPO}"
          echo "âœ… æ‰€æœ‰ Gitee Secrets é…ç½®æ£€æŸ¥é€šè¿‡"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # éœ€è¦å®Œæ•´å†å²è®°å½•ä»¥æ¨é€åˆ° Gitee
          ref: main  # åˆ‡æ¢åˆ° main åˆ†æ”¯ä»¥è·å–æœ€æ–°çš„ update_config_github.json

      - name: Extract version from release
        id: get_version
        run: |
          echo "ğŸ” æå– Release ç‰ˆæœ¬ä¿¡æ¯..."
          echo "  äº‹ä»¶ç±»å‹: ${{ github.event_name }}"
          echo "  GITHUB_REF: ${GITHUB_REF}"
          
          # å¦‚æœæ˜¯ workflow_callï¼ˆè¢«å…¶ä»–å·¥ä½œæµè°ƒç”¨ï¼‰ï¼Œä½¿ç”¨è¾“å…¥çš„ release_tag
          if [ "${{ github.event_name }}" == "workflow_call" ]; then
            TAG_NAME="${{ inputs.release_tag }}"
            echo "ğŸ“Œ å·¥ä½œæµè°ƒç”¨: ä½¿ç”¨æ ‡ç­¾ ${TAG_NAME}"
          # å¦‚æœæ˜¯æ‰‹åŠ¨è§¦å‘ï¼Œä½¿ç”¨è¾“å…¥çš„ release_tag
          elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TAG_NAME="${{ github.event.inputs.release_tag }}"
            echo "ğŸ“Œ æ‰‹åŠ¨è§¦å‘: ä½¿ç”¨æ ‡ç­¾ ${TAG_NAME}"
          else
            # ä» release äº‹ä»¶è·å– tag åç§°
            # release äº‹ä»¶çš„ GITHUB_REF æ ¼å¼å¯èƒ½æ˜¯ refs/tags/v1.0.0
            TAG_NAME=${GITHUB_REF#refs/tags/}
            echo "  [è°ƒè¯•] ä» GITHUB_REF æå–: ${TAG_NAME}"
            
            # å¦‚æœæ²¡æœ‰ä» GITHUB_REF è·å–åˆ°ï¼Œå°è¯•ä»ç¯å¢ƒå˜é‡è·å–
            if [ -z "$TAG_NAME" ] || [ "$TAG_NAME" == "$GITHUB_REF" ]; then
              # release äº‹ä»¶å¯èƒ½ä½¿ç”¨ä¸åŒçš„ ref
              TAG_NAME=${GITHUB_REF#refs/heads/}
              echo "  [è°ƒè¯•] ä» refs/heads/ æå–: ${TAG_NAME}"
            fi
            
            # å¦‚æœè¿˜æ˜¯è·å–ä¸åˆ°ï¼Œä» GitHub API è·å–
            if [ -z "$TAG_NAME" ] || [ "$TAG_NAME" == "$GITHUB_REF" ]; then
              echo "  [è°ƒè¯•] ä» GitHub API è·å–æœ€æ–° Release..."
              TAG_NAME=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                "https://api.github.com/repos/${{ github.repository }}/releases/latest" | \
                jq -r '.tag_name // empty')
              echo "  [è°ƒè¯•] API è¿”å›: ${TAG_NAME}"
            fi
          fi
          
          # ç¡®ä¿ TAG_NAME ä¸ä¸ºç©º
          if [ -z "$TAG_NAME" ]; then
            echo "âŒ æ— æ³•è·å– Release æ ‡ç­¾"
            exit 1
          fi
          
          VERSION=${TAG_NAME#v}  # å»æ‰ v å‰ç¼€
          echo "TAG_NAME=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "âœ… Release æ ‡ç­¾: ${TAG_NAME}"
          echo "âœ… ç‰ˆæœ¬å·: ${VERSION}"

      - name: Get Release info
        uses: actions/github-script@v7
        id: release_info
        with:
          script: |
            // ä» release äº‹ä»¶è·å– release ä¿¡æ¯
            let release;
            const tagName = '${{ steps.get_version.outputs.TAG_NAME }}';
            
            console.log(`ğŸ” è·å– Release ä¿¡æ¯: ${tagName}`);
            console.log(`  äº‹ä»¶ç±»å‹: ${context.eventName}`);
            
            if (context.payload.release && context.eventName === 'release') {
              // release äº‹ä»¶ç›´æ¥åŒ…å« release ä¿¡æ¯
              release = context.payload.release;
              console.log('âœ… ä»äº‹ä»¶è´Ÿè½½è·å– Release ä¿¡æ¯');
            } else {
              // æ‰‹åŠ¨è§¦å‘æˆ–å…¶ä»–æƒ…å†µï¼Œé€šè¿‡ API è·å–
              console.log('ğŸ“¡ é€šè¿‡ GitHub API è·å– Release ä¿¡æ¯...');
              try {
                const { data } = await github.rest.repos.getReleaseByTag({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  tag: tagName
                });
                release = data;
                console.log(`âœ… æˆåŠŸè·å– Release ä¿¡æ¯ (ID: ${release.id})`);
              } catch (error) {
                console.error(`âŒ è·å– Release å¤±è´¥: ${error.message}`);
                core.setFailed(`Failed to get release for tag ${tagName}: ${error.message}`);
                throw error;
              }
            }
            
            const assets = release.assets || [];
            console.log(`ğŸ“¦ æ‰¾åˆ° ${assets.length} ä¸ªæ„å»ºäº§ç‰©:`);
            assets.forEach((asset, index) => {
              console.log(`  ${index + 1}. ${asset.name} (${(asset.size / 1024 / 1024).toFixed(2)} MB)`);
            });
            
            // éªŒè¯ Release çŠ¶æ€
            if (release.draft) {
              console.log('âš ï¸ è­¦å‘Š: Release æ˜¯è‰ç¨¿çŠ¶æ€');
            }
            if (release.prerelease) {
              console.log('âš ï¸ è­¦å‘Š: Release æ˜¯é¢„å‘å¸ƒç‰ˆæœ¬');
            }
            
            // ä¿å­˜ release ä¿¡æ¯
            core.setOutput('release_body', release.body || '');
            core.setOutput('release_name', release.name || release.tag_name);
            
            // è¿”å› assets ä¿¡æ¯ä¾›åç»­æ­¥éª¤ä½¿ç”¨
            return JSON.stringify(assets.map(a => ({
              name: a.name,
              url: a.browser_download_url
            })));

      - name: Download assets files
        env:
          GH_TOKEN: ${{ github.token }}  # GitHub CLI éœ€è¦è¿™ä¸ª token
        run: |
          mkdir -p release-assets
          
          # ä½¿ç”¨ GitHub CLI ä¸‹è½½æ–‡ä»¶ï¼ˆå¦‚æœå¯ç”¨ï¼‰
          if command -v gh &> /dev/null; then
            echo "Using GitHub CLI to download assets..."
            gh release download "${{ steps.get_version.outputs.TAG_NAME }}" -D release-assets
          else
            # æ‰‹åŠ¨ä¸‹è½½ï¼ˆä½¿ç”¨ curlï¼‰
            echo "Downloading assets manually..."
            ASSETS='${{ steps.release_info.outputs.result }}'
            echo "$ASSETS" | jq -r '.[] | "\(.url)|\(.name)"' | while IFS='|' read -r url name; do
              echo "Downloading $name..."
              curl -L -H "Authorization: token ${{ github.token }}" -o "release-assets/$name" "$url"
            done
          fi
          
          echo "Downloaded files:"
          ls -lh release-assets/

      - name: Create Gitee Release
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_REPO_OWNER: ${{ secrets.GITEE_REPO_OWNER }}
          GITEE_REPO_NAME: ${{ secrets.GITEE_REPO_NAME }}
        run: |
          TAG_NAME="${{ steps.get_version.outputs.TAG_NAME }}"
          RELEASE_NAME="${{ steps.release_info.outputs.release_name }}"
          RELEASE_BODY="${{ steps.release_info.outputs.release_body }}"
          
          GITEE_REPO="${GITEE_REPO_OWNER}/${GITEE_REPO_NAME}"
          
          echo "ğŸš€ åˆ›å»º Gitee Release..."
          echo "  æ ‡ç­¾: ${TAG_NAME}"
          echo "  åç§°: ${RELEASE_NAME}"
          echo "  ä»“åº“: ${GITEE_REPO}"
          
          # æ£€æŸ¥ Release æ˜¯å¦å·²å­˜åœ¨
          echo "ğŸ” æ£€æŸ¥ Gitee Release æ˜¯å¦å·²å­˜åœ¨..."
          EXISTING_RELEASE=$(curl -s -X GET \
            -H "Authorization: token ${GITEE_TOKEN}" \
            "https://gitee.com/api/v5/repos/${GITEE_REPO}/releases/tags/${TAG_NAME}" || echo "")
          
          if echo "${EXISTING_RELEASE}" | grep -q '"id"'; then
            RELEASE_ID=$(echo "${EXISTING_RELEASE}" | jq -r '.id // empty')
            echo "âš ï¸ Gitee Release å·²å­˜åœ¨ (ID: ${RELEASE_ID})ï¼Œå°†æ›´æ–°..."
            
            # æ›´æ–°ç°æœ‰ Release
            RESPONSE=$(curl -s -X PATCH \
              -H "Content-Type: application/json" \
              -H "Authorization: token ${GITEE_TOKEN}" \
              -d "{
                \"name\": \"${RELEASE_NAME}\",
                \"body\": $(echo "${RELEASE_BODY}" | jq -Rs .),
                \"prerelease\": false
              }" \
              "https://gitee.com/api/v5/repos/${GITEE_REPO}/releases/${RELEASE_ID}")
          else
            # åˆ›å»ºæ–° Release
            RESPONSE=$(curl -s -X POST \
              -H "Content-Type: application/json" \
              -H "Authorization: token ${GITEE_TOKEN}" \
              -d "{
                \"tag_name\": \"${TAG_NAME}\",
                \"name\": \"${RELEASE_NAME}\",
                \"body\": $(echo "${RELEASE_BODY}" | jq -Rs .),
                \"prerelease\": false
              }" \
              "https://gitee.com/api/v5/repos/${GITEE_REPO}/releases")
          fi
          
          # æ£€æŸ¥å“åº”ï¼ˆä¸æ˜¾ç¤ºå®Œæ•´å“åº”ï¼Œåªæ˜¾ç¤ºå…³é”®ä¿¡æ¯ï¼‰
          if echo "${RESPONSE}" | grep -q '"id"'; then
            RELEASE_ID=$(echo "${RESPONSE}" | jq -r '.id // empty')
            echo "âœ… Gitee Release åˆ›å»º/æ›´æ–°æˆåŠŸ (ID: ${RELEASE_ID})"
          else
            ERROR_MSG=$(echo "${RESPONSE}" | jq -r '.message // .error // "æœªçŸ¥é”™è¯¯"' 2>/dev/null || echo "è§£æé”™è¯¯å“åº”å¤±è´¥")
            echo "âŒ Gitee Release åˆ›å»º/æ›´æ–°å¤±è´¥: ${ERROR_MSG}"
            echo "  [è°ƒè¯•] å“åº”çŠ¶æ€ç : $(echo "${RESPONSE}" | jq -r '.status // "N/A"')"
            exit 1
          fi

      - name: Upload assets to Gitee Release
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_REPO_OWNER: ${{ secrets.GITEE_REPO_OWNER }}
          GITEE_REPO_NAME: ${{ secrets.GITEE_REPO_NAME }}
        run: |
          TAG_NAME="${{ steps.get_version.outputs.TAG_NAME }}"
          GITEE_REPO="${GITEE_REPO_OWNER}/${GITEE_REPO_NAME}"
          
          echo "ğŸ“¤ ä¸Šä¼ æ„å»ºäº§ç‰©åˆ° Gitee Release..."
          echo "  æ ‡ç­¾: ${TAG_NAME}"
          echo "  ä»“åº“: ${GITEE_REPO}"
          
          # æ£€æŸ¥æ–‡ä»¶æ•°é‡
          FILE_COUNT=$(find release-assets -type f | wc -l)
          echo "  æ‰¾åˆ° ${FILE_COUNT} ä¸ªæ–‡ä»¶éœ€è¦ä¸Šä¼ "
          
          UPLOAD_SUCCESS=0
          UPLOAD_FAILED=0
          
          # ä¸Šä¼ æ‰€æœ‰æ–‡ä»¶
          for file in release-assets/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              filesize=$(du -h "$file" | cut -f1)
              echo "  ğŸ“¦ ä¸Šä¼  ${filename} (${filesize})..."
              
              UPLOAD_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
                -H "Authorization: token ${GITEE_TOKEN}" \
                -F "file=@${file}" \
                "https://gitee.com/api/v5/repos/${GITEE_REPO}/releases/${TAG_NAME}/attach_files")
              
              HTTP_CODE=$(echo "$UPLOAD_RESPONSE" | tail -n1)
              RESPONSE_BODY=$(echo "$UPLOAD_RESPONSE" | sed '$d')
              
              if [ "$HTTP_CODE" -eq 201 ] || [ "$HTTP_CODE" -eq 200 ]; then
                echo "    âœ… ${filename} ä¸Šä¼ æˆåŠŸ"
                UPLOAD_SUCCESS=$((UPLOAD_SUCCESS + 1))
              elif echo "$RESPONSE_BODY" | grep -q "already exists\|å·²å­˜åœ¨"; then
                echo "    âš ï¸ ${filename} å·²å­˜åœ¨ï¼Œè·³è¿‡"
                UPLOAD_SUCCESS=$((UPLOAD_SUCCESS + 1))
              else
                ERROR_MSG=$(echo "$RESPONSE_BODY" | jq -r '.message // .error // "æœªçŸ¥é”™è¯¯"' 2>/dev/null || echo "HTTP ${HTTP_CODE}")
                echo "    âŒ ${filename} ä¸Šä¼ å¤±è´¥: ${ERROR_MSG}"
                UPLOAD_FAILED=$((UPLOAD_FAILED + 1))
              fi
            fi
          done
          
          echo ""
          echo "ğŸ“Š ä¸Šä¼ ç»Ÿè®¡:"
          echo "  âœ… æˆåŠŸ: ${UPLOAD_SUCCESS}"
          echo "  âŒ å¤±è´¥: ${UPLOAD_FAILED}"
          
          if [ "$UPLOAD_FAILED" -gt 0 ]; then
            echo "âš ï¸ éƒ¨åˆ†æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œåç»­æ­¥éª¤"
          else
            echo "âœ… æ‰€æœ‰æ„å»ºäº§ç‰©ä¸Šä¼ å®Œæˆ"
          fi

      - name: Sync update config to Gitee
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_REPO_OWNER: ${{ secrets.GITEE_REPO_OWNER }}
          GITEE_REPO_NAME: ${{ secrets.GITEE_REPO_NAME }}
        run: |
          echo "ğŸ”„ åŒæ­¥æ›´æ–°é…ç½®åˆ° Gitee..."
          
          # ç¡®ä¿åœ¨ main åˆ†æ”¯ä¸Š
          git checkout main || git checkout -b main origin/main
          git pull origin main || true
          
          # è¯»å– GitHub çš„æ›´æ–°é…ç½®æ–‡ä»¶
          if [ -f "update_config_github.json" ]; then
            echo "âœ… æ‰¾åˆ° GitHub æ›´æ–°é…ç½®æ–‡ä»¶"
            
            # è½¬æ¢ä¸º Gitee æ ¼å¼
            GITEE_REPO="${GITEE_REPO_OWNER}/${GITEE_REPO_NAME}"
            TAG_NAME="${{ steps.get_version.outputs.TAG_NAME }}"
            
            echo "  [è°ƒè¯•] Gitee ä»“åº“: ${GITEE_REPO}"
            echo "  [è°ƒè¯•] Release æ ‡ç­¾: ${TAG_NAME}"
            
            # ä½¿ç”¨ jq ä¿®æ”¹ URL
            cat update_config_github.json | jq "
              .updateCheckUrl = \"https://gitee.com/${GITEE_REPO}/raw/main/update_config_gitee.json\" |
              .client.platforms.macos.downloadUrl = (.client.platforms.macos.downloadUrl | gsub(\"github.com.*releases\"; \"gitee.com/${GITEE_REPO}/releases\")) |
              .client.platforms.windows.downloadUrl = (.client.platforms.windows.downloadUrl | gsub(\"github.com.*releases\"; \"gitee.com/${GITEE_REPO}/releases\")) |
              .server.platforms.android.downloadUrl = (.server.platforms.android.downloadUrl | gsub(\"github.com.*releases\"; \"gitee.com/${GITEE_REPO}/releases\"))
            " > update_config_gitee.json
            
            echo "âœ… å·²ç”Ÿæˆ Gitee æ›´æ–°é…ç½®æ–‡ä»¶"
            echo "  [è°ƒè¯•] æ›´æ–°æ£€æŸ¥ URL: https://gitee.com/${GITEE_REPO}/raw/main/update_config_gitee.json"
            
            # æäº¤åˆ° Gitee ä»“åº“
            git config --global user.name "GitHub Actions"
            git config --global user.email "actions@github.com"
            
            # æ·»åŠ  Gitee remoteï¼ˆå¦‚æœè¿˜æ²¡æœ‰ï¼‰
            if ! git remote get-url gitee >/dev/null 2>&1; then
              echo "  [è°ƒè¯•] æ·»åŠ  Gitee remote..."
              git remote add gitee https://${GITEE_TOKEN}@gitee.com/${GITEE_REPO}.git
            else
              echo "  [è°ƒè¯•] Gitee remote å·²å­˜åœ¨"
            fi
            
            # åˆ‡æ¢åˆ° main åˆ†æ”¯å¹¶æ¨é€
            echo "  [è°ƒè¯•] è·å– Gitee main åˆ†æ”¯..."
            git fetch gitee main || true
            git checkout -b main gitee/main 2>/dev/null || git checkout main
            
            git add update_config_gitee.json
            if git diff --staged --quiet; then
              echo "âš ï¸ æ²¡æœ‰æ›´æ”¹éœ€è¦æäº¤ï¼ˆé…ç½®æ–‡ä»¶å¯èƒ½å·²æ˜¯æœ€æ–°ï¼‰"
            else
              echo "  [è°ƒè¯•] æäº¤æ›´æ”¹..."
              git commit -m "Sync update config from GitHub Release ${TAG_NAME}"
              
              echo "  [è°ƒè¯•] æ¨é€åˆ° Gitee..."
              if git push gitee main; then
                echo "âœ… æ›´æ–°é…ç½®å·²æ¨é€åˆ° Gitee"
              else
                echo "âš ï¸ æ¨é€å¤±è´¥ï¼Œå¯èƒ½å·²æ˜¯æœ€æ–°ç‰ˆæœ¬æˆ–æƒé™ä¸è¶³"
                exit 1
              fi
            fi
            
            echo "âœ… æ›´æ–°é…ç½®åŒæ­¥å®Œæˆ"
          else
            echo "âš ï¸ update_config_github.json æœªæ‰¾åˆ°ï¼Œè·³è¿‡é…ç½®åŒæ­¥"
            exit 1
          fi

