name: Sync Release to Gitee

# å½“ GitHub Release åˆ›å»ºåŽï¼Œè‡ªåŠ¨åŒæ­¥åˆ° Gitee
on:
  release:
    types: [published]  # å½“ Release å‘å¸ƒæ—¶è§¦å‘
  workflow_call:  # å…è®¸è¢«å…¶ä»–å·¥ä½œæµè°ƒç”¨
    inputs:
      release_tag:
        description: 'è¦åŒæ­¥çš„ Release æ ‡ç­¾ï¼ˆä¾‹å¦‚ï¼šv1.0.7ï¼‰ï¼Œç•™ç©ºåˆ™ä½¿ç”¨æœ€æ–° Release'
        required: false
        type: string
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      release_tag:
        description: 'è¦åŒæ­¥çš„ Release æ ‡ç­¾ï¼ˆä¾‹å¦‚ï¼šv1.0.7ï¼‰ï¼Œç•™ç©ºåˆ™ä½¿ç”¨æœ€æ–° Release'
        required: false
        type: string

jobs:
  sync-release:
    name: Sync Release to Gitee
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Check Gitee Secrets
        env:
          GITEE_REPO_OWNER: ${{ secrets.GITEE_REPO_OWNER }}
          GITEE_REPO_NAME: ${{ secrets.GITEE_REPO_NAME }}
        run: |
          echo "ðŸ” æ£€æŸ¥ Gitee Secrets é…ç½®..."
          
          # æ£€æŸ¥ GITEE_TOKENï¼ˆä¸æ˜¾ç¤ºæ˜Žæ–‡ï¼‰
          if [ -z "${{ secrets.GITEE_TOKEN }}" ]; then
            echo "âŒ GITEE_TOKEN æœªé…ç½®"
            exit 1
          else
            TOKEN_LEN=${#GITEE_TOKEN}
            TOKEN_PREFIX="${GITEE_TOKEN:0:4}"
            TOKEN_SUFFIX="${GITEE_TOKEN: -4}"
            echo "âœ… GITEE_TOKEN å·²é…ç½® (é•¿åº¦: ${TOKEN_LEN}, å‰ç¼€: ${TOKEN_PREFIX}..., åŽç¼€: ...${TOKEN_SUFFIX})"
          fi
          
          # æ¸…ç†å¹¶æ˜¾ç¤º GITEE_REPO_OWNERï¼ˆæ˜¾ç¤ºå®Œæ•´å€¼ï¼Œå› ä¸ºè¿™ä¸æ˜¯æ•æ„Ÿä¿¡æ¯ï¼‰
          GITEE_REPO_OWNER_CLEAN=$(printf '%s' "${GITEE_REPO_OWNER}" | tr -d '\n\r\t' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          if [ -z "${GITEE_REPO_OWNER_CLEAN}" ]; then
            echo "âŒ GITEE_REPO_OWNER æœªé…ç½®"
            exit 1
          else
            echo "âœ… GITEE_REPO_OWNER å·²é…ç½®: ${GITEE_REPO_OWNER_CLEAN}"
          fi
          
          # æ¸…ç†å¹¶æ˜¾ç¤º GITEE_REPO_NAMEï¼ˆæ˜¾ç¤ºå®Œæ•´å€¼ï¼Œå› ä¸ºè¿™ä¸æ˜¯æ•æ„Ÿä¿¡æ¯ï¼‰
          GITEE_REPO_NAME_CLEAN=$(printf '%s' "${GITEE_REPO_NAME}" | tr -d '\n\r\t' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          if [ -z "${GITEE_REPO_NAME_CLEAN}" ]; then
            echo "âŒ GITEE_REPO_NAME æœªé…ç½®"
            exit 1
          else
            echo "âœ… GITEE_REPO_NAME å·²é…ç½®: ${GITEE_REPO_NAME_CLEAN}"
          fi
          
          GITEE_REPO="${GITEE_REPO_OWNER_CLEAN}/${GITEE_REPO_NAME_CLEAN}"
          echo "ðŸ“¦ Gitee ä»“åº“: ${GITEE_REPO}"
          echo "âœ… æ‰€æœ‰ Gitee Secrets é…ç½®æ£€æŸ¥é€šè¿‡"

      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # éœ€è¦å®Œæ•´åŽ†å²è®°å½•ä»¥æŽ¨é€åˆ° Gitee
          ref: main  # åˆ‡æ¢åˆ° main åˆ†æ”¯ä»¥èŽ·å–æœ€æ–°çš„ update_config_github.json

      - name: Extract version from release
        id: get_version
        run: |
          echo "ðŸ” æå– Release ç‰ˆæœ¬ä¿¡æ¯..."
          echo "  äº‹ä»¶ç±»åž‹: ${{ github.event_name }}"
          echo "  GITHUB_REF: ${GITHUB_REF}"
          
          # å¦‚æžœæ˜¯ workflow_callï¼ˆè¢«å…¶ä»–å·¥ä½œæµè°ƒç”¨ï¼‰ï¼Œä½¿ç”¨è¾“å…¥çš„ release_tag
          if [ "${{ github.event_name }}" == "workflow_call" ]; then
            TAG_NAME="${{ inputs.release_tag }}"
            echo "ðŸ“Œ å·¥ä½œæµè°ƒç”¨: ä½¿ç”¨æ ‡ç­¾ ${TAG_NAME}"
            echo "  [è°ƒè¯•] inputs.release_tag å€¼: '${{ inputs.release_tag }}'"
            echo "  [è°ƒè¯•] TAG_NAME å€¼: '${TAG_NAME}'"
          # å¦‚æžœæ˜¯æ‰‹åŠ¨è§¦å‘ï¼Œä½¿ç”¨è¾“å…¥çš„ release_tag
          elif [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TAG_NAME="${{ github.event.inputs.release_tag }}"
            echo "ðŸ“Œ æ‰‹åŠ¨è§¦å‘: ä½¿ç”¨æ ‡ç­¾ ${TAG_NAME:-ï¼ˆæœªæä¾›ï¼Œå°†ä½¿ç”¨æœ€æ–°ï¼‰}"
          else
            # ä»Ž release äº‹ä»¶èŽ·å– tag åç§°
            # release äº‹ä»¶çš„ GITHUB_REF æ ¼å¼å¯èƒ½æ˜¯ refs/tags/v1.0.0
            TAG_NAME=${GITHUB_REF#refs/tags/}
            echo "  [è°ƒè¯•] ä»Ž GITHUB_REF æå–: ${TAG_NAME}"
            
            # å¦‚æžœæ²¡æœ‰ä»Ž GITHUB_REF èŽ·å–åˆ°ï¼Œå°è¯•ä»ŽçŽ¯å¢ƒå˜é‡èŽ·å–
            if [ -z "$TAG_NAME" ] || [ "$TAG_NAME" == "$GITHUB_REF" ]; then
              # release äº‹ä»¶å¯èƒ½ä½¿ç”¨ä¸åŒçš„ ref
              TAG_NAME=${GITHUB_REF#refs/heads/}
              echo "  [è°ƒè¯•] ä»Ž refs/heads/ æå–: ${TAG_NAME}"
            fi
            
            # å¦‚æžœè¿˜æ˜¯èŽ·å–ä¸åˆ°ï¼Œä»Ž GitHub API èŽ·å–
            if [ -z "$TAG_NAME" ] || [ "$TAG_NAME" == "$GITHUB_REF" ]; then
              echo "  [è°ƒè¯•] ä»Ž GitHub API èŽ·å–æœ€æ–° Release..."
              TAG_NAME=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
                "https://api.github.com/repos/${{ github.repository }}/releases/latest" | \
                jq -r '.tag_name // empty')
              echo "  [è°ƒè¯•] API è¿”å›ž: ${TAG_NAME}"
            fi
          fi
          
          # å¦‚æžœ TAG_NAME ä¸ºç©ºï¼Œä»Ž GitHub API èŽ·å–æœ€æ–° Release
          if [ -z "$TAG_NAME" ] || [ "$TAG_NAME" == "" ]; then
            echo "ðŸ“¡ æœªæä¾› Release æ ‡ç­¾ï¼Œä»Ž GitHub API èŽ·å–æœ€æ–° Release..."
            TAG_NAME=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              -H "Accept: application/vnd.github+json" \
              "https://api.github.com/repos/${{ github.repository }}/releases/latest" | \
              jq -r '.tag_name // empty')
            
            if [ -n "$TAG_NAME" ] && [ "$TAG_NAME" != "null" ] && [ "$TAG_NAME" != "" ]; then
              echo "âœ… èŽ·å–åˆ°æœ€æ–° Release æ ‡ç­¾: ${TAG_NAME}"
            else
              echo "âŒ æ— æ³•ä»Ž GitHub API èŽ·å–æœ€æ–° Release æ ‡ç­¾"
              echo "  è¯·æ‰‹åŠ¨æŒ‡å®š release_tag å‚æ•°ï¼Œæˆ–ç¡®ä¿ä»“åº“ä¸­è‡³å°‘æœ‰ä¸€ä¸ªå·²å‘å¸ƒçš„ Release"
              exit 1
            fi
          fi
          
          # ç¡®ä¿ TAG_NAME ä¸ä¸ºç©º
          if [ -z "$TAG_NAME" ] || [ "$TAG_NAME" == "" ] || [ "$TAG_NAME" == "null" ]; then
            echo "âŒ æ— æ³•èŽ·å– Release æ ‡ç­¾"
            echo "  è¯·æ‰‹åŠ¨æŒ‡å®š release_tag å‚æ•°ï¼Œæˆ–ç¡®ä¿ä»“åº“ä¸­è‡³å°‘æœ‰ä¸€ä¸ªå·²å‘å¸ƒçš„ Release"
            exit 1
          fi
          
          VERSION=${TAG_NAME#v}  # åŽ»æŽ‰ v å‰ç¼€
          echo "TAG_NAME=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "âœ… Release æ ‡ç­¾: ${TAG_NAME}"
          echo "âœ… ç‰ˆæœ¬å·: ${VERSION}"

      - name: Get Release info
        uses: actions/github-script@v7
        id: release_info
        with:
          script: |
            // ä»Ž release äº‹ä»¶èŽ·å– release ä¿¡æ¯
            let release;
            const tagName = '${{ steps.get_version.outputs.TAG_NAME }}';
            const repoOwner = context.repo.owner;
            const repoName = context.repo.repo;
            
            console.log(`ðŸ” èŽ·å– Release ä¿¡æ¯:`);
            console.log(`  æ ‡ç­¾: ${tagName}`);
            console.log(`  ä»“åº“: ${repoOwner}/${repoName}`);
            console.log(`  äº‹ä»¶ç±»åž‹: ${context.eventName}`);
            
            if (context.payload.release && context.eventName === 'release') {
              // release äº‹ä»¶ç›´æŽ¥åŒ…å« release ä¿¡æ¯
              release = context.payload.release;
              console.log('âœ… ä»Žäº‹ä»¶è´Ÿè½½èŽ·å– Release ä¿¡æ¯');
            } else {
              // æ‰‹åŠ¨è§¦å‘æˆ–å…¶ä»–æƒ…å†µï¼Œé€šè¿‡ API èŽ·å–
              const apiUrl = `https://api.github.com/repos/${repoOwner}/${repoName}/releases/tags/${tagName}`;
              console.log(`ðŸ“¡ é€šè¿‡ GitHub API èŽ·å– Release ä¿¡æ¯...`);
              console.log(`  API URL: ${apiUrl}`);
              
              try {
                const { data } = await github.rest.repos.getReleaseByTag({
                  owner: repoOwner,
                  repo: repoName,
                  tag: tagName
                });
                release = data;
                console.log(`âœ… æˆåŠŸèŽ·å– Release ä¿¡æ¯`);
                console.log(`  Release ID: ${release.id}`);
                console.log(`  Release URL: ${release.html_url}`);
              } catch (error) {
                console.error(`âŒ èŽ·å– Release å¤±è´¥:`);
                console.error(`  é”™è¯¯ä¿¡æ¯: ${error.message}`);
                console.error(`  HTTP çŠ¶æ€ç : ${error.status || 'N/A'}`);
                core.setFailed(`Failed to get release for tag ${tagName}: ${error.message}`);
                throw error;
              }
            }
            
            // æ˜¾ç¤º Release è¯¦ç»†ä¿¡æ¯
            console.log(`\nðŸ“‹ Release è¯¦ç»†ä¿¡æ¯:`);
            console.log(`  ID: ${release.id}`);
            console.log(`  åç§°: ${release.name || release.tag_name}`);
            console.log(`  æ ‡ç­¾: ${release.tag_name}`);
            console.log(`  åˆ›å»ºæ—¶é—´: ${release.created_at}`);
            console.log(`  å‘å¸ƒæ—¶é—´: ${release.published_at || 'æœªå‘å¸ƒ'}`);
            console.log(`  ä½œè€…: ${release.author?.login || 'N/A'}`);
            console.log(`  URL: ${release.html_url}`);
            console.log(`  è‰ç¨¿: ${release.draft ? 'æ˜¯' : 'å¦'}`);
            console.log(`  é¢„å‘å¸ƒ: ${release.prerelease ? 'æ˜¯' : 'å¦'}`);
            
            const assets = release.assets || [];
            console.log(`\nðŸ“¦ æ‰¾åˆ° ${assets.length} ä¸ªæž„å»ºäº§ç‰©:`);
            assets.forEach((asset, index) => {
              const sizeMB = (asset.size / 1024 / 1024).toFixed(2);
              const downloadCount = asset.download_count || 0;
              console.log(`  ${index + 1}. ${asset.name}`);
              console.log(`     å¤§å°: ${sizeMB} MB`);
              console.log(`     ä¸‹è½½æ¬¡æ•°: ${downloadCount}`);
              console.log(`     ä¸‹è½½ URL: ${asset.browser_download_url}`);
            });
            
            // éªŒè¯ Release çŠ¶æ€
            if (release.draft) {
              console.log('\nâš ï¸ è­¦å‘Š: Release æ˜¯è‰ç¨¿çŠ¶æ€');
            }
            if (release.prerelease) {
              console.log('\nâš ï¸ è­¦å‘Š: Release æ˜¯é¢„å‘å¸ƒç‰ˆæœ¬');
            }
            
            // æ˜¾ç¤º Release æ­£æ–‡ï¼ˆå‰500å­—ç¬¦ï¼‰
            if (release.body) {
              const bodyPreview = release.body.length > 500 
                ? release.body.substring(0, 500) + '...' 
                : release.body;
              console.log(`\nðŸ“ Release æ­£æ–‡é¢„è§ˆ:`);
              console.log(bodyPreview);
            }
            
            // ä¿å­˜ release ä¿¡æ¯
            core.setOutput('release_body', release.body || '');
            core.setOutput('release_name', release.name || release.tag_name);
            
            // è¿”å›ž assets ä¿¡æ¯ä¾›åŽç»­æ­¥éª¤ä½¿ç”¨
            return JSON.stringify(assets.map(a => ({
              name: a.name,
              url: a.browser_download_url
            })));

      - name: Download assets files
        env:
          GH_TOKEN: ${{ github.token }}  # GitHub CLI éœ€è¦è¿™ä¸ª token
        run: |
          TAG_NAME="${{ steps.get_version.outputs.TAG_NAME }}"
          echo "ðŸ“¥ ä¸‹è½½æž„å»ºäº§ç‰©æ–‡ä»¶..."
          echo "  Release æ ‡ç­¾: ${TAG_NAME}"
          
          mkdir -p release-assets
          echo "  ç›®æ ‡ç›®å½•: $(realpath release-assets)"
          
          # ä½¿ç”¨ GitHub CLI ä¸‹è½½æ–‡ä»¶ï¼ˆå¦‚æžœå¯ç”¨ï¼‰
          if command -v gh &> /dev/null; then
            echo "  ä½¿ç”¨ GitHub CLI ä¸‹è½½æ–‡ä»¶..."
            echo "  å‘½ä»¤: gh release download \"${TAG_NAME}\" -D release-assets"
            
            DOWNLOAD_OUTPUT=$(gh release download "${TAG_NAME}" -D release-assets 2>&1)
            DOWNLOAD_EXIT_CODE=$?
            
            if [ $DOWNLOAD_EXIT_CODE -eq 0 ]; then
              echo "âœ… GitHub CLI ä¸‹è½½å®Œæˆ"
            else
              echo "âš ï¸ GitHub CLI ä¸‹è½½å¯èƒ½å¤±è´¥ (é€€å‡ºç : ${DOWNLOAD_EXIT_CODE})"
              echo "  è¾“å‡º: ${DOWNLOAD_OUTPUT}"
            fi
          else
            # æ‰‹åŠ¨ä¸‹è½½ï¼ˆä½¿ç”¨ curlï¼‰
            echo "  ä½¿ç”¨ curl æ‰‹åŠ¨ä¸‹è½½æ–‡ä»¶..."
            ASSETS='${{ steps.release_info.outputs.result }}'
            
            ASSET_COUNT=$(echo "$ASSETS" | jq 'length' 2>/dev/null || echo "0")
            echo "  éœ€è¦ä¸‹è½½ ${ASSET_COUNT} ä¸ªæ–‡ä»¶"
            
            DOWNLOAD_SUCCESS=0
            DOWNLOAD_FAILED=0
            
            echo "$ASSETS" | jq -r '.[] | "\(.url)|\(.name)"' | while IFS='|' read -r url name; do
              if [ -n "$url" ] && [ -n "$name" ]; then
                echo "  ðŸ“¦ ä¸‹è½½ ${name}..."
                echo "    ä¸‹è½½ URL: ${url}"
                
                DOWNLOAD_RESPONSE=$(curl -s -w "\n%{http_code}" -L \
                  -H "Authorization: token ${{ github.token }}" \
                  -o "release-assets/${name}" \
                  "${url}")
                
                HTTP_CODE=$(echo "$DOWNLOAD_RESPONSE" | tail -n1)
                
                if [ "$HTTP_CODE" = "200" ]; then
                  FILE_SIZE=$(du -h "release-assets/${name}" | cut -f1)
                  echo "    âœ… ${name} ä¸‹è½½æˆåŠŸ (${FILE_SIZE})"
                else
                  echo "    âŒ ${name} ä¸‹è½½å¤±è´¥ (HTTP ${HTTP_CODE})"
                fi
              fi
            done
          fi
          
          echo ""
          echo "ðŸ“‹ å·²ä¸‹è½½çš„æ–‡ä»¶åˆ—è¡¨:"
          ls -lh release-assets/ || echo "  ç›®å½•ä¸ºç©ºæˆ–ä¸å­˜åœ¨"
          
          FILE_COUNT=$(find release-assets -type f 2>/dev/null | wc -l)
          TOTAL_SIZE=$(du -sh release-assets 2>/dev/null | cut -f1 || echo "0")
          echo ""
          echo "  æ–‡ä»¶æ•°é‡: ${FILE_COUNT}"
          echo "  æ€»å¤§å°: ${TOTAL_SIZE}"

      - name: Create Gitee Release
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_REPO_OWNER: ${{ secrets.GITEE_REPO_OWNER }}
          GITEE_REPO_NAME: ${{ secrets.GITEE_REPO_NAME }}
        run: |
          TAG_NAME_RAW="${{ steps.get_version.outputs.TAG_NAME }}"
          RELEASE_NAME="${{ steps.release_info.outputs.release_name }}"
          RELEASE_BODY="${{ steps.release_info.outputs.release_body }}"
          
          # æ¸…ç† TAG_NAMEï¼šåŽ»é™¤æ¢è¡Œç¬¦ã€å›žè½¦ç¬¦å’Œå‰åŽç©ºæ ¼
          TAG_NAME=$(printf '%s' "${TAG_NAME_RAW}" | tr -d '\n\r\t' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          
          # æ¸…ç†å¹¶åŽ»é™¤æ¢è¡Œç¬¦ã€å›žè½¦ç¬¦å’Œå‰åŽç©ºæ ¼
          GITEE_REPO_OWNER=$(printf '%s' "${GITEE_REPO_OWNER}" | tr -d '\n\r\t' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          GITEE_REPO_NAME=$(printf '%s' "${GITEE_REPO_NAME}" | tr -d '\n\r\t' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          
          # URL ç¼–ç 
          GITEE_REPO_OWNER_ENCODED=$(printf '%s' "${GITEE_REPO_OWNER}" | jq -sRr @uri)
          GITEE_REPO_NAME_ENCODED=$(printf '%s' "${GITEE_REPO_NAME}" | jq -sRr @uri)
          TAG_NAME_ENCODED=$(printf '%s' "${TAG_NAME}" | jq -sRr @uri)
          GITEE_REPO="${GITEE_REPO_OWNER}/${GITEE_REPO_NAME}"
          
          echo "ðŸš€ åˆ›å»º Gitee Release..."
          echo "  æ ‡ç­¾: ${TAG_NAME}"
          echo "  åç§°: ${RELEASE_NAME}"
          echo "  ä»“åº“: ${GITEE_REPO}"
          echo "  Owner: ${GITEE_REPO_OWNER}"
          echo "  Repo Name: ${GITEE_REPO_NAME}"
          echo "  æ ‡ç­¾ (ç¼–ç åŽ): ${TAG_NAME_ENCODED}"
          
          # éªŒè¯ä»“åº“æ˜¯å¦å­˜åœ¨ï¼ˆèŽ·å–é»˜è®¤åˆ†æ”¯ä¿¡æ¯ï¼‰
          echo "ðŸ” éªŒè¯ Gitee ä»“åº“æ˜¯å¦å­˜åœ¨..."
          REPO_API_URL="https://gitee.com/api/v5/repos/${GITEE_REPO_OWNER_ENCODED}/${GITEE_REPO_NAME_ENCODED}"
          echo "  API URL: ${REPO_API_URL}"
          
          REPO_CHECK=$(curl -s -w "\n%{http_code}" -X GET \
            -H "Authorization: token ${GITEE_TOKEN}" \
            "${REPO_API_URL}")
          
          REPO_CHECK_HTTP_CODE=$(echo "$REPO_CHECK" | tail -n1)
          REPO_CHECK_BODY=$(echo "$REPO_CHECK" | sed '$d')
          
          echo "  HTTP çŠ¶æ€ç : ${REPO_CHECK_HTTP_CODE}"
          
          if [ "$REPO_CHECK_HTTP_CODE" != "200" ]; then
            ERROR_MSG=$(echo "$REPO_CHECK_BODY" | jq -r '.message // .error // "æœªçŸ¥é”™è¯¯"' 2>/dev/null || echo "$REPO_CHECK_BODY")
            echo "âŒ Gitee ä»“åº“ä¸å­˜åœ¨æˆ–æ— æ³•è®¿é—® (HTTP ${REPO_CHECK_HTTP_CODE})"
            echo "  API URL: ${REPO_API_URL}"
            echo "  é”™è¯¯ä¿¡æ¯: ${ERROR_MSG}"
            echo "  å®Œæ•´å“åº”: ${REPO_CHECK_BODY}"
            echo ""
            echo "  è¯·æ£€æŸ¥ï¼š"
            echo "    1. GITEE_REPO_OWNER æ˜¯å¦æ­£ç¡®: ${GITEE_REPO_OWNER}"
            echo "    2. GITEE_REPO_NAME æ˜¯å¦æ­£ç¡®: ${GITEE_REPO_NAME}"
            echo "    3. GITEE_TOKEN æ˜¯å¦æœ‰è®¿é—®è¯¥ä»“åº“çš„æƒé™"
            exit 1
          fi
          
          REPO_FULL_NAME=$(echo "$REPO_CHECK_BODY" | jq -r '.full_name // empty' 2>/dev/null || echo "")
          REPO_DESCRIPTION=$(echo "$REPO_CHECK_BODY" | jq -r '.description // empty' 2>/dev/null || echo "")
          REPO_DEFAULT_BRANCH=$(echo "$REPO_CHECK_BODY" | jq -r '.default_branch // "master"' 2>/dev/null || echo "master")
          echo "âœ… Gitee ä»“åº“éªŒè¯é€šè¿‡"
          if [ -n "$REPO_FULL_NAME" ]; then
            echo "  ä»“åº“å…¨å: ${REPO_FULL_NAME}"
          fi
          if [ -n "$REPO_DESCRIPTION" ]; then
            echo "  ä»“åº“æè¿°: ${REPO_DESCRIPTION}"
          fi
          echo "  é»˜è®¤åˆ†æ”¯: ${REPO_DEFAULT_BRANCH}"
          
          # èŽ·å–é»˜è®¤åˆ†æ”¯çš„æœ€æ–° commit SHAï¼ˆç”¨äºŽåˆ›å»ºæ ‡ç­¾å’Œ Releaseï¼Œä¸éœ€è¦æ£€æŸ¥ GitHub commitï¼‰
          echo ""
          echo "ðŸ” èŽ·å–é»˜è®¤åˆ†æ”¯ ${REPO_DEFAULT_BRANCH} çš„æœ€æ–° commit..."
          BRANCH_API_URL="https://gitee.com/api/v5/repos/${GITEE_REPO_OWNER_ENCODED}/${GITEE_REPO_NAME_ENCODED}/branches/${REPO_DEFAULT_BRANCH}"
          BRANCH_CHECK=$(curl -s -w "\n%{http_code}" -X GET \
            -H "Authorization: token ${GITEE_TOKEN}" \
            "${BRANCH_API_URL}")
          
          BRANCH_CHECK_HTTP_CODE=$(echo "$BRANCH_CHECK" | tail -n1)
          if [ "$BRANCH_CHECK_HTTP_CODE" = "200" ]; then
            BRANCH_CHECK_BODY=$(echo "$BRANCH_CHECK" | sed '$d')
            TARGET_COMMITISH=$(echo "$BRANCH_CHECK_BODY" | jq -r '.commit.sha // empty' 2>/dev/null || echo "")
            if [ -z "$TARGET_COMMITISH" ] || [ "$TARGET_COMMITISH" == "null" ]; then
              echo "âš ï¸ æ— æ³•èŽ·å–é»˜è®¤åˆ†æ”¯çš„ commit SHAï¼Œå°†ä½¿ç”¨åˆ†æ”¯å"
              TARGET_COMMITISH="${REPO_DEFAULT_BRANCH}"
            else
              echo "âœ… ä½¿ç”¨é»˜è®¤åˆ†æ”¯ ${REPO_DEFAULT_BRANCH} çš„æœ€æ–° commit: ${TARGET_COMMITISH:0:7}..."
            fi
          else
            echo "âš ï¸ æ— æ³•èŽ·å–é»˜è®¤åˆ†æ”¯ä¿¡æ¯ï¼Œå°†ä½¿ç”¨åˆ†æ”¯å"
            TARGET_COMMITISH="${REPO_DEFAULT_BRANCH}"
          fi
          echo ""
          
          # æ£€æŸ¥æ ‡ç­¾æ˜¯å¦å­˜åœ¨ï¼Œå¦‚æžœä¸å­˜åœ¨åˆ™åˆ›å»º
          echo "ðŸ” æ£€æŸ¥ Gitee æ ‡ç­¾æ˜¯å¦å­˜åœ¨..."
          TAG_CHECK_API_URL="https://gitee.com/api/v5/repos/${GITEE_REPO_OWNER_ENCODED}/${GITEE_REPO_NAME_ENCODED}/tags/${TAG_NAME_ENCODED}"
          echo "  æ ‡ç­¾æ£€æŸ¥ API URL: ${TAG_CHECK_API_URL}"
          
          TAG_CHECK=$(curl -s -w "\n%{http_code}" -X GET \
            -H "Authorization: token ${GITEE_TOKEN}" \
            "${TAG_CHECK_API_URL}")
          
          TAG_CHECK_HTTP_CODE=$(echo "$TAG_CHECK" | tail -n1)
          TAG_CHECK_BODY=$(echo "$TAG_CHECK" | sed '$d')
          
          echo "  HTTP çŠ¶æ€ç : ${TAG_CHECK_HTTP_CODE}"
          
          if [ "$TAG_CHECK_HTTP_CODE" != "200" ]; then
            echo "âš ï¸ æ ‡ç­¾ ${TAG_NAME} ä¸å­˜åœ¨ï¼Œåˆ›å»ºæ ‡ç­¾..."
            
            # åˆ›å»ºæ ‡ç­¾ï¼ˆä½¿ç”¨é»˜è®¤åˆ†æ”¯çš„æœ€æ–° commitï¼‰
            CREATE_TAG_API_URL="https://gitee.com/api/v5/repos/${GITEE_REPO_OWNER_ENCODED}/${GITEE_REPO_NAME_ENCODED}/tags"
            echo "  åˆ›å»ºæ ‡ç­¾ API URL: ${CREATE_TAG_API_URL}"
            
            CREATE_TAG_BODY=$(echo "{
              \"refs\": \"${TARGET_COMMITISH}\",
              \"tag_name\": \"${TAG_NAME}\",
              \"message\": \"Release ${TAG_NAME}\"
            }" | jq -c .)
            echo "  è¯·æ±‚ä½“: ${CREATE_TAG_BODY}"
            
            CREATE_TAG_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
              -H "Content-Type: application/json" \
              -H "Authorization: token ${GITEE_TOKEN}" \
              -d "${CREATE_TAG_BODY}" \
              "${CREATE_TAG_API_URL}")
            
            CREATE_TAG_HTTP_CODE=$(echo "$CREATE_TAG_RESPONSE" | tail -n1)
            CREATE_TAG_BODY_RESPONSE=$(echo "$CREATE_TAG_RESPONSE" | sed '$d')
            
            echo "  å“åº” HTTP çŠ¶æ€ç : ${CREATE_TAG_HTTP_CODE}"
            
            if [ "$CREATE_TAG_HTTP_CODE" = "200" ] || [ "$CREATE_TAG_HTTP_CODE" = "201" ]; then
              echo "âœ… æ ‡ç­¾ ${TAG_NAME} åˆ›å»ºæˆåŠŸ"
            else
              ERROR_MSG=$(echo "$CREATE_TAG_BODY_RESPONSE" | jq -r '.message // .error // "æœªçŸ¥é”™è¯¯"' 2>/dev/null || echo "$CREATE_TAG_BODY_RESPONSE")
              # å¦‚æžœæ ‡ç­¾å·²å­˜åœ¨ï¼Œç»§ç»­æ‰§è¡Œ
              if echo "$ERROR_MSG" | grep -qi "å·²å­˜åœ¨\|already exists\|duplicate\|æ ‡ç­¾åå·²å­˜åœ¨"; then
                echo "âš ï¸ æ ‡ç­¾å·²å­˜åœ¨ï¼Œç»§ç»­æ‰§è¡Œ..."
              else
                echo "âš ï¸ åˆ›å»ºæ ‡ç­¾å¤±è´¥ (HTTP ${CREATE_TAG_HTTP_CODE})ï¼Œä½†ç»§ç»­æ‰§è¡Œ"
                echo "  é”™è¯¯ä¿¡æ¯: ${ERROR_MSG}"
              fi
            fi
          else
            echo "âœ… æ ‡ç­¾ ${TAG_NAME} å·²å­˜åœ¨"
          fi
          
          # æ£€æŸ¥ Release æ˜¯å¦å·²å­˜åœ¨
          echo "ðŸ” æ£€æŸ¥ Gitee Release æ˜¯å¦å·²å­˜åœ¨..."
          RELEASE_CHECK_API_URL="https://gitee.com/api/v5/repos/${GITEE_REPO_OWNER_ENCODED}/${GITEE_REPO_NAME_ENCODED}/releases/tags/${TAG_NAME_ENCODED}"
          echo "  API URL: ${RELEASE_CHECK_API_URL}"
          
          EXISTING_RELEASE=$(curl -s -w "\n%{http_code}" -X GET \
            -H "Authorization: token ${GITEE_TOKEN}" \
            "${RELEASE_CHECK_API_URL}")
          
          EXISTING_HTTP_CODE=$(echo "$EXISTING_RELEASE" | tail -n1)
          EXISTING_BODY=$(echo "$EXISTING_RELEASE" | sed '$d')
          
          echo "  HTTP çŠ¶æ€ç : ${EXISTING_HTTP_CODE}"
          
          if [ "$EXISTING_HTTP_CODE" = "200" ] && echo "${EXISTING_BODY}" | grep -q '"id"'; then
            RELEASE_ID=$(echo "${EXISTING_BODY}" | jq -r '.id // empty')
            RELEASE_EXISTING_NAME=$(echo "${EXISTING_BODY}" | jq -r '.name // empty' 2>/dev/null || echo "")
            RELEASE_EXISTING_CREATED=$(echo "${EXISTING_BODY}" | jq -r '.created_at // empty' 2>/dev/null || echo "")
            echo "âš ï¸ Gitee Release å·²å­˜åœ¨ (ID: ${RELEASE_ID})ï¼Œå°†æ›´æ–°..."
            if [ -n "$RELEASE_EXISTING_NAME" ]; then
              echo "  çŽ°æœ‰ Release åç§°: ${RELEASE_EXISTING_NAME}"
            fi
            if [ -n "$RELEASE_EXISTING_CREATED" ]; then
              echo "  åˆ›å»ºæ—¶é—´: ${RELEASE_EXISTING_CREATED}"
            fi
            
            # æ›´æ–°çŽ°æœ‰ Release
            UPDATE_API_URL="https://gitee.com/api/v5/repos/${GITEE_REPO_OWNER_ENCODED}/${GITEE_REPO_NAME_ENCODED}/releases/${RELEASE_ID}"
            echo "  æ›´æ–° API URL: ${UPDATE_API_URL}"
            
            # æž„å»ºæ›´æ–°è¯·æ±‚ä½“
            UPDATE_BODY_JSON=$(echo "${RELEASE_BODY}" | jq -Rs .)
            REQUEST_BODY=$(echo "{
              \"tag_name\": \"${TAG_NAME}\",
              \"name\": \"${RELEASE_NAME}\",
              \"body\": ${UPDATE_BODY_JSON},
              \"target_commitish\": \"${TARGET_COMMITISH}\",
              \"prerelease\": false
            }" | jq -c .)
            echo "  è¯·æ±‚ä½“: ${REQUEST_BODY}"
            
            RESPONSE=$(curl -s -w "\n%{http_code}" -X PATCH \
              -H "Content-Type: application/json" \
              -H "Authorization: token ${GITEE_TOKEN}" \
              -d "${REQUEST_BODY}" \
              "${UPDATE_API_URL}")
          else
            # åˆ›å»ºæ–° Release
            echo "ðŸ“ åˆ›å»ºæ–°çš„ Gitee Release..."
            CREATE_API_URL="https://gitee.com/api/v5/repos/${GITEE_REPO_OWNER_ENCODED}/${GITEE_REPO_NAME_ENCODED}/releases"
            echo "  åˆ›å»º API URL: ${CREATE_API_URL}"
            
            # æž„å»ºåˆ›å»ºè¯·æ±‚ä½“
            CREATE_BODY_JSON=$(echo "${RELEASE_BODY}" | jq -Rs .)
            REQUEST_BODY=$(echo "{
              \"tag_name\": \"${TAG_NAME}\",
              \"name\": \"${RELEASE_NAME}\",
              \"body\": ${CREATE_BODY_JSON},
              \"target_commitish\": \"${TARGET_COMMITISH}\",
              \"prerelease\": false
            }" | jq -c .)
            echo "  è¯·æ±‚ä½“: ${REQUEST_BODY}"
            
            RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
              -H "Content-Type: application/json" \
              -H "Authorization: token ${GITEE_TOKEN}" \
              -d "${REQUEST_BODY}" \
              "${CREATE_API_URL}")
          fi
          
          HTTP_CODE=$(echo "$RESPONSE" | tail -n1)
          RESPONSE_BODY=$(echo "$RESPONSE" | sed '$d')
          
          echo "  å“åº” HTTP çŠ¶æ€ç : ${HTTP_CODE}"
          
          # æ£€æŸ¥å“åº”
          if [ "$HTTP_CODE" = "200" ] || [ "$HTTP_CODE" = "201" ]; then
            if echo "${RESPONSE_BODY}" | grep -q '"id"'; then
              RELEASE_ID=$(echo "${RESPONSE_BODY}" | jq -r '.id // empty')
              RELEASE_TAG_NAME=$(echo "${RESPONSE_BODY}" | jq -r '.tag_name // empty' 2>/dev/null || echo "")
              RELEASE_CREATED=$(echo "${RESPONSE_BODY}" | jq -r '.created_at // empty' 2>/dev/null || echo "")
              echo "âœ… Gitee Release åˆ›å»º/æ›´æ–°æˆåŠŸ"
              echo "  Release ID: ${RELEASE_ID}"
              if [ -n "$RELEASE_TAG_NAME" ]; then
                echo "  æ ‡ç­¾: ${RELEASE_TAG_NAME}"
              fi
              if [ -n "$RELEASE_CREATED" ]; then
                echo "  åˆ›å»ºæ—¶é—´: ${RELEASE_CREATED}"
              fi
              echo "  å®Œæ•´å“åº”: ${RESPONSE_BODY}"
            else
              echo "âš ï¸ å“åº”æ ¼å¼å¼‚å¸¸ï¼Œä½† HTTP çŠ¶æ€ç ä¸º ${HTTP_CODE}"
              echo "  å“åº”å†…å®¹: ${RESPONSE_BODY}"
            fi
          else
            ERROR_MSG=$(echo "${RESPONSE_BODY}" | jq -r '.message // .error // "æœªçŸ¥é”™è¯¯"' 2>/dev/null || echo "${RESPONSE_BODY}")
            echo "âŒ Gitee Release åˆ›å»º/æ›´æ–°å¤±è´¥ (HTTP ${HTTP_CODE})"
            echo "  é”™è¯¯ä¿¡æ¯: ${ERROR_MSG}"
            echo "  å®Œæ•´å“åº”: ${RESPONSE_BODY}"
            exit 1
          fi

      - name: Upload assets to Gitee Release
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_REPO_OWNER: ${{ secrets.GITEE_REPO_OWNER }}
          GITEE_REPO_NAME: ${{ secrets.GITEE_REPO_NAME }}
        run: |
          TAG_NAME="${{ steps.get_version.outputs.TAG_NAME }}"
          
          # æ¸…ç†å¹¶åŽ»é™¤æ¢è¡Œç¬¦ã€å›žè½¦ç¬¦å’Œå‰åŽç©ºæ ¼
          GITEE_REPO_OWNER=$(printf '%s' "${GITEE_REPO_OWNER}" | tr -d '\n\r\t' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          GITEE_REPO_NAME=$(printf '%s' "${GITEE_REPO_NAME}" | tr -d '\n\r\t' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          
          # URL ç¼–ç 
          GITEE_REPO_OWNER_ENCODED=$(printf '%s' "${GITEE_REPO_OWNER}" | jq -sRr @uri)
          GITEE_REPO_NAME_ENCODED=$(printf '%s' "${GITEE_REPO_NAME}" | jq -sRr @uri)
          TAG_NAME_ENCODED=$(printf '%s' "${TAG_NAME}" | jq -sRr @uri)
          GITEE_REPO="${GITEE_REPO_OWNER}/${GITEE_REPO_NAME}"
          
          echo "ðŸ“¤ ä¸Šä¼ æž„å»ºäº§ç‰©åˆ° Gitee Release..."
          echo "  æ ‡ç­¾: ${TAG_NAME}"
          echo "  ä»“åº“: ${GITEE_REPO}"
          echo "  Owner: ${GITEE_REPO_OWNER}"
          echo "  Repo Name: ${GITEE_REPO_NAME}"
          
          # é¦–å…ˆèŽ·å– Release IDï¼ˆç”¨äºŽä¸Šä¼ æ–‡ä»¶ï¼‰
          echo "ðŸ” èŽ·å– Gitee Release ID..."
          RELEASE_INFO_API_URL="https://gitee.com/api/v5/repos/${GITEE_REPO_OWNER_ENCODED}/${GITEE_REPO_NAME_ENCODED}/releases/tags/${TAG_NAME_ENCODED}"
          echo "  API URL: ${RELEASE_INFO_API_URL}"
          
          RELEASE_INFO=$(curl -s -w "\n%{http_code}" -X GET \
            -H "Authorization: token ${GITEE_TOKEN}" \
            "${RELEASE_INFO_API_URL}")
          
          RELEASE_INFO_HTTP_CODE=$(echo "$RELEASE_INFO" | tail -n1)
          RELEASE_INFO_BODY=$(echo "$RELEASE_INFO" | sed '$d')
          
          echo "  HTTP çŠ¶æ€ç : ${RELEASE_INFO_HTTP_CODE}"
          
          if [ "$RELEASE_INFO_HTTP_CODE" != "200" ] || ! echo "${RELEASE_INFO_BODY}" | grep -q '"id"'; then
            echo "âŒ æ— æ³•èŽ·å– Gitee Release ä¿¡æ¯ (HTTP ${RELEASE_INFO_HTTP_CODE})"
            echo "  API URL: ${RELEASE_INFO_API_URL}"
            echo "  å“åº”: ${RELEASE_INFO_BODY}"
            exit 1
          fi
          
          RELEASE_ID=$(echo "${RELEASE_INFO_BODY}" | jq -r '.id // empty')
          RELEASE_NAME_FROM_API=$(echo "${RELEASE_INFO_BODY}" | jq -r '.name // empty' 2>/dev/null || echo "")
          echo "âœ… æ‰¾åˆ° Gitee Release"
          echo "  Release ID: ${RELEASE_ID}"
          if [ -n "$RELEASE_NAME_FROM_API" ]; then
            echo "  Release åç§°: ${RELEASE_NAME_FROM_API}"
          fi
          
          # æ£€æŸ¥æ–‡ä»¶æ•°é‡
          FILE_COUNT=$(find release-assets -type f 2>/dev/null | wc -l)
          if [ "$FILE_COUNT" -eq 0 ]; then
            echo "âš ï¸ æœªæ‰¾åˆ°éœ€è¦ä¸Šä¼ çš„æ–‡ä»¶"
            exit 0
          fi
          
          echo "  æ‰¾åˆ° ${FILE_COUNT} ä¸ªæ–‡ä»¶éœ€è¦ä¸Šä¼ "
          
          UPLOAD_SUCCESS=0
          UPLOAD_FAILED=0
          
          # ä¸Šä¼ æ‰€æœ‰æ–‡ä»¶
          UPLOAD_API_BASE_URL="https://gitee.com/api/v5/repos/${GITEE_REPO_OWNER_ENCODED}/${GITEE_REPO_NAME_ENCODED}/releases/${RELEASE_ID}/attach_files"
          echo "  ä¸Šä¼  API URL: ${UPLOAD_API_BASE_URL}"
          
          for file in release-assets/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              filesize=$(du -h "$file" | cut -f1)
              filepath=$(realpath "$file" 2>/dev/null || echo "$file")
              echo "  ðŸ“¦ ä¸Šä¼  ${filename} (${filesize})..."
              echo "    æ–‡ä»¶è·¯å¾„: ${filepath}"
              
              UPLOAD_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
                -H "Authorization: token ${GITEE_TOKEN}" \
                -F "file=@${file}" \
                "${UPLOAD_API_BASE_URL}")
              
              HTTP_CODE=$(echo "$UPLOAD_RESPONSE" | tail -n1)
              RESPONSE_BODY=$(echo "$UPLOAD_RESPONSE" | sed '$d')
              
              echo "    HTTP çŠ¶æ€ç : ${HTTP_CODE}"
              
              if [ "$HTTP_CODE" -eq 201 ] || [ "$HTTP_CODE" -eq 200 ]; then
                echo "    âœ… ${filename} ä¸Šä¼ æˆåŠŸ"
                echo "    å“åº”: ${RESPONSE_BODY}"
                UPLOAD_SUCCESS=$((UPLOAD_SUCCESS + 1))
              elif echo "$RESPONSE_BODY" | grep -q "already exists\|å·²å­˜åœ¨"; then
                echo "    âš ï¸ ${filename} å·²å­˜åœ¨ï¼Œè·³è¿‡"
                echo "    å“åº”: ${RESPONSE_BODY}"
                UPLOAD_SUCCESS=$((UPLOAD_SUCCESS + 1))
              else
                ERROR_MSG=$(echo "$RESPONSE_BODY" | jq -r '.message // .error // "æœªçŸ¥é”™è¯¯"' 2>/dev/null || echo "HTTP ${HTTP_CODE}")
                echo "    âŒ ${filename} ä¸Šä¼ å¤±è´¥: ${ERROR_MSG}"
                echo "    å®Œæ•´å“åº”: ${RESPONSE_BODY}"
                UPLOAD_FAILED=$((UPLOAD_FAILED + 1))
              fi
            fi
          done
          
          echo ""
          echo "ðŸ“Š ä¸Šä¼ ç»Ÿè®¡:"
          echo "  âœ… æˆåŠŸ: ${UPLOAD_SUCCESS}"
          echo "  âŒ å¤±è´¥: ${UPLOAD_FAILED}"
          
          if [ "$UPLOAD_FAILED" -gt 0 ]; then
            echo "âš ï¸ éƒ¨åˆ†æ–‡ä»¶ä¸Šä¼ å¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡ŒåŽç»­æ­¥éª¤"
          else
            echo "âœ… æ‰€æœ‰æž„å»ºäº§ç‰©ä¸Šä¼ å®Œæˆ"
          fi

      - name: Sync update config to Gitee
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_REPO_OWNER: ${{ secrets.GITEE_REPO_OWNER }}
          GITEE_REPO_NAME: ${{ secrets.GITEE_REPO_NAME }}
        run: |
          echo "ðŸ”„ åŒæ­¥æ›´æ–°é…ç½®åˆ° Gitee..."
          
          # æ¸…ç†å¹¶åŽ»é™¤æ¢è¡Œç¬¦ã€å›žè½¦ç¬¦å’Œå‰åŽç©ºæ ¼
          GITEE_REPO_OWNER=$(printf '%s' "${GITEE_REPO_OWNER}" | tr -d '\n\r\t' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          GITEE_REPO_NAME=$(printf '%s' "${GITEE_REPO_NAME}" | tr -d '\n\r\t' | sed 's/^[[:space:]]*//;s/[[:space:]]*$//')
          GITEE_REPO="${GITEE_REPO_OWNER}/${GITEE_REPO_NAME}"
          TAG_NAME="${{ steps.get_version.outputs.TAG_NAME }}"
          
          echo "  Owner: ${GITEE_REPO_OWNER}"
          echo "  Repo Name: ${GITEE_REPO_NAME}"
          echo "  ä»“åº“: ${GITEE_REPO}"
          
          # URL ç¼–ç 
          GITEE_REPO_OWNER_ENCODED=$(printf '%s' "${GITEE_REPO_OWNER}" | jq -sRr @uri)
          GITEE_REPO_NAME_ENCODED=$(printf '%s' "${GITEE_REPO_NAME}" | jq -sRr @uri)
          
          # è¯»å– GitHub çš„æ›´æ–°é…ç½®æ–‡ä»¶
          if [ -f "update_config_github.json" ]; then
            echo "âœ… æ‰¾åˆ° GitHub æ›´æ–°é…ç½®æ–‡ä»¶"
            echo "  æ–‡ä»¶è·¯å¾„: $(realpath update_config_github.json 2>/dev/null || echo 'update_config_github.json')"
            
            # æ˜¾ç¤ºåŽŸå§‹é…ç½®å†…å®¹
            echo "  åŽŸå§‹é…ç½®å†…å®¹:"
            cat update_config_github.json | jq '.' 2>/dev/null || cat update_config_github.json
            
            # è½¬æ¢ä¸º Gitee æ ¼å¼
            echo ""
            echo "  è½¬æ¢é…ç½®ä¸º Gitee æ ¼å¼..."
            echo "  Gitee ä»“åº“: ${GITEE_REPO}"
            
            # å›ºå®š Release Tag åç§°ï¼ˆç®€çŸ­ï¼Œæ— ç‰¹æ®Šå­—ç¬¦ï¼‰
            CONFIG_RELEASE_TAG="config"
            CONFIG_RELEASE_TAG_ENCODED=$(printf '%s' "${CONFIG_RELEASE_TAG}" | jq -sRr @uri)
            
            # ä½¿ç”¨ jq ä¿®æ”¹ URLï¼ŒupdateCheckUrl æŒ‡å‘å›ºå®š Release
            cat update_config_github.json | jq "
              .updateCheckUrl = \"https://gitee.com/${GITEE_REPO}/releases/download/${CONFIG_RELEASE_TAG}/update_config_gitee.json\" |
              .client.platforms.macos.downloadUrl = (.client.platforms.macos.downloadUrl | gsub(\"github.com.*releases\"; \"gitee.com/${GITEE_REPO}/releases\")) |
              .client.platforms.windows.downloadUrl = (.client.platforms.windows.downloadUrl | gsub(\"github.com.*releases\"; \"gitee.com/${GITEE_REPO}/releases\")) |
              .server.platforms.android.downloadUrl = (.server.platforms.android.downloadUrl | gsub(\"github.com.*releases\"; \"gitee.com/${GITEE_REPO}/releases\"))
            " > update_config_gitee.json
            
            echo "âœ… å·²ç”Ÿæˆ Gitee æ›´æ–°é…ç½®æ–‡ä»¶"
            echo "  æ–‡ä»¶è·¯å¾„: $(realpath update_config_gitee.json 2>/dev/null || echo 'update_config_gitee.json')"
            echo "  æ›´æ–°æ£€æŸ¥ URL: https://gitee.com/${GITEE_REPO}/releases/download/${CONFIG_RELEASE_TAG}/update_config_gitee.json"
            echo ""
            echo "  Gitee é…ç½®å†…å®¹:"
            cat update_config_gitee.json | jq '.' 2>/dev/null || cat update_config_gitee.json
            
            # èŽ·å– master åˆ†æ”¯çš„æœ€æ–° commit SHAï¼ˆç”¨äºŽåˆ›å»º/æ›´æ–° Releaseï¼‰
            echo ""
            echo "ðŸ” èŽ·å– master åˆ†æ”¯çš„æœ€æ–° commit..."
            BRANCH_INFO=$(curl -s -X GET \
              -H "Authorization: token ${GITEE_TOKEN}" \
              "https://gitee.com/api/v5/repos/${GITEE_REPO_OWNER_ENCODED}/${GITEE_REPO_NAME_ENCODED}/branches/master")
            
            MASTER_COMMIT_SHA=$(echo "$BRANCH_INFO" | jq -r '.commit.sha // empty' 2>/dev/null || echo "")
            
            if [ -z "$MASTER_COMMIT_SHA" ] || [ "$MASTER_COMMIT_SHA" == "null" ]; then
              echo "âš ï¸ æ— æ³•èŽ·å– master åˆ†æ”¯çš„ commit SHAï¼Œä½¿ç”¨é»˜è®¤åˆ†æ”¯"
              MASTER_COMMIT_SHA="master"
            else
              echo "âœ… Master åˆ†æ”¯æœ€æ–° commit: ${MASTER_COMMIT_SHA:0:7}..."
            fi
            
            # æ£€æŸ¥é…ç½® Release æ˜¯å¦å­˜åœ¨
            echo ""
            echo "ðŸ” æ£€æŸ¥é…ç½® Release æ˜¯å¦å­˜åœ¨..."
            RELEASE_CHECK=$(curl -s -w "\n%{http_code}" -X GET \
              -H "Authorization: token ${GITEE_TOKEN}" \
              "https://gitee.com/api/v5/repos/${GITEE_REPO_OWNER_ENCODED}/${GITEE_REPO_NAME_ENCODED}/releases/tags/${CONFIG_RELEASE_TAG_ENCODED}")
            
            RELEASE_CHECK_HTTP_CODE=$(echo "$RELEASE_CHECK" | tail -n1)
            RELEASE_CHECK_BODY=$(echo "$RELEASE_CHECK" | sed '$d')
            
            echo "  HTTP çŠ¶æ€ç : ${RELEASE_CHECK_HTTP_CODE}"
            
            if [ "$RELEASE_CHECK_HTTP_CODE" = "200" ]; then
              RELEASE_ID=$(echo "$RELEASE_CHECK_BODY" | jq -r '.id // empty' 2>/dev/null || echo "")
              if [ -n "$RELEASE_ID" ] && [ "$RELEASE_ID" != "null" ]; then
                echo "âœ… Release ${CONFIG_RELEASE_TAG} å·²å­˜åœ¨ (ID: ${RELEASE_ID})"
                USE_EXISTING_RELEASE=true
              else
                echo "âš ï¸ æ— æ³•èŽ·å– Release IDï¼Œå°†åˆ›å»ºæ–°çš„ Release"
                USE_EXISTING_RELEASE=false
              fi
            else
              echo "âš ï¸ Release ${CONFIG_RELEASE_TAG} ä¸å­˜åœ¨ï¼Œå°†åˆ›å»ºæ–°çš„ Release"
              USE_EXISTING_RELEASE=false
            fi
            
            # ç¡®ä¿ tag å­˜åœ¨ï¼ˆRelease éœ€è¦ tagï¼‰
            echo ""
            echo "ðŸ” ç¡®ä¿ Tag ${CONFIG_RELEASE_TAG} å­˜åœ¨..."
            TAG_CHECK=$(curl -s -w "\n%{http_code}" -X GET \
              -H "Authorization: token ${GITEE_TOKEN}" \
              "https://gitee.com/api/v5/repos/${GITEE_REPO_OWNER_ENCODED}/${GITEE_REPO_NAME_ENCODED}/tags/${CONFIG_RELEASE_TAG_ENCODED}")
            
            TAG_CHECK_HTTP_CODE=$(echo "$TAG_CHECK" | tail -n1)
            
            if [ "$TAG_CHECK_HTTP_CODE" != "200" ]; then
              echo "  Tag ä¸å­˜åœ¨ï¼Œåˆ›å»º Tag..."
              CREATE_TAG_BODY=$(echo "{
                \"refs\": \"${MASTER_COMMIT_SHA}\",
                \"tag_name\": \"${CONFIG_RELEASE_TAG}\",
                \"message\": \"Tag for update config release\"
              }" | jq -c .)
              
              CREATE_TAG_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
                -H "Content-Type: application/json" \
                -H "Authorization: token ${GITEE_TOKEN}" \
                -d "${CREATE_TAG_BODY}" \
                "https://gitee.com/api/v5/repos/${GITEE_REPO_OWNER_ENCODED}/${GITEE_REPO_NAME_ENCODED}/tags")
              
              CREATE_TAG_HTTP_CODE=$(echo "$CREATE_TAG_RESPONSE" | tail -n1)
              
              if [ "$CREATE_TAG_HTTP_CODE" = "200" ] || [ "$CREATE_TAG_HTTP_CODE" = "201" ]; then
                echo "âœ… Tag ${CONFIG_RELEASE_TAG} åˆ›å»ºæˆåŠŸ"
              else
                ERROR_MSG=$(echo "$CREATE_TAG_RESPONSE" | sed '$d' | jq -r '.message // .error // "æœªçŸ¥é”™è¯¯"' 2>/dev/null || echo "")
                if echo "$ERROR_MSG" | grep -qi "å·²å­˜åœ¨\|already exists\|duplicate\|æ ‡ç­¾åå·²å­˜åœ¨"; then
                  echo "âœ… Tag å·²å­˜åœ¨"
                else
                  echo "âš ï¸ Tag åˆ›å»ºå¤±è´¥ï¼Œä½†ç»§ç»­æ‰§è¡Œ"
                fi
              fi
            else
              echo "âœ… Tag ${CONFIG_RELEASE_TAG} å·²å­˜åœ¨"
            fi
            
            # åˆ›å»ºæˆ–æ›´æ–° Release
            echo ""
            if [ "$USE_EXISTING_RELEASE" = false ]; then
              echo "ðŸ“ åˆ›å»ºé…ç½® Release..."
              
              RELEASE_NAME="Update Configuration"
              RELEASE_BODY="This release contains the update configuration file for the application."
              
              CREATE_RELEASE_BODY=$(echo "{
                \"tag_name\": \"${CONFIG_RELEASE_TAG}\",
                \"name\": \"${RELEASE_NAME}\",
                \"body\": \"${RELEASE_BODY}\",
                \"target_commitish\": \"${MASTER_COMMIT_SHA}\",
                \"prerelease\": false
              }" | jq -c .)
              
              CREATE_RELEASE_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
                -H "Content-Type: application/json" \
                -H "Authorization: token ${GITEE_TOKEN}" \
                -d "${CREATE_RELEASE_BODY}" \
                "https://gitee.com/api/v5/repos/${GITEE_REPO_OWNER_ENCODED}/${GITEE_REPO_NAME_ENCODED}/releases")
              
              CREATE_RELEASE_HTTP_CODE=$(echo "$CREATE_RELEASE_RESPONSE" | tail -n1)
              CREATE_RELEASE_BODY_RESPONSE=$(echo "$CREATE_RELEASE_RESPONSE" | sed '$d')
              
              echo "  å“åº” HTTP çŠ¶æ€ç : ${CREATE_RELEASE_HTTP_CODE}"
              
              if [ "$CREATE_RELEASE_HTTP_CODE" = "200" ] || [ "$CREATE_RELEASE_HTTP_CODE" = "201" ]; then
                RELEASE_ID=$(echo "$CREATE_RELEASE_BODY_RESPONSE" | jq -r '.id // empty' 2>/dev/null || echo "")
                echo "âœ… Release åˆ›å»ºæˆåŠŸ (ID: ${RELEASE_ID})"
              else
                ERROR_MSG=$(echo "$CREATE_RELEASE_BODY_RESPONSE" | jq -r '.message // .error // "æœªçŸ¥é”™è¯¯"' 2>/dev/null || echo "$CREATE_RELEASE_BODY_RESPONSE")
                echo "âŒ Release åˆ›å»ºå¤±è´¥ (HTTP ${CREATE_RELEASE_HTTP_CODE})"
                echo "  é”™è¯¯ä¿¡æ¯: ${ERROR_MSG}"
                exit 1
              fi
            else
              echo "ðŸ“ æ›´æ–°çŽ°æœ‰ Release..."
              
              RELEASE_NAME="Update Configuration"
              RELEASE_BODY="This release contains the update configuration file for the application. Updated at $(date -u +'%Y-%m-%d %H:%M:%S')"
              
              UPDATE_RELEASE_BODY=$(echo "{
                \"tag_name\": \"${CONFIG_RELEASE_TAG}\",
                \"name\": \"${RELEASE_NAME}\",
                \"body\": \"${RELEASE_BODY}\",
                \"target_commitish\": \"${MASTER_COMMIT_SHA}\",
                \"prerelease\": false
              }" | jq -c .)
              
              UPDATE_RELEASE_RESPONSE=$(curl -s -w "\n%{http_code}" -X PATCH \
                -H "Content-Type: application/json" \
                -H "Authorization: token ${GITEE_TOKEN}" \
                -d "${UPDATE_RELEASE_BODY}" \
                "https://gitee.com/api/v5/repos/${GITEE_REPO_OWNER_ENCODED}/${GITEE_REPO_NAME_ENCODED}/releases/${RELEASE_ID}")
              
              UPDATE_RELEASE_HTTP_CODE=$(echo "$UPDATE_RELEASE_RESPONSE" | tail -n1)
              
              echo "  å“åº” HTTP çŠ¶æ€ç : ${UPDATE_RELEASE_HTTP_CODE}"
              
              if [ "$UPDATE_RELEASE_HTTP_CODE" = "200" ] || [ "$UPDATE_RELEASE_HTTP_CODE" = "201" ]; then
                echo "âœ… Release æ›´æ–°æˆåŠŸ"
              else
                ERROR_MSG=$(echo "$UPDATE_RELEASE_RESPONSE" | sed '$d' | jq -r '.message // .error // "æœªçŸ¥é”™è¯¯"' 2>/dev/null || echo "")
                echo "âš ï¸ Release æ›´æ–°å¤±è´¥ (HTTP ${UPDATE_RELEASE_HTTP_CODE})ï¼Œä½†ç»§ç»­æ‰§è¡Œ"
                echo "  é”™è¯¯ä¿¡æ¯: ${ERROR_MSG}"
              fi
            fi
            
            # ä¸Šä¼ é…ç½®æ–‡ä»¶åˆ° Release
            echo ""
            echo "ðŸ“¤ ä¸Šä¼ é…ç½®æ–‡ä»¶åˆ° Release..."
            
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å·²å­˜åœ¨
            ASSETS_CHECK=$(curl -s -X GET \
              -H "Authorization: token ${GITEE_TOKEN}" \
              "https://gitee.com/api/v5/repos/${GITEE_REPO_OWNER_ENCODED}/${GITEE_REPO_NAME_ENCODED}/releases/${RELEASE_ID}/attach_files")
            
            EXISTING_ASSET_ID=$(echo "$ASSETS_CHECK" | jq -r ".[] | select(.name == \"update_config_gitee.json\") | .id" 2>/dev/null | head -1)
            
            if [ -n "$EXISTING_ASSET_ID" ] && [ "$EXISTING_ASSET_ID" != "null" ]; then
              echo "  æ–‡ä»¶å·²å­˜åœ¨ (ID: ${EXISTING_ASSET_ID})ï¼Œåˆ é™¤æ—§æ–‡ä»¶..."
              DELETE_ASSET_RESPONSE=$(curl -s -w "\n%{http_code}" -X DELETE \
                -H "Authorization: token ${GITEE_TOKEN}" \
                "https://gitee.com/api/v5/repos/${GITEE_REPO_OWNER_ENCODED}/${GITEE_REPO_NAME_ENCODED}/releases/${RELEASE_ID}/attach_files/${EXISTING_ASSET_ID}")
              
              DELETE_ASSET_HTTP_CODE=$(echo "$DELETE_ASSET_RESPONSE" | tail -n1)
              echo "  åˆ é™¤å“åº” HTTP çŠ¶æ€ç : ${DELETE_ASSET_HTTP_CODE}"
              sleep 2
            fi
            
            echo "  ä¸Šä¼ æ–°æ–‡ä»¶..."
            UPLOAD_API_URL="https://gitee.com/api/v5/repos/${GITEE_REPO_OWNER_ENCODED}/${GITEE_REPO_NAME_ENCODED}/releases/${RELEASE_ID}/attach_files"
            
            FILE_SIZE=$(stat -f%z update_config_gitee.json 2>/dev/null || stat -c%s update_config_gitee.json 2>/dev/null || echo "unknown")
            echo "  æ–‡ä»¶å¤§å°: ${FILE_SIZE} bytes"
            
            UPLOAD_RESPONSE=$(curl -s -w "\n%{http_code}" -X POST \
              -H "Authorization: token ${GITEE_TOKEN}" \
              -F "file=@update_config_gitee.json" \
              -F "name=update_config_gitee.json" \
              "${UPLOAD_API_URL}")
            
            UPLOAD_HTTP_CODE=$(echo "$UPLOAD_RESPONSE" | tail -n1)
            UPLOAD_BODY_RESPONSE=$(echo "$UPLOAD_RESPONSE" | sed '$d')
            
            echo "  å“åº” HTTP çŠ¶æ€ç : ${UPLOAD_HTTP_CODE}"
            
            if [ "$UPLOAD_HTTP_CODE" = "200" ] || [ "$UPLOAD_HTTP_CODE" = "201" ]; then
              ASSET_NAME=$(echo "$UPLOAD_BODY_RESPONSE" | jq -r '.name // empty' 2>/dev/null || echo "")
              ASSET_URL=$(echo "$UPLOAD_BODY_RESPONSE" | jq -r '.browser_download_url // empty' 2>/dev/null || echo "")
              echo "âœ… æ–‡ä»¶ä¸Šä¼ æˆåŠŸ"
              if [ -n "$ASSET_NAME" ]; then
                echo "  æ–‡ä»¶å: ${ASSET_NAME}"
              fi
              if [ -n "$ASSET_URL" ]; then
                echo "  ä¸‹è½½ URL: ${ASSET_URL}"
              fi
            else
              ERROR_MSG=$(echo "$UPLOAD_BODY_RESPONSE" | jq -r '.message // .error // "æœªçŸ¥é”™è¯¯"' 2>/dev/null || echo "$UPLOAD_BODY_RESPONSE")
              echo "âŒ æ–‡ä»¶ä¸Šä¼ å¤±è´¥ (HTTP ${UPLOAD_HTTP_CODE})"
              echo "  é”™è¯¯ä¿¡æ¯: ${ERROR_MSG}"
              echo "  å®Œæ•´å“åº”: ${UPLOAD_BODY_RESPONSE}"
              exit 1
            fi
            
            echo ""
            echo "âœ… æ›´æ–°é…ç½®æ–‡ä»¶å·²æˆåŠŸåŒæ­¥åˆ° Gitee Release: ${CONFIG_RELEASE_TAG}"
            echo "  è®¿é—® URL: https://gitee.com/${GITEE_REPO}/releases/download/${CONFIG_RELEASE_TAG}/update_config_gitee.json"
          else
            echo "âš ï¸ update_config_github.json æœªæ‰¾åˆ°ï¼Œè·³è¿‡é…ç½®åŒæ­¥"
            echo "  å½“å‰ç›®å½•: $(pwd)"
            echo "  æ–‡ä»¶åˆ—è¡¨:"
            ls -la *.json 2>/dev/null || echo "  æœªæ‰¾åˆ° JSON æ–‡ä»¶"
            exit 1
          fi

