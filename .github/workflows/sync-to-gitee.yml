name: Sync Release to Gitee

# 当 GitHub Release 创建后，自动同步到 Gitee
on:
  release:
    types: [published]  # 当 Release 发布时触发

jobs:
  sync-release:
    name: Sync Release to Gitee
    runs-on: ubuntu-latest
    permissions:
      contents: read
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version from release
        id: get_version
        run: |
          # 从 release 事件获取 tag 名称
          # release 事件的 GITHUB_REF 格式可能是 refs/tags/v1.0.0
          TAG_NAME=${GITHUB_REF#refs/tags/}
          
          # 如果没有从 GITHUB_REF 获取到，尝试从环境变量获取
          if [ -z "$TAG_NAME" ] || [ "$TAG_NAME" == "$GITHUB_REF" ]; then
            # release 事件可能使用不同的 ref
            TAG_NAME=${GITHUB_REF#refs/heads/}
          fi
          
          # 如果还是获取不到，从 GitHub API 获取
          if [ -z "$TAG_NAME" ] || [ "$TAG_NAME" == "$GITHUB_REF" ]; then
            TAG_NAME=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/releases/latest" | \
              jq -r '.tag_name // empty')
          fi
          
          VERSION=${TAG_NAME#v}  # 去掉 v 前缀
          echo "TAG_NAME=${TAG_NAME}" >> $GITHUB_OUTPUT
          echo "VERSION=${VERSION}" >> $GITHUB_OUTPUT
          echo "Release tag: ${TAG_NAME}"
          echo "Version: ${VERSION}"

      - name: Get Release info
        uses: actions/github-script@v7
        id: release_info
        with:
          script: |
            // 从 release 事件获取 release 信息
            let release;
            if (context.payload.release) {
              // release 事件直接包含 release 信息
              release = context.payload.release;
            } else {
              // 否则通过 API 获取
              const tagName = '${{ steps.get_version.outputs.TAG_NAME }}';
              const { data } = await github.rest.repos.getReleaseByTag({
                owner: context.repo.owner,
                repo: context.repo.repo,
                tag: tagName
              });
              release = data;
            }
            
            const assets = release.assets || [];
            console.log(`Found ${assets.length} assets`);
            
            // 保存 release 信息
            core.setOutput('release_body', release.body || '');
            core.setOutput('release_name', release.name || release.tag_name);
            
            // 返回 assets 信息供后续步骤使用
            return JSON.stringify(assets.map(a => ({
              name: a.name,
              url: a.browser_download_url
            })));

      - name: Download assets files
        run: |
          mkdir -p release-assets
          
          # 使用 GitHub CLI 下载文件（如果可用）
          if command -v gh &> /dev/null; then
            echo "Using GitHub CLI to download assets..."
            gh release download "${{ steps.get_version.outputs.TAG_NAME }}" -D release-assets
          else
            # 手动下载（使用 curl）
            echo "Downloading assets manually..."
            ASSETS='${{ steps.release_info.outputs.result }}'
            echo "$ASSETS" | jq -r '.[] | "\(.url)|\(.name)"' | while IFS='|' read -r url name; do
              echo "Downloading $name..."
              curl -L -o "release-assets/$name" "$url"
            done
          fi
          
          echo "Downloaded files:"
          ls -lh release-assets/

      - name: Create Gitee Release
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_REPO_OWNER: ${{ secrets.GITEE_REPO_OWNER }}
          GITEE_REPO_NAME: ${{ secrets.GITEE_REPO_NAME }}
        run: |
          TAG_NAME="${{ steps.get_version.outputs.TAG_NAME }}"
          RELEASE_NAME="${{ steps.get_version.outputs.RELEASE_NAME }}"
          RELEASE_BODY="${{ steps.get_version.outputs.RELEASE_BODY }}"
          
          GITEE_REPO="${GITEE_REPO_OWNER}/${GITEE_REPO_NAME}"
          
          # 创建 Gitee Release
          echo "Creating Gitee Release: ${TAG_NAME}"
          
          RESPONSE=$(curl -s -X POST \
            -H "Content-Type: application/json" \
            -H "Authorization: token ${GITEE_TOKEN}" \
            -d "{
              \"tag_name\": \"${TAG_NAME}\",
              \"name\": \"${RELEASE_NAME}\",
              \"body\": $(echo "${RELEASE_BODY}" | jq -Rs .),
              \"prerelease\": false
            }" \
            "https://gitee.com/api/v5/repos/${GITEE_REPO}/releases")
          
          echo "Gitee Release response: ${RESPONSE}"
          
          # 检查是否创建成功
          if echo "${RESPONSE}" | grep -q '"id"'; then
            echo "✅ Gitee Release created successfully"
          else
            echo "⚠️ Gitee Release may already exist or failed"
            echo "Response: ${RESPONSE}"
          fi

      - name: Upload assets to Gitee Release
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_REPO_OWNER: ${{ secrets.GITEE_REPO_OWNER }}
          GITEE_REPO_NAME: ${{ secrets.GITEE_REPO_NAME }}
        run: |
          TAG_NAME="${{ steps.get_version.outputs.TAG_NAME }}"
          GITEE_REPO="${GITEE_REPO_OWNER}/${GITEE_REPO_NAME}"
          
          echo "Uploading assets to Gitee Release..."
          
          # 上传所有文件
          for file in release-assets/*; do
            if [ -f "$file" ]; then
              filename=$(basename "$file")
              echo "Uploading ${filename}..."
              
              curl -X POST \
                -H "Authorization: token ${GITEE_TOKEN}" \
                -F "file=@${file}" \
                "https://gitee.com/api/v5/repos/${GITEE_REPO}/releases/${TAG_NAME}/attach_files" || echo "Upload ${filename} failed or already exists"
            fi
          done
          
          echo "✅ Assets upload completed"

      - name: Sync update config to Gitee
        env:
          GITEE_TOKEN: ${{ secrets.GITEE_TOKEN }}
          GITEE_REPO_OWNER: ${{ secrets.GITEE_REPO_OWNER }}
          GITEE_REPO_NAME: ${{ secrets.GITEE_REPO_NAME }}
        run: |
          # 读取 GitHub 的更新配置文件
          if [ -f "update_config_github.json" ]; then
            echo "Reading GitHub update config..."
            
            # 转换为 Gitee 格式
            GITEE_REPO="${GITEE_REPO_OWNER}/${GITEE_REPO_NAME}"
            TAG_NAME="${{ steps.get_version.outputs.TAG_NAME }}"
            
            # 使用 jq 修改 URL
            cat update_config_github.json | jq "
              .updateCheckUrl = \"https://gitee.com/${GITEE_REPO}/raw/main/update_config_gitee.json\" |
              .client.platforms.macos.downloadUrl = (.client.platforms.macos.downloadUrl | gsub(\"github.com.*releases\"; \"gitee.com/${GITEE_REPO}/releases\")) |
              .client.platforms.windows.downloadUrl = (.client.platforms.windows.downloadUrl | gsub(\"github.com.*releases\"; \"gitee.com/${GITEE_REPO}/releases\")) |
              .server.platforms.android.downloadUrl = (.server.platforms.android.downloadUrl | gsub(\"github.com.*releases\"; \"gitee.com/${GITEE_REPO}/releases\"))
            " > update_config_gitee.json
            
            echo "Generated Gitee update config:"
            cat update_config_gitee.json
            
            # 提交到 Gitee 仓库
            git config --global user.name "GitHub Actions"
            git config --global user.email "actions@github.com"
            
            # 添加 Gitee remote（如果还没有）
            if ! git remote get-url gitee >/dev/null 2>&1; then
              git remote add gitee https://${GITEE_TOKEN}@gitee.com/${GITEE_REPO}.git
            fi
            
            # 切换到 main 分支并推送
            git fetch gitee main || true
            git checkout -b main gitee/main 2>/dev/null || git checkout main
            
            git add update_config_gitee.json
            if git diff --staged --quiet; then
              echo "No changes to commit"
            else
              git commit -m "Sync update config from GitHub Release ${TAG_NAME}"
              git push gitee main || echo "Push failed, may already be up to date"
            fi
            
            echo "✅ Update config synced to Gitee"
          else
            echo "⚠️ update_config_github.json not found, skipping config sync"
          fi

