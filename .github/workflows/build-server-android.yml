name: Build Server Android

on:
  workflow_call:  # 作为可重用工作流被调用
  workflow_dispatch:  # 允许手动触发
  push:
    tags:
      - 'build_server_android_v*'  # 向后兼容：当推送 build_server_android_v* 标签时触发

env:
  FLUTTER_VERSION: '3.24.0'

jobs:
  build-server-android:
    name: Build Server Android
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'

      - name: Get pubspec.lock hash
        id: pubspec_hash
        continue-on-error: true
        run: |
          if [ -f "server/pubspec.lock" ]; then
            HASH=$(sha256sum server/pubspec.lock | cut -d' ' -f1 | head -c 16)
            echo "hash=$HASH" >> $GITHUB_OUTPUT
          else
            echo "hash=default" >> $GITHUB_OUTPUT
          fi

      - name: Cache Flutter dependencies
        id: cache_flutter
        uses: actions/cache@v4
        continue-on-error: true
        with:
          path: |
            server/.dart_tool
            ~/.pub-cache
          key: flutter-${{ runner.os }}-server-${{ env.FLUTTER_VERSION }}-${{ steps.pubspec_hash.outputs.hash }}
          restore-keys: |
            flutter-${{ runner.os }}-server-${{ env.FLUTTER_VERSION }}-
            flutter-${{ runner.os }}-server-

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: false  # 禁用内置缓存，使用上面的手动缓存步骤

      - name: Extract and sync version
        id: get_version
        run: |
          # 安装 PyYAML
          python3 -m pip install --user pyyaml --quiet || \
          python3 -c "import yaml" 2>/dev/null || python3 -m pip install pyyaml --quiet
          
          # 使用统一的版本管理模块提取和同步版本号
          python3 scripts/lib/version_manager.py extract server --sync server/pubspec.yaml > version_output.json
          
          # 解析 JSON 输出并设置 GitHub Actions 输出
          VERSION=$(python3 -c "import json; print(json.load(open('version_output.json'))['version'])")
          BUILD_NUMBER=$(python3 -c "import json; print(json.load(open('version_output.json'))['build_number'])")
          FULL_VERSION=$(python3 -c "import json; print(json.load(open('version_output.json'))['full_version'])")
          TAG_VERSION=$(python3 -c "import json; print(json.load(open('version_output.json'))['tag_version'])")
          
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "FULL_VERSION=$FULL_VERSION" >> $GITHUB_OUTPUT
          echo "TAG_VERSION=$TAG_VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
          echo "Build Number: $BUILD_NUMBER"
          echo "Full Version: $FULL_VERSION"

      - name: Build Android APK
        run: |
          cd server
          ./scripts/build.sh --release

      - name: Rename APK with fixed name and create zip
        run: |
          cd server/build/app/outputs/flutter-apk
          # APK文件名使用固定命名，不包含版本号（版本信息由ZIP文件名和hash保证）
          APK_NAME="helloknightrcc_server_android.apk"
          # ZIP文件名包含版本号，用于标识和hash验证
          ZIP_NAME="helloknightrcc_server_android_${{ steps.get_version.outputs.FULL_VERSION }}.zip"
          
          # 重命名APK为固定名称
          mv app-release.apk "$APK_NAME"
          
          # 压缩APK为zip（zip包里包含固定命名的apk文件）
          zip "$ZIP_NAME" "$APK_NAME"
          
          # 移动到工作区根目录
          mv "$APK_NAME" $GITHUB_WORKSPACE/server/
          mv "$ZIP_NAME" $GITHUB_WORKSPACE/server/
          
          echo "APK已压缩为zip: $ZIP_NAME (contains APK file with fixed name: $APK_NAME)"

      - name: Upload version info
        uses: actions/upload-artifact@v4
        with:
          name: version-info-android
          path: |
            VERSION.yaml
            VERSION
          retention-days: 30

      - name: Upload Android ZIP artifact
        uses: actions/upload-artifact@v4
        with:
          name: helloknightrcc_server_android
          path: server/helloknightrcc_server_android_${{ steps.get_version.outputs.FULL_VERSION }}.zip
          retention-days: 30

