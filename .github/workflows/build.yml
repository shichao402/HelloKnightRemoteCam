name: Build Applications

on:
  push:
    branches: [ main, master, develop ]
    tags:
      - 'v*'  # 当推送版本标签时触发
  pull_request:
    branches: [ main, master, develop ]

jobs:
  build-client-macos:
    name: Build Client macOS
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Extract version from tag or pubspec.yaml
        id: get_version
        run: |
          cd client
          # 如果是标签触发，从标签提取版本号
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            TAG_VERSION=${GITHUB_REF#refs/tags/v}
            VERSION=$TAG_VERSION
            # 从VERSION文件读取build number，如果没有则使用1
            if [ -f "../../VERSION" ]; then
              BUILD_NUMBER=$(grep "^CLIENT_VERSION=" ../../VERSION | sed 's/.*+//' || echo "1")
            else
              BUILD_NUMBER="1"
            fi
            echo "使用标签版本号: $VERSION"
            # 同步版本号到 pubspec.yaml
            sed -i '' "s/^version:.*/version: ${VERSION}+${BUILD_NUMBER}/" pubspec.yaml
          else
            # 否则从 pubspec.yaml 读取
            VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
            BUILD_NUMBER=$(grep '^version:' pubspec.yaml | sed 's/.*+//')
            echo "使用 pubspec.yaml 版本号: $VERSION"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "FULL_VERSION=${VERSION}+${BUILD_NUMBER}" >> $GITHUB_OUTPUT
          echo "TAG_VERSION=v${VERSION}" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
          echo "Build Number: $BUILD_NUMBER"

      - name: Build macOS app
        run: |
          cd client
          ./scripts/build.sh --release --macos

      - name: Archive macOS app (zip)
        run: |
          cd client/build/macos/Build/Products/Release
          zip -r HelloKnightRCC_macos_${{ steps.get_version.outputs.FULL_VERSION }}.zip HelloKnightRCC.app
          mv HelloKnightRCC_macos_${{ steps.get_version.outputs.FULL_VERSION }}.zip $GITHUB_WORKSPACE/client/

      - name: Create macOS DMG
        run: |
          cd client/build/macos/Build/Products/Release
          APP_NAME="HelloKnightRCC.app"
          DMG_NAME="HelloKnightRCC_macos_${{ steps.get_version.outputs.FULL_VERSION }}.dmg"
          VOLUME_NAME="HelloKnightRCC"
          
          # 创建临时目录用于DMG内容
          mkdir -p dmg_temp
          cp -R "$APP_NAME" dmg_temp/
          
          # 创建DMG
          hdiutil create -volname "$VOLUME_NAME" -srcfolder dmg_temp -ov -format UDZO "$DMG_NAME"
          
          # 移动到工作区根目录
          mv "$DMG_NAME" $GITHUB_WORKSPACE/client/
          
          # 清理临时目录
          rm -rf dmg_temp
          
          echo "DMG created: $DMG_NAME"

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: HelloKnightRCC_macos
          path: |
            client/HelloKnightRCC_macos_${{ steps.get_version.outputs.FULL_VERSION }}.zip
            client/HelloKnightRCC_macos_${{ steps.get_version.outputs.FULL_VERSION }}.dmg
          retention-days: 30

  build-client-windows:
    name: Build Client Windows
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Extract version from tag or pubspec.yaml
        id: get_version
        shell: powershell
        run: |
          cd client
          # 如果是标签触发，从标签提取版本号
          $ref = "${{ github.ref }}"
          if ($ref -like "refs/tags/v*") {
            $tagVersion = $ref -replace "refs/tags/v", ""
            $version = $tagVersion
            # 从VERSION文件读取build number
            if (Test-Path "../../VERSION") {
              $versionLine = Get-Content "../../VERSION" | Select-String -Pattern "^CLIENT_VERSION="
              if ($versionLine) {
                $buildNumber = $versionLine -replace ".*\+", ""
              } else {
                $buildNumber = "1"
              }
            } else {
              $buildNumber = "1"
            }
            Write-Host "使用标签版本号: $version"
            # 同步版本号到 pubspec.yaml
            $content = Get-Content pubspec.yaml
            $content = $content -replace "^version:.*", "version: ${version}+${buildNumber}"
            $content | Set-Content pubspec.yaml
          } else {
            # 否则从 pubspec.yaml 读取
            $versionLine = Get-Content pubspec.yaml | Select-String -Pattern '^version:'
            $version = $versionLine -replace 'version: ', '' -replace '\+.*', ''
            $buildNumber = $versionLine -replace '.*\+', ''
            Write-Host "使用 pubspec.yaml 版本号: $version"
          }
          $fullVersion = "${version}+${buildNumber}"
          $tagVersion = "v${version}"
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "BUILD_NUMBER=$buildNumber" >> $env:GITHUB_OUTPUT
          echo "FULL_VERSION=$fullVersion" >> $env:GITHUB_OUTPUT
          echo "TAG_VERSION=$tagVersion" >> $env:GITHUB_OUTPUT
          Write-Host "Version: $version"
          Write-Host "Build Number: $buildNumber"

      - name: Build Windows app
        run: |
          cd client
          bash scripts/build.sh --release --windows

      - name: Install Inno Setup
        shell: powershell
        run: |
          # 使用 Chocolatey 安装 Inno Setup（如果可用），否则直接下载安装
          if (Get-Command choco -ErrorAction SilentlyContinue) {
            choco install innosetup -y
          } else {
            # 下载并安装 Inno Setup
            $innosetupUrl = "https://files.jrsoftware.org/is/6/innosetup-6.2.2.exe"
            $innosetupPath = "$env:TEMP\innosetup.exe"
            Write-Host "Downloading Inno Setup..."
            Invoke-WebRequest -Uri $innosetupUrl -OutFile $innosetupPath
            Write-Host "Installing Inno Setup..."
            Start-Process -FilePath $innosetupPath -ArgumentList "/VERYSILENT /SUPPRESSMSGBOXES /DIR=C:\Program Files (x86)\Inno Setup 6" -Wait
          }
          # 验证安装
          $isccPath = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
          if (Test-Path $isccPath) {
            Write-Host "Inno Setup installed successfully at: $isccPath"
            echo "$isccPath" >> $env:GITHUB_PATH
          } else {
            Write-Host "Error: Inno Setup not found at expected path"
            exit 1
          }

      - name: Create Inno Setup script
        shell: powershell
        run: |
          $version = "${{ steps.get_version.outputs.FULL_VERSION }}"
          $scriptContent = @"
[Setup]
AppName=HelloKnightRCC
AppVersion=$version
DefaultDirName={autopf}\HelloKnightRCC
DefaultGroupName=HelloKnightRCC
OutputDir=installer
OutputBaseFilename=HelloKnightRCC_windows_${version}_setup
Compression=lzma
SolidCompression=yes
PrivilegesRequired=admin

[Files]
Source: "client\build\windows\x64\runner\Release\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs

[Icons]
Name: "{group}\HelloKnightRCC"; Filename: "{app}\HelloKnightRCC.exe"
Name: "{autodesktop}\HelloKnightRCC"; Filename: "{app}\HelloKnightRCC.exe"; Tasks: desktopicon

[Tasks]
Name: "desktopicon"; Description: "Create a desktop shortcut"; GroupDescription: "Additional icons:"
"@
          New-Item -ItemType Directory -Force -Path "installer" | Out-Null
          $scriptContent | Out-File -FilePath "installer\setup.iss" -Encoding UTF8

      - name: Build Windows installer
        shell: powershell
        run: |
          $version = "${{ steps.get_version.outputs.FULL_VERSION }}"
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer\setup.iss
          $installerName = "HelloKnightRCC_windows_${version}_setup.exe"
          if (Test-Path "installer\$installerName") {
            Move-Item -Path "installer\$installerName" -Destination "$env:GITHUB_WORKSPACE\client\$installerName"
            Write-Host "Installer created: $installerName"
          } else {
            Write-Host "Error: Installer not found"
            Get-ChildItem -Path "installer" | ForEach-Object { Write-Host $_.FullName }
            exit 1
          }

      - name: Upload Windows installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: HelloKnightRCC_windows
          path: client/HelloKnightRCC_windows_${{ steps.get_version.outputs.FULL_VERSION }}_setup.exe
          retention-days: 30

  build-server-android:
    name: Build Server Android
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Extract version from pubspec.yaml
        id: get_version
        run: |
          cd server
          VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
          BUILD_NUMBER=$(grep '^version:' pubspec.yaml | sed 's/.*+//')
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "FULL_VERSION=${VERSION}+${BUILD_NUMBER}" >> $GITHUB_OUTPUT
          echo "TAG_VERSION=v${VERSION}" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
          echo "Build Number: $BUILD_NUMBER"

      - name: Build Android APK
        run: |
          cd server
          ./scripts/build.sh --release

      - name: Rename APK with version
        run: |
          cd server/build/app/outputs/flutter-apk
          mv app-release.apk helloknightrcc_server_android_${{ steps.get_version.outputs.FULL_VERSION }}.apk
          mv helloknightrcc_server_android_${{ steps.get_version.outputs.FULL_VERSION }}.apk $GITHUB_WORKSPACE/server/

      - name: Upload Android APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: helloknightrcc_server_android
          path: server/helloknightrcc_server_android_${{ steps.get_version.outputs.FULL_VERSION }}.apk
          retention-days: 30

  create-release:
    name: Create Release
    needs: [build-client-macos, build-client-windows, build-server-android]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
      repository-projects: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Extract version from tag
        id: get_tag_version
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/}
          VERSION=${TAG_VERSION#v}
          echo "TAG_VERSION=$TAG_VERSION" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Tag Version: $TAG_VERSION"
          echo "Version: $VERSION"

      - name: Extract client version from pubspec.yaml
        id: get_client_version
        run: |
          cd client
          PUBSPEC_VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
          BUILD_NUMBER=$(grep '^version:' pubspec.yaml | sed 's/.*+//')
          # 如果是从标签触发，优先使用标签版本号；否则使用 pubspec.yaml 中的版本号
          TAG_VERSION=${{ steps.get_tag_version.outputs.VERSION }}
          if [ -n "$TAG_VERSION" ] && [ "$TAG_VERSION" != "" ]; then
            VERSION=$TAG_VERSION
            echo "使用标签版本号: $VERSION"
          else
            VERSION=$PUBSPEC_VERSION
            echo "使用 pubspec.yaml 版本号: $VERSION"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "FULL_VERSION=${VERSION}+${BUILD_NUMBER}" >> $GITHUB_OUTPUT

      - name: Extract server version from pubspec.yaml
        id: get_server_version
        run: |
          cd server
          PUBSPEC_VERSION=$(grep '^version:' pubspec.yaml | sed 's/version: //' | sed 's/+.*//')
          BUILD_NUMBER=$(grep '^version:' pubspec.yaml | sed 's/.*+//')
          # 如果是从标签触发，优先使用标签版本号；否则使用 pubspec.yaml 中的版本号
          TAG_VERSION=${{ steps.get_tag_version.outputs.VERSION }}
          if [ -n "$TAG_VERSION" ] && [ "$TAG_VERSION" != "" ]; then
            VERSION=$TAG_VERSION
            echo "使用标签版本号: $VERSION"
          else
            VERSION=$PUBSPEC_VERSION
            echo "使用 pubspec.yaml 版本号: $VERSION"
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "FULL_VERSION=${VERSION}+${BUILD_NUMBER}" >> $GITHUB_OUTPUT

      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: HelloKnightRCC_macos
          path: ./artifacts-temp

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: HelloKnightRCC_windows
          path: ./artifacts-temp

      - name: Download Android artifact
        uses: actions/download-artifact@v4
        with:
          name: helloknightrcc_server_android
          path: ./artifacts-temp

      - name: Flatten artifacts structure
        run: |
          mkdir -p artifacts
          # 查找并移动所有构建产物到统一的 artifacts 目录
          find ./artifacts-temp -name "HelloKnightRCC_macos_*.zip" -exec mv {} ./artifacts/ \;
          find ./artifacts-temp -name "HelloKnightRCC_macos_*.dmg" -exec mv {} ./artifacts/ \;
          find ./artifacts-temp -name "HelloKnightRCC_windows_*_setup.exe" -exec mv {} ./artifacts/ \;
          find ./artifacts-temp -name "helloknightrcc_server_android_*.apk" -exec mv {} ./artifacts/ \;
          rm -rf ./artifacts-temp

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_tag_version.outputs.TAG_VERSION }}
          name: Release ${{ steps.get_tag_version.outputs.VERSION }}
          body: |
            ## Release ${{ steps.get_tag_version.outputs.VERSION }}

            ### Client
            - **macOS**: 
              - DMG: HelloKnightRCC_macos_${{ steps.get_client_version.outputs.FULL_VERSION }}.dmg (推荐)
              - ZIP: HelloKnightRCC_macos_${{ steps.get_client_version.outputs.FULL_VERSION }}.zip
            - **Windows**: HelloKnightRCC_windows_${{ steps.get_client_version.outputs.FULL_VERSION }}_setup.exe

            ### Server
            - **Android**: helloknightrcc_server_android_${{ steps.get_server_version.outputs.FULL_VERSION }}.apk

            ### Changes
            - See commit history for details
          files: |
            artifacts/HelloKnightRCC_macos_*.zip
            artifacts/HelloKnightRCC_macos_*.dmg
            artifacts/HelloKnightRCC_windows_*_setup.exe
            artifacts/helloknightrcc_server_android_*.apk
          draft: false
          prerelease: false

      # 生成 GitHub 更新配置文件
      - name: Generate GitHub Update Config
        run: |
          CLIENT_VERSION=${{ steps.get_client_version.outputs.FULL_VERSION }}
          CLIENT_VERSION_NUMBER=${{ steps.get_client_version.outputs.VERSION }}
          SERVER_VERSION=${{ steps.get_server_version.outputs.FULL_VERSION }}
          SERVER_VERSION_NUMBER=${{ steps.get_server_version.outputs.VERSION }}
          TAG_VERSION=${{ steps.get_tag_version.outputs.TAG_VERSION }}
          
          # GitHub Releases 下载链接格式
          GITHUB_REPO="shichao402/HelloKnightRemoteCam"
          BASE_URL="https://github.com/${GITHUB_REPO}/releases/download/${TAG_VERSION}"
          
          # 获取实际的文件名（从 artifacts 目录）
          MACOS_FILE=$(find artifacts -name "HelloKnightRCC_macos_*.dmg" -exec basename {} \; | head -1)
          WINDOWS_FILE=$(find artifacts -name "HelloKnightRCC_windows_*_setup.exe" -exec basename {} \; | head -1)
          ANDROID_FILE=$(find artifacts -name "helloknightrcc_server_android_*.apk" -exec basename {} \; | head -1)
          
          cat > update_config_github.json <<EOF
          {
            "client": {
              "version": "${CLIENT_VERSION}",
              "versionNumber": "${CLIENT_VERSION_NUMBER}",
              "platforms": {
                "macos": {
                  "version": "${CLIENT_VERSION}",
                  "versionNumber": "${CLIENT_VERSION_NUMBER}",
                  "downloadUrl": "${BASE_URL}/${MACOS_FILE}",
                  "fileName": "${MACOS_FILE}",
                  "fileType": "dmg",
                  "platform": "macos"
                },
                "windows": {
                  "version": "${CLIENT_VERSION}",
                  "versionNumber": "${CLIENT_VERSION_NUMBER}",
                  "downloadUrl": "${BASE_URL}/${WINDOWS_FILE}",
                  "fileName": "${WINDOWS_FILE}",
                  "fileType": "exe",
                  "platform": "windows"
                }
              }
            },
            "server": {
              "version": "${SERVER_VERSION}",
              "versionNumber": "${SERVER_VERSION_NUMBER}",
              "platforms": {
                "android": {
                  "version": "${SERVER_VERSION}",
                  "versionNumber": "${SERVER_VERSION_NUMBER}",
                  "downloadUrl": "${BASE_URL}/${ANDROID_FILE}",
                  "fileName": "${ANDROID_FILE}",
                  "fileType": "apk",
                  "platform": "android"
                }
              }
            },
            "updateCheckUrl": "https://raw.githubusercontent.com/${GITHUB_REPO}/main/update_config_github.json",
            "lastUpdated": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          }
          EOF
          
          echo "GitHub 更新配置文件已生成:"
          cat update_config_github.json

      - name: Commit and Push GitHub Update Config
        run: |
          # 配置 Git
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # 从标签切换到 main 分支
          git fetch origin main
          git checkout -b main origin/main || git checkout main
          
          # 添加并提交更新配置文件
          git add update_config_github.json
          if git diff --staged --quiet; then
            echo "没有更改，跳过提交"
          else
            git commit -m "发布版本 ${{ steps.get_tag_version.outputs.VERSION }} - 更新 GitHub 自动更新配置"
            git push origin main || echo "推送失败，可能已是最新版本"
          fi
