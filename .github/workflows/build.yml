name: Build Applications

on:
  push:
    branches: [ main, master, develop ]
    tags:
      - 'v*'  # 当推送版本标签时触发
  pull_request:
    branches: [ main, master, develop ]

jobs:
  build-client-macos:
    name: Build Client macOS
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # 只获取最新提交，加快 checkout

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.local/lib/python3.*/site-packages
          key: python-${{ runner.os }}-pyyaml-1.0
          restore-keys: |
            python-${{ runner.os }}-pyyaml-

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: false

      - name: Cache Flutter dependencies
        id: cache_flutter
        uses: actions/cache@v4
        continue-on-error: true
        with:
          path: |
            client/.dart_tool
            ~/.pub-cache
          key: flutter-${{ runner.os }}-client-${{ hashFiles('client/pubspec.lock') }}
          restore-keys: |
            flutter-${{ runner.os }}-client-

      - name: Extract and sync version
        id: get_version
        run: |
          # 安装 PyYAML（如果需要，优先使用缓存）
          # macOS 需要 --break-system-packages 标志
          python3 -c "import yaml" 2>/dev/null || \
          python3 -m pip install --user --break-system-packages pyyaml --quiet || \
          python3 -m pip install --break-system-packages pyyaml --quiet
          
          # 使用统一的版本管理模块提取和同步版本号
          python3 scripts/lib/version_manager.py extract client --sync client/pubspec.yaml > version_output.json
          
          # 解析 JSON 输出并设置 GitHub Actions 输出
          VERSION=$(python3 -c "import json; print(json.load(open('version_output.json'))['version'])")
          BUILD_NUMBER=$(python3 -c "import json; print(json.load(open('version_output.json'))['build_number'])")
          FULL_VERSION=$(python3 -c "import json; print(json.load(open('version_output.json'))['full_version'])")
          TAG_VERSION=$(python3 -c "import json; print(json.load(open('version_output.json'))['tag_version'])")
          
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "FULL_VERSION=$FULL_VERSION" >> $GITHUB_OUTPUT
          echo "TAG_VERSION=$TAG_VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
          echo "Build Number: $BUILD_NUMBER"
          echo "Full Version: $FULL_VERSION"

      - name: Build macOS app
        run: |
          cd client
          ./scripts/build.sh --release --macos

      - name: Create macOS DMG
        run: |
          cd client/build/macos/Build/Products/Release
          APP_NAME="HelloKnightRCC.app"
          DMG_NAME="HelloKnightRCC_macos_${{ steps.get_version.outputs.FULL_VERSION }}.dmg"
          VOLUME_NAME="HelloKnightRCC"
          
          # 创建临时目录用于DMG内容
          mkdir -p dmg_temp
          cp -R "$APP_NAME" dmg_temp/
          
          # 创建指向Applications文件夹的快捷方式（符号链接）
          ln -s /Applications dmg_temp/Applications
          
          # 创建临时DMG（可读写）
          TEMP_DMG="temp_$DMG_NAME"
          hdiutil create -volname "$VOLUME_NAME" -srcfolder dmg_temp -ov -format UDRW "$TEMP_DMG"
          
          # 挂载DMG以设置视图属性
          DMG_DEVICE=$(hdiutil attach -readwrite -noverify -noautoopen "$TEMP_DMG" | egrep '^/dev/' | sed 1q | awk '{print $1}')
          
          # 等待DMG挂载
          sleep 2
          
          DMG_MOUNT_POINT="/Volumes/$VOLUME_NAME"
          if [ -d "$DMG_MOUNT_POINT" ]; then
            # 设置Applications快捷方式的属性（使其显示为快捷方式图标）
            if command -v SetFile &> /dev/null; then
              SetFile -a C "$DMG_MOUNT_POINT/Applications" || true
            fi
            
            # 尝试设置DMG窗口视图（如果支持图形界面）
            # 注意：在CI环境中可能无法执行AppleScript，但不影响DMG的功能
            osascript -e 'tell application "Finder"' \
              -e "  tell disk \"$VOLUME_NAME\"" \
              -e '    open' \
              -e '    set current view of container window to icon view' \
              -e '    set toolbar visible of container window to false' \
              -e '    set statusbar visible of container window to false' \
              -e '    set the bounds of container window to {400, 100, 920, 420}' \
              -e '    set viewOptions to the icon view options of container window' \
              -e '    set arrangement of viewOptions to not arranged' \
              -e '    set icon size of viewOptions to 72' \
              -e "    set position of item \"$APP_NAME\" of container window to {160, 205}" \
              -e '    set position of item "Applications" of container window to {360, 205}' \
              -e '    close' \
              -e '    open' \
              -e '    update without registering applications' \
              -e '    delay 2' \
              -e '  end tell' \
              -e 'end tell' 2>/dev/null || true
          fi
          
          # 卸载DMG
          hdiutil detach "$DMG_DEVICE" || true
          
          # 转换为只读压缩格式
          hdiutil convert "$TEMP_DMG" -format UDZO -o "$DMG_NAME" -ov
          
          # 删除临时DMG
          rm -f "$TEMP_DMG"
          
          # 移动到工作区根目录
          mv "$DMG_NAME" $GITHUB_WORKSPACE/client/
          
          # 清理临时目录
          rm -rf dmg_temp
          
          echo "DMG created: $DMG_NAME (with Applications shortcut)"

      - name: Archive macOS DMG (zip)
        run: |
          cd $GITHUB_WORKSPACE/client
          DMG_NAME="HelloKnightRCC_macos_${{ steps.get_version.outputs.FULL_VERSION }}.dmg"
          ZIP_NAME="HelloKnightRCC_macos_${{ steps.get_version.outputs.FULL_VERSION }}.zip"
          
          # 将DMG文件打包成zip（zip包里包含dmg文件）
          zip "$ZIP_NAME" "$DMG_NAME"
          
          echo "macOS ZIP created: $ZIP_NAME (contains DMG file)"

      - name: Upload version info
        uses: actions/upload-artifact@v4
        with:
          name: version-info-macos
          path: |
            VERSION.yaml
            VERSION
          retention-days: 30

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: HelloKnightRCC_macos
          path: |
            client/HelloKnightRCC_macos_${{ steps.get_version.outputs.FULL_VERSION }}.zip
          retention-days: 30


  build-client-windows:
    name: Build Client Windows
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # 只获取最新提交，加快 checkout

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: |
            $env:APPDATA\Python\Python*\site-packages
            $env:LOCALAPPDATA\pip\Cache
          key: python-windows-pyyaml-1.0
          restore-keys: |
            python-windows-pyyaml-

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: false

      - name: Cache Flutter dependencies
        id: cache_flutter
        uses: actions/cache@v4
        continue-on-error: true
        with:
          path: |
            client/.dart_tool
            $env:APPDATA\Pub\Cache
          key: flutter-windows-client-${{ hashFiles('client/pubspec.lock') }}
          restore-keys: |
            flutter-windows-client-

      - name: Extract and sync version
        id: get_version
        run: |
          # 安装 PyYAML（如果需要，优先使用缓存）
          # Windows PowerShell 语法
          $ErrorActionPreference = "SilentlyContinue"
          python -c "import yaml" 2>$null
          if ($LASTEXITCODE -ne 0) {
            python -m pip install --user pyyaml --quiet
          }
          $ErrorActionPreference = "Continue"
          
          # 使用统一的版本管理模块提取和同步版本号
          python scripts/lib/version_manager.py extract client --sync client/pubspec.yaml > version_output.json
          
          # 解析 JSON 输出并设置 GitHub Actions 输出
          $versionInfo = Get-Content version_output.json | ConvertFrom-Json
          echo "VERSION=$($versionInfo.version)" >> $env:GITHUB_OUTPUT
          echo "BUILD_NUMBER=$($versionInfo.build_number)" >> $env:GITHUB_OUTPUT
          echo "FULL_VERSION=$($versionInfo.full_version)" >> $env:GITHUB_OUTPUT
          echo "TAG_VERSION=$($versionInfo.tag_version)" >> $env:GITHUB_OUTPUT
          Write-Host "Version: $($versionInfo.version)"
          Write-Host "Build Number: $($versionInfo.build_number)"
          Write-Host "Full Version: $($versionInfo.full_version)"

      - name: Build Windows app
        run: |
          cd client
          bash scripts/build.sh --release --windows

      - name: Install Inno Setup
        shell: powershell
        run: |
          # 使用 Chocolatey 安装 Inno Setup（如果可用），否则直接下载安装
          if (Get-Command choco -ErrorAction SilentlyContinue) {
            choco install innosetup -y
          } else {
            # 下载并安装 Inno Setup
            $innosetupUrl = "https://files.jrsoftware.org/is/6/innosetup-6.2.2.exe"
            $innosetupPath = "$env:TEMP\innosetup.exe"
            Write-Host "Downloading Inno Setup..."
            Invoke-WebRequest -Uri $innosetupUrl -OutFile $innosetupPath
            Write-Host "Installing Inno Setup..."
            Start-Process -FilePath $innosetupPath -ArgumentList "/VERYSILENT /SUPPRESSMSGBOXES /DIR=C:\Program Files (x86)\Inno Setup 6" -Wait
          }
          # 验证安装
          $isccPath = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
          if (Test-Path $isccPath) {
            Write-Host "Inno Setup installed successfully at: $isccPath"
            echo "$isccPath" >> $env:GITHUB_PATH
          } else {
            Write-Host "Error: Inno Setup not found at expected path"
            exit 1
          }

      - name: Create Inno Setup script
        shell: powershell
        run: |
          $version = "${{ steps.get_version.outputs.FULL_VERSION }}"
          # 获取构建产物的绝对路径
          $buildPath = Resolve-Path "client\build\windows\x64\runner\Release"
          # 获取工作区根目录的绝对路径
          $workspaceRoot = $env:GITHUB_WORKSPACE
          $scriptContent = @'
          [Setup]
          AppName=HelloKnightRCC
          AppVersion=PLACEHOLDER_VERSION
          DefaultDirName={autopf}\HelloKnightRCC
          DefaultGroupName=HelloKnightRCC
          OutputDir=PLACEHOLDER_WORKSPACE_ROOT
          OutputBaseFilename=HelloKnightRCC_windows_PLACEHOLDER_VERSION_setup
          Compression=lzma
          SolidCompression=yes
          PrivilegesRequired=admin
          
          [Files]
          Source: "PLACEHOLDER_BUILD_PATH\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs
          
          [Icons]
          Name: "{group}\HelloKnightRCC"; Filename: "{app}\HelloKnightRCC.exe"
          Name: "{autodesktop}\HelloKnightRCC"; Filename: "{app}\HelloKnightRCC.exe"; Tasks: desktopicon
          
          [Tasks]
          Name: "desktopicon"; Description: "Create a desktop shortcut"; GroupDescription: "Additional icons:"
          '@
          # 替换占位符
          $scriptContent = $scriptContent -replace 'PLACEHOLDER_VERSION', $version
          $scriptContent = $scriptContent -replace 'PLACEHOLDER_BUILD_PATH', $buildPath
          $scriptContent = $scriptContent -replace 'PLACEHOLDER_WORKSPACE_ROOT', $workspaceRoot
          New-Item -ItemType Directory -Force -Path "installer" | Out-Null
          $scriptContent | Out-File -FilePath "installer\setup.iss" -Encoding UTF8
          Write-Host "Inno Setup script created with build path: $buildPath"
          Write-Host "Output directory: $workspaceRoot"

      - name: Build Windows installer
        shell: powershell
        run: |
          $version = "${{ steps.get_version.outputs.FULL_VERSION }}"
          $installerName = "HelloKnightRCC_windows_${version}_setup.exe"
          # 编译 Inno Setup 脚本
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer\setup.iss
          # 安装程序应该在工作区根目录
          if (Test-Path "$env:GITHUB_WORKSPACE\$installerName") {
            Move-Item -Path "$env:GITHUB_WORKSPACE\$installerName" -Destination "$env:GITHUB_WORKSPACE\client\$installerName"
            Write-Host "Installer created: $installerName"
          } elseif (Test-Path "installer\$installerName") {
            Move-Item -Path "installer\$installerName" -Destination "$env:GITHUB_WORKSPACE\client\$installerName"
            Write-Host "Installer created: $installerName"
          } elseif (Test-Path "installer\installer\$installerName") {
            Move-Item -Path "installer\installer\$installerName" -Destination "$env:GITHUB_WORKSPACE\client\$installerName"
            Write-Host "Installer created: $installerName"
          } else {
            Write-Host "Error: Installer not found"
            Write-Host "Searching in: $env:GITHUB_WORKSPACE"
            Get-ChildItem -Path "$env:GITHUB_WORKSPACE" -Filter "*$installerName" -Recurse -ErrorAction SilentlyContinue | ForEach-Object { Write-Host $_.FullName }
            exit 1
          }

      - name: Upload Windows installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: HelloKnightRCC_windows
          path: client/HelloKnightRCC_windows_${{ steps.get_version.outputs.FULL_VERSION }}_setup.exe
          retention-days: 30


  build-server-android:
    name: Build Server Android
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # 只获取最新提交，加快 checkout

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.local/lib/python3.*/site-packages
          key: python-linux-pyyaml-1.0
          restore-keys: |
            python-linux-pyyaml-

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
          cache: 'gradle'  # 启用 Gradle 缓存

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: false

      - name: Cache Flutter dependencies
        id: cache_flutter
        uses: actions/cache@v4
        continue-on-error: true
        with:
          path: |
            server/.dart_tool
            ~/.pub-cache
          key: flutter-${{ runner.os }}-server-${{ hashFiles('server/pubspec.lock') }}
          restore-keys: |
            flutter-${{ runner.os }}-server-

      - name: Extract and sync version
        id: get_version
        run: |
          # 安装 PyYAML（如果需要，优先使用缓存）
          # Linux 上使用 --user 即可
          python3 -m pip install --user pyyaml --quiet || \
          python3 -c "import yaml" 2>/dev/null || python3 -m pip install pyyaml --quiet
          
          # 使用统一的版本管理模块提取和同步版本号
          python3 scripts/lib/version_manager.py extract server --sync server/pubspec.yaml > version_output.json
          
          # 解析 JSON 输出并设置 GitHub Actions 输出
          VERSION=$(python3 -c "import json; print(json.load(open('version_output.json'))['version'])")
          BUILD_NUMBER=$(python3 -c "import json; print(json.load(open('version_output.json'))['build_number'])")
          FULL_VERSION=$(python3 -c "import json; print(json.load(open('version_output.json'))['full_version'])")
          TAG_VERSION=$(python3 -c "import json; print(json.load(open('version_output.json'))['tag_version'])")
          
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "FULL_VERSION=$FULL_VERSION" >> $GITHUB_OUTPUT
          echo "TAG_VERSION=$TAG_VERSION" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
          echo "Build Number: $BUILD_NUMBER"
          echo "Full Version: $FULL_VERSION"

      - name: Build Android APK
        run: |
          cd server
          ./scripts/build.sh --release

      - name: Rename APK with version and create zip
        run: |
          cd server/build/app/outputs/flutter-apk
          APK_NAME="helloknightrcc_server_android_${{ steps.get_version.outputs.FULL_VERSION }}.apk"
          ZIP_NAME="helloknightrcc_server_android_${{ steps.get_version.outputs.FULL_VERSION }}.zip"
          
          # 重命名APK
          mv app-release.apk "$APK_NAME"
          
          # 压缩APK为zip
          zip "$ZIP_NAME" "$APK_NAME"
          
          # 移动到工作区根目录
          mv "$APK_NAME" $GITHUB_WORKSPACE/server/
          mv "$ZIP_NAME" $GITHUB_WORKSPACE/server/
          
          echo "APK已压缩为zip: $ZIP_NAME"

      - name: Upload version info
        uses: actions/upload-artifact@v4
        with:
          name: version-info-android
          path: |
            VERSION.yaml
            VERSION
          retention-days: 30

      - name: Upload Android ZIP artifact
        uses: actions/upload-artifact@v4
        with:
          name: helloknightrcc_server_android
          path: server/helloknightrcc_server_android_${{ steps.get_version.outputs.FULL_VERSION }}.zip
          retention-days: 30

  increment-version:
    name: Increment Version
    needs: [build-client-macos, build-client-windows, build-server-android]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/develop')
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1  # 只获取最新提交，加快 checkout

      - name: Increment build numbers
        id: increment_version
        run: |
          # 配置 Git
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # 安装 PyYAML（如果需要）
          # macOS/Linux 需要处理 externally-managed-environment
          python3 -c "import yaml" 2>/dev/null || \
          python3 -m pip install --user --break-system-packages pyyaml --quiet || \
          python3 -m pip install --break-system-packages pyyaml --quiet || \
          python3 -m pip install --user pyyaml --quiet || true
          
          # 读取当前版本号并递增构建号
          if [ -f "VERSION.yaml" ]; then
            # 使用统一的版本管理模块递增构建号
            NEW_CLIENT_VERSION=$(python3 scripts/lib/version_manager.py bump client build)
            NEW_SERVER_VERSION=$(python3 scripts/lib/version_manager.py bump server build)
            
            echo "客户端构建号已递增: → ${NEW_CLIENT_VERSION}"
            echo "服务器构建号已递增: → ${NEW_SERVER_VERSION}"
            
            # 输出新版本号
            echo "CLIENT_VERSION=${NEW_CLIENT_VERSION}" >> $GITHUB_OUTPUT
            echo "SERVER_VERSION=${NEW_SERVER_VERSION}" >> $GITHUB_OUTPUT
            echo "更新后的 VERSION.yaml 文件:"
            cat VERSION.yaml
          elif [ -f "VERSION" ]; then
            # 兼容旧格式
            CLIENT_VERSION=$(grep "^CLIENT_VERSION=" VERSION | cut -d'=' -f2 | tr -d '[:space:]')
            CLIENT_VERSION_NUM=$(echo "$CLIENT_VERSION" | sed 's/+.*//')
            CLIENT_BUILD_NUMBER=$(echo "$CLIENT_VERSION" | sed 's/.*+//')
            if [ "$CLIENT_VERSION" == "$CLIENT_VERSION_NUM" ]; then
              CLIENT_BUILD_NUMBER="1"
            fi
            CLIENT_BUILD_NUMBER=$((CLIENT_BUILD_NUMBER + 1))
            NEW_CLIENT_VERSION="${CLIENT_VERSION_NUM}+${CLIENT_BUILD_NUMBER}"
            sed -i "s/^CLIENT_VERSION=.*/CLIENT_VERSION=${NEW_CLIENT_VERSION}/" VERSION
            
            SERVER_VERSION=$(grep "^SERVER_VERSION=" VERSION | cut -d'=' -f2 | tr -d '[:space:]')
            SERVER_VERSION_NUM=$(echo "$SERVER_VERSION" | sed 's/+.*//')
            SERVER_BUILD_NUMBER=$(echo "$SERVER_VERSION" | sed 's/.*+//')
            if [ "$SERVER_VERSION" == "$SERVER_VERSION_NUM" ]; then
              SERVER_BUILD_NUMBER="1"
            fi
            SERVER_BUILD_NUMBER=$((SERVER_BUILD_NUMBER + 1))
            NEW_SERVER_VERSION="${SERVER_VERSION_NUM}+${SERVER_BUILD_NUMBER}"
            sed -i "s/^SERVER_VERSION=.*/SERVER_VERSION=${NEW_SERVER_VERSION}/" VERSION
            
            echo "CLIENT_VERSION=${NEW_CLIENT_VERSION}" >> $GITHUB_OUTPUT
            echo "SERVER_VERSION=${NEW_SERVER_VERSION}" >> $GITHUB_OUTPUT
            echo "更新后的 VERSION 文件（旧格式）:"
            cat VERSION
          else
            echo "错误: VERSION.yaml 文件不存在"
            exit 1
          fi

      - name: Commit and push version increment
        run: |
          # 安装 PyYAML（如果需要）
          # macOS/Linux 需要处理 externally-managed-environment
          python3 -c "import yaml" 2>/dev/null || \
          python3 -m pip install --user --break-system-packages pyyaml --quiet || \
          python3 -m pip install --break-system-packages pyyaml --quiet || \
          python3 -m pip install --user pyyaml --quiet || true
          
          if [ -f "VERSION.yaml" ]; then
            git add VERSION.yaml
            # 使用统一的版本管理模块读取版本号
            CLIENT_VERSION=$(python3 scripts/lib/version_manager.py extract client --json | python3 -c "import json, sys; print(json.load(sys.stdin)['full_version'])")
            SERVER_VERSION=$(python3 scripts/lib/version_manager.py extract server --json | python3 -c "import json, sys; print(json.load(sys.stdin)['full_version'])")
          elif [ -f "VERSION" ]; then
            git add VERSION
            CLIENT_VERSION=$(grep "^CLIENT_VERSION=" VERSION | cut -d'=' -f2 | tr -d '[:space:]')
            SERVER_VERSION=$(grep "^SERVER_VERSION=" VERSION | cut -d'=' -f2 | tr -d '[:space:]')
          fi
          
          if git diff --staged --quiet; then
            echo "没有更改，跳过提交"
          else
            git commit -m "构建版本 ${CLIENT_VERSION}/${SERVER_VERSION} - 自动递增构建号"
            git push origin HEAD:${{ github.ref_name }} || echo "推送失败，可能已是最新版本"
          fi

  create-release:
    name: Create Release
    needs: [build-client-macos, build-client-windows, build-server-android]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
      repository-projects: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 1  # 只获取最新提交，加快 checkout  # 需要完整历史以计算 hashFiles

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.local/lib/python3.*/site-packages
          key: python-linux-pyyaml-1.0
          restore-keys: |
            python-linux-pyyaml-

      - name: Extract versions from VERSION.yaml file
        id: get_versions
        run: |
          # 安装 PyYAML（如果需要，优先使用缓存）
          # macOS/Linux 需要处理 externally-managed-environment
          python3 -c "import yaml" 2>/dev/null || \
          python3 -m pip install --user --break-system-packages pyyaml --quiet || \
          python3 -m pip install --break-system-packages pyyaml --quiet || \
          python3 -m pip install --user pyyaml --quiet || true
          
          # 使用统一的版本管理模块提取版本号
          python3 scripts/lib/version_manager.py extract client --json > client_version.json
          python3 scripts/lib/version_manager.py extract server --json > server_version.json
          
          # 解析 JSON 输出并设置 GitHub Actions 输出
          CLIENT_VERSION_NUM=$(python3 -c "import json; print(json.load(open('client_version.json'))['version'])")
          CLIENT_BUILD_NUMBER=$(python3 -c "import json; print(json.load(open('client_version.json'))['build_number'])")
          CLIENT_FULL_VERSION=$(python3 -c "import json; print(json.load(open('client_version.json'))['full_version'])")
          
          SERVER_VERSION_NUM=$(python3 -c "import json; print(json.load(open('server_version.json'))['version'])")
          SERVER_BUILD_NUMBER=$(python3 -c "import json; print(json.load(open('server_version.json'))['build_number'])")
          SERVER_FULL_VERSION=$(python3 -c "import json; print(json.load(open('server_version.json'))['full_version'])")
          
          # 使用客户端版本号生成tag（客户端和服务器版本号应该一致）
          TAG_VERSION="v${CLIENT_VERSION_NUM}"
          
          echo "CLIENT_VERSION=${CLIENT_FULL_VERSION}" >> $GITHUB_OUTPUT
          echo "CLIENT_VERSION_NUM=${CLIENT_VERSION_NUM}" >> $GITHUB_OUTPUT
          echo "CLIENT_BUILD_NUMBER=${CLIENT_BUILD_NUMBER}" >> $GITHUB_OUTPUT
          echo "CLIENT_FULL_VERSION=${CLIENT_FULL_VERSION}" >> $GITHUB_OUTPUT
          
          echo "SERVER_VERSION=${SERVER_FULL_VERSION}" >> $GITHUB_OUTPUT
          echo "SERVER_VERSION_NUM=${SERVER_VERSION_NUM}" >> $GITHUB_OUTPUT
          echo "SERVER_BUILD_NUMBER=${SERVER_BUILD_NUMBER}" >> $GITHUB_OUTPUT
          echo "SERVER_FULL_VERSION=${SERVER_FULL_VERSION}" >> $GITHUB_OUTPUT
          
          echo "TAG_VERSION=${TAG_VERSION}" >> $GITHUB_OUTPUT
          echo "RELEASE_VERSION=${CLIENT_VERSION_NUM}" >> $GITHUB_OUTPUT
          
          echo "客户端版本: ${CLIENT_FULL_VERSION}"
          echo "服务器版本: ${SERVER_FULL_VERSION}"

      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: HelloKnightRCC_macos
          path: ./artifacts-temp

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: HelloKnightRCC_windows
          path: ./artifacts-temp

      - name: Download Android artifact
        uses: actions/download-artifact@v4
        with:
          name: helloknightrcc_server_android
          path: ./artifacts-temp

      - name: Flatten artifacts structure and rename with correct version
        run: |
          mkdir -p artifacts
          
          # 使用传递的版本号（从VERSION文件获取）
          CLIENT_VERSION="${{ steps.get_versions.outputs.CLIENT_FULL_VERSION }}"
          SERVER_VERSION="${{ steps.get_versions.outputs.SERVER_FULL_VERSION }}"
          
          echo "使用版本号重命名文件:"
          echo "  CLIENT_VERSION=$CLIENT_VERSION"
          echo "  SERVER_VERSION=$SERVER_VERSION"
          
          # macOS文件 - zip文件（zip包里包含dmg文件）
          MACOS_ZIP=$(find ./artifacts-temp -name "HelloKnightRCC_macos_*.zip" | head -1)
          if [ -n "$MACOS_ZIP" ]; then
            mv "$MACOS_ZIP" "./artifacts/HelloKnightRCC_macos_${CLIENT_VERSION}.zip"
            echo "重命名macOS ZIP: $(basename "$MACOS_ZIP") -> HelloKnightRCC_macos_${CLIENT_VERSION}.zip"
            echo "注意: macOS ZIP文件包含DMG文件，用户需要解压后打开DMG安装"
          else
            echo "警告: 未找到macOS ZIP文件"
          fi
          
          # Windows文件 - 需要从exe创建zip用于更新
          # 注意：Windows构建只生成exe，需要将其打包为zip
          WINDOWS_EXE=$(find ./artifacts-temp -name "HelloKnightRCC_windows_*_setup.exe" | head -1)
          if [ -n "$WINDOWS_EXE" ]; then
            # 将EXE打包为zip用于更新
            cd artifacts-temp
            zip "../artifacts/HelloKnightRCC_windows_${CLIENT_VERSION}.zip" "$(basename "$WINDOWS_EXE")"
            cd ..
            echo "已创建Windows更新zip: HelloKnightRCC_windows_${CLIENT_VERSION}.zip"
          else
            echo "警告: 未找到Windows EXE文件"
          fi
          
          # Android文件 - 查找并重命名（已经是zip文件）
          ANDROID_ZIP=$(find ./artifacts-temp -name "helloknightrcc_server_android_*.zip" | head -1)
          if [ -n "$ANDROID_ZIP" ]; then
            mv "$ANDROID_ZIP" "./artifacts/helloknightrcc_server_android_${SERVER_VERSION}.zip"
            echo "重命名Android ZIP: $(basename "$ANDROID_ZIP") -> helloknightrcc_server_android_${SERVER_VERSION}.zip"
          else
            echo "警告: 未找到Android ZIP文件"
          fi
          
          rm -rf ./artifacts-temp
          
          echo ""
          echo "重命名后的文件列表（仅zip文件）:"
          ls -la artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_versions.outputs.TAG_VERSION }}
          name: Release ${{ steps.get_versions.outputs.RELEASE_VERSION }}
          body: |
            ## Release ${{ steps.get_versions.outputs.RELEASE_VERSION }}

            ### Client
            - **macOS**: HelloKnightRCC_macos_${{ steps.get_versions.outputs.CLIENT_FULL_VERSION }}.zip
            - **Windows**: HelloKnightRCC_windows_${{ steps.get_versions.outputs.CLIENT_FULL_VERSION }}.zip

            ### Server
            - **Android**: helloknightrcc_server_android_${{ steps.get_versions.outputs.SERVER_FULL_VERSION }}.zip

            ### Changes
            - See commit history for details
          files: |
            artifacts/HelloKnightRCC_macos_${{ steps.get_versions.outputs.CLIENT_FULL_VERSION }}.zip
            artifacts/HelloKnightRCC_windows_${{ steps.get_versions.outputs.CLIENT_FULL_VERSION }}.zip
            artifacts/helloknightrcc_server_android_${{ steps.get_versions.outputs.SERVER_FULL_VERSION }}.zip
          draft: false
          prerelease: false

      # 计算文件hash并生成 GitHub 更新配置文件
      - name: Calculate File Hashes and Generate GitHub Update Config
        run: |
          CLIENT_VERSION=${{ steps.get_versions.outputs.CLIENT_FULL_VERSION }}
          CLIENT_VERSION_NUMBER=${{ steps.get_versions.outputs.CLIENT_VERSION_NUM }}
          SERVER_VERSION=${{ steps.get_versions.outputs.SERVER_FULL_VERSION }}
          SERVER_VERSION_NUMBER=${{ steps.get_versions.outputs.SERVER_VERSION_NUM }}
          TAG_VERSION=${{ steps.get_versions.outputs.TAG_VERSION }}
          
          # GitHub Releases 下载链接格式
          GITHUB_REPO="shichao402/HelloKnightRemoteCam"
          BASE_URL="https://github.com/${GITHUB_REPO}/releases/download/${TAG_VERSION}"
          
          # 使用传递的版本号构建文件名（直接使用zip文件，不创建_update.zip）
          MACOS_UPDATE_FILE="HelloKnightRCC_macos_${CLIENT_VERSION}.zip"
          WINDOWS_UPDATE_FILE="HelloKnightRCC_windows_${CLIENT_VERSION}.zip"
          ANDROID_FILE="helloknightrcc_server_android_${SERVER_VERSION}.zip"
          
          echo "使用更新文件名（基于传递的版本号，仅zip文件）:"
          echo "  macOS: $MACOS_UPDATE_FILE"
          echo "  Windows: $WINDOWS_UPDATE_FILE"
          echo "  Android: $ANDROID_FILE"
          
          # 验证文件是否存在
          if [ ! -f "artifacts/$MACOS_UPDATE_FILE" ]; then
            echo "错误: macOS更新文件不存在: artifacts/$MACOS_UPDATE_FILE"
            exit 1
          fi
          
          if [ ! -f "artifacts/$WINDOWS_UPDATE_FILE" ]; then
            echo "错误: Windows更新文件不存在: artifacts/$WINDOWS_UPDATE_FILE"
            exit 1
          fi
          
          if [ ! -f "artifacts/$ANDROID_FILE" ]; then
            echo "错误: Android文件不存在: artifacts/$ANDROID_FILE"
            exit 1
          fi
          
          # 计算文件SHA256 hash（使用zip文件）
          MACOS_HASH=""
          WINDOWS_HASH=""
          ANDROID_HASH=""
          
          if [ -n "$MACOS_UPDATE_FILE" ] && [ -f "artifacts/$MACOS_UPDATE_FILE" ]; then
            MACOS_HASH=$(sha256sum "artifacts/$MACOS_UPDATE_FILE" | cut -d' ' -f1)
            echo "macOS更新文件hash: $MACOS_HASH"
          fi
          
          if [ -n "$WINDOWS_UPDATE_FILE" ] && [ -f "artifacts/$WINDOWS_UPDATE_FILE" ]; then
            WINDOWS_HASH=$(sha256sum "artifacts/$WINDOWS_UPDATE_FILE" | cut -d' ' -f1)
            echo "Windows更新文件hash: $WINDOWS_HASH"
          fi
          
          if [ -n "$ANDROID_FILE" ] && [ -f "artifacts/$ANDROID_FILE" ]; then
            ANDROID_HASH=$(sha256sum "artifacts/$ANDROID_FILE" | cut -d' ' -f1)
            echo "Android文件hash: $ANDROID_HASH"
          fi
          
          cat > update_config_github.json <<EOF
          {
            "client": {
              "version": "${CLIENT_VERSION}",
              "versionNumber": "${CLIENT_VERSION_NUMBER}",
              "platforms": {
                "macos": {
                  "version": "${CLIENT_VERSION}",
                  "versionNumber": "${CLIENT_VERSION_NUMBER}",
                  "downloadUrl": "${BASE_URL}/${MACOS_UPDATE_FILE}",
                  "fileName": "${MACOS_UPDATE_FILE}",
                  "fileType": "zip",
                  "platform": "macos",
                  "fileHash": "${MACOS_HASH}"
                },
                "windows": {
                  "version": "${CLIENT_VERSION}",
                  "versionNumber": "${CLIENT_VERSION_NUMBER}",
                  "downloadUrl": "${BASE_URL}/${WINDOWS_UPDATE_FILE}",
                  "fileName": "${WINDOWS_UPDATE_FILE}",
                  "fileType": "zip",
                  "platform": "windows",
                  "fileHash": "${WINDOWS_HASH}"
                }
              }
            },
            "server": {
              "version": "${SERVER_VERSION}",
              "versionNumber": "${SERVER_VERSION_NUMBER}",
              "platforms": {
                "android": {
                  "version": "${SERVER_VERSION}",
                  "versionNumber": "${SERVER_VERSION_NUMBER}",
                  "downloadUrl": "${BASE_URL}/${ANDROID_FILE}",
                  "fileName": "${ANDROID_FILE}",
                  "fileType": "zip",
                  "platform": "android",
                  "fileHash": "${ANDROID_HASH}"
                }
              }
            },
            "updateCheckUrl": "https://raw.githubusercontent.com/${GITHUB_REPO}/main/update_config_github.json",
            "lastUpdated": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          }
          EOF
          
          echo "GitHub 更新配置文件已生成:"
          cat update_config_github.json

      - name: Commit and Push Update Config
        run: |
          # 配置 Git
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # 从标签切换到 main 分支
          git fetch origin main
          git checkout -b main origin/main || git checkout main
          
          # 添加并提交更新配置文件
          git add update_config_github.json
          if git diff --staged --quiet; then
            echo "没有更改，跳过提交"
          else
            CLIENT_VERSION=${{ steps.get_versions.outputs.CLIENT_FULL_VERSION }}
            SERVER_VERSION=${{ steps.get_versions.outputs.SERVER_FULL_VERSION }}
            git commit -m "Release ${CLIENT_VERSION}/${SERVER_VERSION} - 更新 GitHub 自动更新配置"
            git push origin main || echo "推送失败，可能已是最新版本"
          fi


