name: Build Applications

on:
  push:
    branches: [ main, master, develop ]
    tags:
      - 'v*'  # 当推送版本标签时触发
  pull_request:
    branches: [ main, master, develop ]

jobs:
  build-client-macos:
    name: Build Client macOS
    runs-on: macos-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Extract and increment version from VERSION file
        id: get_version
        run: |
          # 始终从 VERSION 文件读取版本号（唯一数据源）
          if [ -f "VERSION" ]; then
            CLIENT_VERSION=$(grep "^CLIENT_VERSION=" VERSION | cut -d'=' -f2 | tr -d '[:space:]')
            VERSION=$(echo "$CLIENT_VERSION" | sed 's/+.*//')
            BUILD_NUMBER=$(echo "$CLIENT_VERSION" | sed 's/.*+//')
            if [ "$CLIENT_VERSION" == "$VERSION" ]; then
              BUILD_NUMBER="1"
            fi
            echo "从 VERSION 文件读取客户端版本号: $CLIENT_VERSION"
            
            # 递增构建号
            BUILD_NUMBER=$((BUILD_NUMBER + 1))
            NEW_CLIENT_VERSION="${VERSION}+${BUILD_NUMBER}"
            
            # 更新 VERSION 文件
            if [[ "$OSTYPE" == "darwin"* ]]; then
              sed -i '' "s/^CLIENT_VERSION=.*/CLIENT_VERSION=${NEW_CLIENT_VERSION}/" VERSION
            else
              sed -i "s/^CLIENT_VERSION=.*/CLIENT_VERSION=${NEW_CLIENT_VERSION}/" VERSION
            fi
            echo "构建号已递增: ${CLIENT_VERSION} → ${NEW_CLIENT_VERSION}"
          else
            echo "错误: VERSION 文件不存在"
            exit 1
          fi
          # 同步版本号到 pubspec.yaml
          cd client
          sed -i '' "s/^version:.*/version: ${VERSION}+${BUILD_NUMBER}/" pubspec.yaml
          echo "已同步版本号到 client/pubspec.yaml: ${VERSION}+${BUILD_NUMBER}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "FULL_VERSION=${VERSION}+${BUILD_NUMBER}" >> $GITHUB_OUTPUT
          echo "TAG_VERSION=v${VERSION}" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
          echo "Build Number: $BUILD_NUMBER"

      - name: Build macOS app
        run: |
          cd client
          ./scripts/build.sh --release --macos

      - name: Archive macOS app (zip)
        run: |
          cd client/build/macos/Build/Products/Release
          zip -r HelloKnightRCC_macos_${{ steps.get_version.outputs.FULL_VERSION }}.zip HelloKnightRCC.app
          mv HelloKnightRCC_macos_${{ steps.get_version.outputs.FULL_VERSION }}.zip $GITHUB_WORKSPACE/client/

      - name: Create macOS DMG
        run: |
          cd client/build/macos/Build/Products/Release
          APP_NAME="HelloKnightRCC.app"
          DMG_NAME="HelloKnightRCC_macos_${{ steps.get_version.outputs.FULL_VERSION }}.dmg"
          VOLUME_NAME="HelloKnightRCC"
          
          # 创建临时目录用于DMG内容
          mkdir -p dmg_temp
          cp -R "$APP_NAME" dmg_temp/
          
          # 创建DMG
          hdiutil create -volname "$VOLUME_NAME" -srcfolder dmg_temp -ov -format UDZO "$DMG_NAME"
          
          # 移动到工作区根目录
          mv "$DMG_NAME" $GITHUB_WORKSPACE/client/
          
          # 清理临时目录
          rm -rf dmg_temp
          
          echo "DMG created: $DMG_NAME"

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: HelloKnightRCC_macos
          path: |
            client/HelloKnightRCC_macos_${{ steps.get_version.outputs.FULL_VERSION }}.zip
            client/HelloKnightRCC_macos_${{ steps.get_version.outputs.FULL_VERSION }}.dmg
          retention-days: 30

      - name: Upload updated VERSION file
        uses: actions/upload-artifact@v4
        with:
          name: VERSION-client
          path: VERSION
          retention-days: 30

  build-client-windows:
    name: Build Client Windows
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Extract and increment version from VERSION file
        id: get_version
        shell: powershell
        run: |
          # 始终从 VERSION 文件读取版本号（唯一数据源）
          if (Test-Path "VERSION") {
            $versionLine = Get-Content "VERSION" | Select-String -Pattern "^CLIENT_VERSION="
            if ($versionLine) {
              $clientVersion = $versionLine -replace "CLIENT_VERSION=", "" -replace " ", ""
              $version = $clientVersion -replace "\+.*", ""
              $buildNumber = $clientVersion -replace ".*\+", ""
              if ($buildNumber -eq $clientVersion) {
                $buildNumber = "1"
              }
              Write-Host "Reading client version from VERSION file: $clientVersion"
              
              # Increment build number
              $buildNumber = [int]$buildNumber + 1
              $newClientVersion = "$version+$buildNumber"
              
              # Update VERSION file
              $content = Get-Content "VERSION"
              $content = $content -replace "^CLIENT_VERSION=.*", "CLIENT_VERSION=$newClientVersion"
              $content | Set-Content "VERSION"
              Write-Host "Build number incremented: $clientVersion -> $newClientVersion"
            } else {
              Write-Host "Error: CLIENT_VERSION not found in VERSION file"
              exit 1
            }
          } else {
            Write-Host "Error: VERSION file not found"
            exit 1
          }
          # Sync version to pubspec.yaml
          cd client
          $content = Get-Content pubspec.yaml
          $fullVersion = "$version+$buildNumber"
          $content = $content -replace "^version:.*", "version: $fullVersion"
          $content | Set-Content pubspec.yaml
          Write-Host "Version synced to client/pubspec.yaml: $fullVersion"
          $tagVersion = "v$version"
          echo "VERSION=$version" >> $env:GITHUB_OUTPUT
          echo "BUILD_NUMBER=$buildNumber" >> $env:GITHUB_OUTPUT
          echo "FULL_VERSION=$fullVersion" >> $env:GITHUB_OUTPUT
          echo "TAG_VERSION=$tagVersion" >> $env:GITHUB_OUTPUT
          Write-Host "Version: $version"
          Write-Host "Build Number: $buildNumber"

      - name: Build Windows app
        run: |
          cd client
          bash scripts/build.sh --release --windows

      - name: Install Inno Setup
        shell: powershell
        run: |
          # 使用 Chocolatey 安装 Inno Setup（如果可用），否则直接下载安装
          if (Get-Command choco -ErrorAction SilentlyContinue) {
            choco install innosetup -y
          } else {
            # 下载并安装 Inno Setup
            $innosetupUrl = "https://files.jrsoftware.org/is/6/innosetup-6.2.2.exe"
            $innosetupPath = "$env:TEMP\innosetup.exe"
            Write-Host "Downloading Inno Setup..."
            Invoke-WebRequest -Uri $innosetupUrl -OutFile $innosetupPath
            Write-Host "Installing Inno Setup..."
            Start-Process -FilePath $innosetupPath -ArgumentList "/VERYSILENT /SUPPRESSMSGBOXES /DIR=C:\Program Files (x86)\Inno Setup 6" -Wait
          }
          # 验证安装
          $isccPath = "C:\Program Files (x86)\Inno Setup 6\ISCC.exe"
          if (Test-Path $isccPath) {
            Write-Host "Inno Setup installed successfully at: $isccPath"
            echo "$isccPath" >> $env:GITHUB_PATH
          } else {
            Write-Host "Error: Inno Setup not found at expected path"
            exit 1
          }

      - name: Create Inno Setup script
        shell: powershell
        run: |
          $version = "${{ steps.get_version.outputs.FULL_VERSION }}"
          # 获取构建产物的绝对路径
          $buildPath = Resolve-Path "client\build\windows\x64\runner\Release"
          # 获取工作区根目录的绝对路径
          $workspaceRoot = $env:GITHUB_WORKSPACE
          $scriptContent = @'
          [Setup]
          AppName=HelloKnightRCC
          AppVersion=PLACEHOLDER_VERSION
          DefaultDirName={autopf}\HelloKnightRCC
          DefaultGroupName=HelloKnightRCC
          OutputDir=PLACEHOLDER_WORKSPACE_ROOT
          OutputBaseFilename=HelloKnightRCC_windows_PLACEHOLDER_VERSION_setup
          Compression=lzma
          SolidCompression=yes
          PrivilegesRequired=admin
          
          [Files]
          Source: "PLACEHOLDER_BUILD_PATH\*"; DestDir: "{app}"; Flags: ignoreversion recursesubdirs
          
          [Icons]
          Name: "{group}\HelloKnightRCC"; Filename: "{app}\HelloKnightRCC.exe"
          Name: "{autodesktop}\HelloKnightRCC"; Filename: "{app}\HelloKnightRCC.exe"; Tasks: desktopicon
          
          [Tasks]
          Name: "desktopicon"; Description: "Create a desktop shortcut"; GroupDescription: "Additional icons:"
          '@
          # 替换占位符
          $scriptContent = $scriptContent -replace 'PLACEHOLDER_VERSION', $version
          $scriptContent = $scriptContent -replace 'PLACEHOLDER_BUILD_PATH', $buildPath
          $scriptContent = $scriptContent -replace 'PLACEHOLDER_WORKSPACE_ROOT', $workspaceRoot
          New-Item -ItemType Directory -Force -Path "installer" | Out-Null
          $scriptContent | Out-File -FilePath "installer\setup.iss" -Encoding UTF8
          Write-Host "Inno Setup script created with build path: $buildPath"
          Write-Host "Output directory: $workspaceRoot"

      - name: Build Windows installer
        shell: powershell
        run: |
          $version = "${{ steps.get_version.outputs.FULL_VERSION }}"
          $installerName = "HelloKnightRCC_windows_${version}_setup.exe"
          # 编译 Inno Setup 脚本
          & "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer\setup.iss
          # 安装程序应该在工作区根目录
          if (Test-Path "$env:GITHUB_WORKSPACE\$installerName") {
            Move-Item -Path "$env:GITHUB_WORKSPACE\$installerName" -Destination "$env:GITHUB_WORKSPACE\client\$installerName"
            Write-Host "Installer created: $installerName"
          } elseif (Test-Path "installer\$installerName") {
            Move-Item -Path "installer\$installerName" -Destination "$env:GITHUB_WORKSPACE\client\$installerName"
            Write-Host "Installer created: $installerName"
          } elseif (Test-Path "installer\installer\$installerName") {
            Move-Item -Path "installer\installer\$installerName" -Destination "$env:GITHUB_WORKSPACE\client\$installerName"
            Write-Host "Installer created: $installerName"
          } else {
            Write-Host "Error: Installer not found"
            Write-Host "Searching in: $env:GITHUB_WORKSPACE"
            Get-ChildItem -Path "$env:GITHUB_WORKSPACE" -Filter "*$installerName" -Recurse -ErrorAction SilentlyContinue | ForEach-Object { Write-Host $_.FullName }
            exit 1
          }

      - name: Upload Windows installer artifact
        uses: actions/upload-artifact@v4
        with:
          name: HelloKnightRCC_windows
          path: client/HelloKnightRCC_windows_${{ steps.get_version.outputs.FULL_VERSION }}_setup.exe
          retention-days: 30

      - name: Upload updated VERSION file
        uses: actions/upload-artifact@v4
        with:
          name: VERSION-client
          path: VERSION
          retention-days: 30

  build-server-android:
    name: Build Server Android
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'
          channel: 'stable'
          cache: true

      - name: Extract and increment version from VERSION file
        id: get_version
        run: |
          # 始终从 VERSION 文件读取版本号（唯一数据源）
          if [ -f "VERSION" ]; then
            SERVER_VERSION=$(grep "^SERVER_VERSION=" VERSION | cut -d'=' -f2 | tr -d '[:space:]')
            VERSION=$(echo "$SERVER_VERSION" | sed 's/+.*//')
            BUILD_NUMBER=$(echo "$SERVER_VERSION" | sed 's/.*+//')
            if [ "$SERVER_VERSION" == "$VERSION" ]; then
              BUILD_NUMBER="1"
            fi
            echo "从 VERSION 文件读取服务器版本号: $SERVER_VERSION"
            
            # 递增构建号
            BUILD_NUMBER=$((BUILD_NUMBER + 1))
            NEW_SERVER_VERSION="${VERSION}+${BUILD_NUMBER}"
            
            # 更新 VERSION 文件
            sed -i "s/^SERVER_VERSION=.*/SERVER_VERSION=${NEW_SERVER_VERSION}/" VERSION
            echo "构建号已递增: ${SERVER_VERSION} → ${NEW_SERVER_VERSION}"
          else
            echo "错误: VERSION 文件不存在"
            exit 1
          fi
          # 同步版本号到 pubspec.yaml
          cd server
          sed -i "s/^version:.*/version: ${VERSION}+${BUILD_NUMBER}/" pubspec.yaml
          echo "已同步版本号到 server/pubspec.yaml: ${VERSION}+${BUILD_NUMBER}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "BUILD_NUMBER=$BUILD_NUMBER" >> $GITHUB_OUTPUT
          echo "FULL_VERSION=${VERSION}+${BUILD_NUMBER}" >> $GITHUB_OUTPUT
          echo "TAG_VERSION=v${VERSION}" >> $GITHUB_OUTPUT
          echo "Version: $VERSION"
          echo "Build Number: $BUILD_NUMBER"

      - name: Build Android APK
        run: |
          cd server
          ./scripts/build.sh --release

      - name: Rename APK with version
        run: |
          cd server/build/app/outputs/flutter-apk
          mv app-release.apk helloknightrcc_server_android_${{ steps.get_version.outputs.FULL_VERSION }}.apk
          mv helloknightrcc_server_android_${{ steps.get_version.outputs.FULL_VERSION }}.apk $GITHUB_WORKSPACE/server/

      - name: Upload Android APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: helloknightrcc_server_android
          path: server/helloknightrcc_server_android_${{ steps.get_version.outputs.FULL_VERSION }}.apk
          retention-days: 30

      - name: Upload updated VERSION file
        uses: actions/upload-artifact@v4
        with:
          name: VERSION-server
          path: VERSION
          retention-days: 30

  create-release:
    name: Create Release
    needs: [build-client-macos, build-client-windows, build-server-android]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
      repository-projects: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Extract version from tag
        id: get_tag_version
        run: |
          TAG_VERSION=${GITHUB_REF#refs/tags/}
          VERSION=${TAG_VERSION#v}
          echo "TAG_VERSION=$TAG_VERSION" >> $GITHUB_OUTPUT
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Tag Version: $TAG_VERSION"
          echo "Version: $VERSION"

      - name: Extract client version from VERSION file
        id: get_client_version
        run: |
          # 始终从 VERSION 文件读取版本号（唯一数据源）
          if [ -f "VERSION" ]; then
            CLIENT_VERSION=$(grep "^CLIENT_VERSION=" VERSION | cut -d'=' -f2 | tr -d '[:space:]')
            VERSION=$(echo "$CLIENT_VERSION" | sed 's/+.*//')
            BUILD_NUMBER=$(echo "$CLIENT_VERSION" | sed 's/.*+//')
            if [ "$CLIENT_VERSION" == "$VERSION" ]; then
              BUILD_NUMBER="1"
            fi
            echo "从 VERSION 文件读取客户端版本号: $CLIENT_VERSION"
          else
            echo "错误: VERSION 文件不存在"
            exit 1
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "FULL_VERSION=${VERSION}+${BUILD_NUMBER}" >> $GITHUB_OUTPUT

      - name: Extract server version from VERSION file
        id: get_server_version
        run: |
          # 始终从 VERSION 文件读取版本号（唯一数据源）
          if [ -f "VERSION" ]; then
            SERVER_VERSION=$(grep "^SERVER_VERSION=" VERSION | cut -d'=' -f2 | tr -d '[:space:]')
            VERSION=$(echo "$SERVER_VERSION" | sed 's/+.*//')
            BUILD_NUMBER=$(echo "$SERVER_VERSION" | sed 's/.*+//')
            if [ "$SERVER_VERSION" == "$VERSION" ]; then
              BUILD_NUMBER="1"
            fi
            echo "从 VERSION 文件读取服务器版本号: $SERVER_VERSION"
          else
            echo "错误: VERSION 文件不存在"
            exit 1
          fi
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "FULL_VERSION=${VERSION}+${BUILD_NUMBER}" >> $GITHUB_OUTPUT

      - name: Download macOS artifact
        uses: actions/download-artifact@v4
        with:
          name: HelloKnightRCC_macos
          path: ./artifacts-temp

      - name: Download Windows artifact
        uses: actions/download-artifact@v4
        with:
          name: HelloKnightRCC_windows
          path: ./artifacts-temp

      - name: Download Android artifact
        uses: actions/download-artifact@v4
        with:
          name: helloknightrcc_server_android
          path: ./artifacts-temp

      - name: Download updated VERSION files
        uses: actions/download-artifact@v4
        with:
          name: VERSION-client
          path: ./version-temp-client
        continue-on-error: true

      - name: Download updated VERSION file (server)
        uses: actions/download-artifact@v4
        with:
          name: VERSION-server
          path: ./version-temp-server
        continue-on-error: true

      - name: Merge updated VERSION file
        run: |
          # 合并客户端和服务器构建号更新
          if [ -f "version-temp-client/VERSION" ]; then
            # 从客户端构建的 VERSION 文件读取 CLIENT_VERSION
            CLIENT_VERSION=$(grep "^CLIENT_VERSION=" version-temp-client/VERSION | cut -d'=' -f2 | tr -d '[:space:]')
            if [ -n "$CLIENT_VERSION" ]; then
              sed -i "s/^CLIENT_VERSION=.*/CLIENT_VERSION=${CLIENT_VERSION}/" VERSION
              echo "已更新 CLIENT_VERSION: $CLIENT_VERSION"
            fi
          fi
          # 从服务器构建的 VERSION 文件读取 SERVER_VERSION
          if [ -f "version-temp-server/VERSION" ]; then
            SERVER_VERSION=$(grep "^SERVER_VERSION=" version-temp-server/VERSION | cut -d'=' -f2 | tr -d '[:space:]')
            if [ -n "$SERVER_VERSION" ]; then
              sed -i "s/^SERVER_VERSION=.*/SERVER_VERSION=${SERVER_VERSION}/" VERSION
              echo "已更新 SERVER_VERSION: $SERVER_VERSION"
            fi
          fi
          rm -rf version-temp-client version-temp-server
          echo "合并后的 VERSION 文件:"
          cat VERSION

      - name: Flatten artifacts structure
        run: |
          mkdir -p artifacts
          # 查找并移动所有构建产物到统一的 artifacts 目录
          find ./artifacts-temp -name "HelloKnightRCC_macos_*.zip" -exec mv {} ./artifacts/ \;
          find ./artifacts-temp -name "HelloKnightRCC_macos_*.dmg" -exec mv {} ./artifacts/ \;
          find ./artifacts-temp -name "HelloKnightRCC_windows_*_setup.exe" -exec mv {} ./artifacts/ \;
          find ./artifacts-temp -name "helloknightrcc_server_android_*.apk" -exec mv {} ./artifacts/ \;
          rm -rf ./artifacts-temp

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_tag_version.outputs.TAG_VERSION }}
          name: Release ${{ steps.get_tag_version.outputs.VERSION }}
          body: |
            ## Release ${{ steps.get_tag_version.outputs.VERSION }}

            ### Client
            - **macOS**: 
              - DMG: HelloKnightRCC_macos_${{ steps.get_client_version.outputs.FULL_VERSION }}.dmg (推荐)
              - ZIP: HelloKnightRCC_macos_${{ steps.get_client_version.outputs.FULL_VERSION }}.zip
            - **Windows**: HelloKnightRCC_windows_${{ steps.get_client_version.outputs.FULL_VERSION }}_setup.exe

            ### Server
            - **Android**: helloknightrcc_server_android_${{ steps.get_server_version.outputs.FULL_VERSION }}.apk

            ### Changes
            - See commit history for details
          files: |
            artifacts/HelloKnightRCC_macos_*.zip
            artifacts/HelloKnightRCC_macos_*.dmg
            artifacts/HelloKnightRCC_windows_*_setup.exe
            artifacts/helloknightrcc_server_android_*.apk
          draft: false
          prerelease: false

      # 生成 GitHub 更新配置文件
      - name: Generate GitHub Update Config
        run: |
          CLIENT_VERSION=${{ steps.get_client_version.outputs.FULL_VERSION }}
          CLIENT_VERSION_NUMBER=${{ steps.get_client_version.outputs.VERSION }}
          SERVER_VERSION=${{ steps.get_server_version.outputs.FULL_VERSION }}
          SERVER_VERSION_NUMBER=${{ steps.get_server_version.outputs.VERSION }}
          TAG_VERSION=${{ steps.get_tag_version.outputs.TAG_VERSION }}
          
          # GitHub Releases 下载链接格式
          GITHUB_REPO="shichao402/HelloKnightRemoteCam"
          BASE_URL="https://github.com/${GITHUB_REPO}/releases/download/${TAG_VERSION}"
          
          # 获取实际的文件名（从 artifacts 目录）
          MACOS_FILE=$(find artifacts -name "HelloKnightRCC_macos_*.dmg" -exec basename {} \; | head -1)
          WINDOWS_FILE=$(find artifacts -name "HelloKnightRCC_windows_*_setup.exe" -exec basename {} \; | head -1)
          ANDROID_FILE=$(find artifacts -name "helloknightrcc_server_android_*.apk" -exec basename {} \; | head -1)
          
          cat > update_config_github.json <<EOF
          {
            "client": {
              "version": "${CLIENT_VERSION}",
              "versionNumber": "${CLIENT_VERSION_NUMBER}",
              "platforms": {
                "macos": {
                  "version": "${CLIENT_VERSION}",
                  "versionNumber": "${CLIENT_VERSION_NUMBER}",
                  "downloadUrl": "${BASE_URL}/${MACOS_FILE}",
                  "fileName": "${MACOS_FILE}",
                  "fileType": "dmg",
                  "platform": "macos"
                },
                "windows": {
                  "version": "${CLIENT_VERSION}",
                  "versionNumber": "${CLIENT_VERSION_NUMBER}",
                  "downloadUrl": "${BASE_URL}/${WINDOWS_FILE}",
                  "fileName": "${WINDOWS_FILE}",
                  "fileType": "exe",
                  "platform": "windows"
                }
              }
            },
            "server": {
              "version": "${SERVER_VERSION}",
              "versionNumber": "${SERVER_VERSION_NUMBER}",
              "platforms": {
                "android": {
                  "version": "${SERVER_VERSION}",
                  "versionNumber": "${SERVER_VERSION_NUMBER}",
                  "downloadUrl": "${BASE_URL}/${ANDROID_FILE}",
                  "fileName": "${ANDROID_FILE}",
                  "fileType": "apk",
                  "platform": "android"
                }
              }
            },
            "updateCheckUrl": "https://raw.githubusercontent.com/${GITHUB_REPO}/main/update_config_github.json",
            "lastUpdated": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          }
          EOF
          
          echo "GitHub 更新配置文件已生成:"
          cat update_config_github.json

      - name: Commit and Push VERSION and Update Config
        run: |
          # 配置 Git
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # 从标签切换到 main 分支
          git fetch origin main
          git checkout -b main origin/main || git checkout main
          
          # 添加并提交 VERSION 文件（构建号已递增）和更新配置文件
          git add VERSION update_config_github.json
          if git diff --staged --quiet; then
            echo "没有更改，跳过提交"
          else
            CLIENT_VERSION=$(grep "^CLIENT_VERSION=" VERSION | cut -d'=' -f2 | tr -d '[:space:]')
            SERVER_VERSION=$(grep "^SERVER_VERSION=" VERSION | cut -d'=' -f2 | tr -d '[:space:]')
            git commit -m "构建版本 ${CLIENT_VERSION}/${SERVER_VERSION} - 更新构建号和 GitHub 自动更新配置"
            git push origin main || echo "推送失败，可能已是最新版本"
          fi


