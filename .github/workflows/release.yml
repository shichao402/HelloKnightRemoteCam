name: Create Release

# Release 工作流：手动触发，根据版本号自动查找构建产物
on:
  workflow_dispatch:
    inputs:
      version:
        description: '版本号（如 1.0.7），留空则使用最新构建结果，指定版本则查找小于等于该版本的最大构建标签'
        required: false
        type: string

env:
  FLUTTER_VERSION: '3.24.0'

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write  # 创建 release 需要写入权限
      actions: read    # 读取其他 workflow run 的 artifacts
      pull-requests: read  # 读取标签信息
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: main

      - name: Cache Python dependencies
        uses: actions/cache@v4
        with:
          path: ~/.local/lib/python3.*/site-packages
          key: python-linux-pyyaml-1.0
          restore-keys: |
            python-linux-pyyaml-

      - name: Find build tags and workflow runs
        id: find_builds
        uses: actions/github-script@v7
        with:
          script: |
            const targetVersion = '${{ github.event.inputs.version }}';
            const useLatest = !targetVersion || targetVersion.trim() === '';
            
            // 版本号比较函数
            function compareVersions(v1, v2) {
              const parts1 = v1.split('.').map(Number);
              const parts2 = v2.split('.').map(Number);
              const maxLength = Math.max(parts1.length, parts2.length);
              
              for (let i = 0; i < maxLength; i++) {
                const part1 = parts1[i] || 0;
                const part2 = parts2[i] || 0;
                if (part1 < part2) return -1;
                if (part1 > part2) return 1;
              }
              return 0;
            }
            
            if (useLatest) {
              console.log('未指定版本号，查找最新的构建结果...');
            } else {
              console.log(`查找版本号 <= ${targetVersion} 的构建标签...`);
            }
            
            // 从标签名提取版本号
            function extractVersion(tagName, prefix) {
              if (tagName.startsWith(prefix)) {
                return tagName.substring(prefix.length);
              }
              return null;
            }
            
            // 获取所有标签
            const tags = [];
            let page = 1;
            let hasMore = true;
            
            while (hasMore) {
              const { data } = await github.rest.repos.listTags({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100,
                page: page
              });
              
              if (data.length === 0) {
                hasMore = false;
              } else {
                tags.push(...data);
                page++;
                if (data.length < 100) hasMore = false;
              }
            }
            
            console.log(`找到 ${tags.length} 个标签`);
            
            // 查找符合条件的构建标签（新格式：build*）
            // 从 build* 标签中提取版本号（如 build1.0.7 -> 1.0.7）
            function extractBuildVersion(tagName) {
              if (tagName.startsWith('build')) {
                return tagName.substring(5); // 去掉 'build' 前缀
              }
              return null;
            }
            
            let foundBuildTag = null;
            let foundVersion = null;
            
            // 遍历所有标签，找到符合条件的 build* 标签
            for (const tag of tags) {
              const tagName = tag.name;
              const version = extractBuildVersion(tagName);
              
              if (version) {
                let shouldInclude = false;
                
                if (useLatest) {
                  // 使用最新版本：总是包含
                  shouldInclude = true;
                } else {
                  // 使用指定版本：只包含 <= targetVersion 的版本
                  shouldInclude = compareVersions(version, targetVersion) <= 0;
                }
                
                if (shouldInclude) {
                  if (!foundVersion || compareVersions(version, foundVersion) > 0) {
                    foundBuildTag = tagName;
                    foundVersion = version;
                  }
                }
              }
            }
            
            // 为了兼容，设置每个平台的标签和版本（都使用同一个 build 标签）
            const foundTags = {
              macos: foundBuildTag,
              windows: foundBuildTag,
              android: foundBuildTag
            };
            
            const foundVersions = {
              macos: foundVersion,
              windows: foundVersion,
              android: foundVersion
            };
            
            // 确定 release 版本号
            let releaseVersion;
            if (useLatest) {
              // 使用找到的最新版本号（取三个平台中最大的）
              releaseVersion = Object.values(foundVersions).reduce((max, v) => {
                if (!v) return max;
                if (!max) return v;
                return compareVersions(v, max) > 0 ? v : max;
              }, null);
              
              if (!releaseVersion) {
                core.setFailed('未找到任何构建标签');
                return;
              }
            } else {
              releaseVersion = targetVersion;
            }
            
            const releaseTag = `v${releaseVersion}`;
            console.log(`Release 标签: ${releaseTag}`);
            
            // 输出找到的标签
            if (foundBuildTag) {
              console.log(`找到构建标签: ${foundBuildTag} (版本: ${foundVersion})`);
            } else {
              const errorMsg = useLatest 
                ? '未找到任何构建标签'
                : `未找到构建标签（版本 <= ${targetVersion}）`;
              core.setFailed(errorMsg);
              return;
            }
            
            // 获取标签对应的 commit SHA
            const tagRef = await github.rest.git.getRef({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: `tags/${foundBuildTag}`
            });
            
            const commitSha = tagRef.data.object.sha;
            console.log(`标签 ${foundBuildTag} 对应的 commit: ${commitSha.substring(0, 7)}`);
            
            // 查找该 commit 对应的总构建工作流运行
            const mainWorkflowFile = 'build.yml';
            let mainWorkflowRun = null;
            let page = 1;
            let found = false;
            
            while (!found && page <= 5) {
              const { data: runs } = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: mainWorkflowFile,
                per_page: 30,
                page: page
              });
              
              if (runs.workflow_runs.length === 0) break;
              
              // 查找该 commit 对应的成功运行
              mainWorkflowRun = runs.workflow_runs.find(run => 
                run.head_sha === commitSha && 
                run.status === 'completed' && 
                run.conclusion === 'success'
              );
              
              if (mainWorkflowRun) {
                found = true;
              } else {
                page++;
              }
            }
            
            if (!mainWorkflowRun) {
              core.setFailed(`未找到标签 ${foundBuildTag} 对应的成功构建运行`);
              return;
            }
            
            console.log(`总构建工作流运行 ID: ${mainWorkflowRun.id} (运行号: ${mainWorkflowRun.run_number})`);
            
            // 查找子工作流的运行（从总构建工作流的运行中获取）
            const workflowFiles = {
              macos: 'build-client-macos.yml',
              windows: 'build-client-windows.yml',
              android: 'build-server-android.yml'
            };
            
            const workflowRuns = {
              macos: null,
              windows: null,
              android: null
            };
            
            // 查找每个子工作流的运行
            for (const [platform, workflowFile] of Object.entries(workflowFiles)) {
              page = 1;
              found = false;
              
              while (!found && page <= 5) {
                const { data: runs } = await github.rest.actions.listWorkflowRuns({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  workflow_id: workflowFile,
                  per_page: 30,
                  page: page
                });
                
                if (runs.workflow_runs.length === 0) break;
                
                // 查找该 commit 对应的成功运行
                const successfulRun = runs.workflow_runs.find(run => 
                  run.head_sha === commitSha && 
                  run.status === 'completed' && 
                  run.conclusion === 'success'
                );
                
                if (successfulRun) {
                  workflowRuns[platform] = successfulRun.id;
                  console.log(`  ${platform} workflow run ID: ${successfulRun.id} (运行号: ${successfulRun.run_number})`);
                  found = true;
                } else {
                  page++;
                }
              }
              
              if (!workflowRuns[platform]) {
                core.setFailed(`未找到 ${platform} 平台的成功构建运行`);
              }
            }
            
            // 设置输出
            core.setOutput('macos_run_id', workflowRuns.macos || '');
            core.setOutput('windows_run_id', workflowRuns.windows || '');
            core.setOutput('android_run_id', workflowRuns.android || '');
            core.setOutput('macos_tag', foundTags.macos || '');
            core.setOutput('windows_tag', foundTags.windows || '');
            core.setOutput('android_tag', foundTags.android || '');
            core.setOutput('macos_version', foundVersions.macos || '');
            core.setOutput('windows_version', foundVersions.windows || '');
            core.setOutput('android_version', foundVersions.android || '');
            core.setOutput('release_tag', releaseTag);
            core.setOutput('release_version', releaseVersion);
            
            return {
              workflowRuns,
              foundTags,
              foundVersions,
              releaseTag
            };

      - name: Extract versions from build results
        id: get_versions
        run: |
          # 使用从构建标签中找到的版本号
          RELEASE_VERSION="${{ steps.find_builds.outputs.release_version }}"
          TAG_VERSION="${{ steps.find_builds.outputs.release_tag }}"
          
          MACOS_VERSION="${{ steps.find_builds.outputs.macos_version }}"
          WINDOWS_VERSION="${{ steps.find_builds.outputs.windows_version }}"
          ANDROID_VERSION="${{ steps.find_builds.outputs.android_version }}"
          
          # 从构建版本号中提取主版本号和构建号
          # 构建版本号格式：x.y.z+build_number
          # 如果没有构建号，则从 VERSION.yaml 读取
          
          # 安装 PyYAML（如果需要）
          python3 -c "import yaml" 2>/dev/null || \
          python3 -m pip install --user --break-system-packages pyyaml --quiet || \
          python3 -m pip install --break-system-packages pyyaml --quiet || \
          python3 -m pip install --user pyyaml --quiet || true
          
          # 从 VERSION.yaml 读取完整版本信息（用于构建号）
          if [ -f "VERSION.yaml" ]; then
            CLIENT_FULL_VERSION=$(python3 scripts/lib/version_manager.py extract client --json 2>/dev/null | \
              python3 -c "import sys, json; print(json.load(sys.stdin)['full_version'])" 2>/dev/null || echo "")
            SERVER_FULL_VERSION=$(python3 scripts/lib/version_manager.py extract server --json 2>/dev/null | \
              python3 -c "import sys, json; print(json.load(sys.stdin)['full_version'])" 2>/dev/null || echo "")
          else
            CLIENT_FULL_VERSION="${MACOS_VERSION}"
            SERVER_FULL_VERSION="${ANDROID_VERSION}"
          fi
          
          # 使用构建版本号作为主版本号
          CLIENT_VERSION_NUM="${MACOS_VERSION}"
          SERVER_VERSION_NUM="${ANDROID_VERSION}"
          
          # 如果没有找到构建版本，使用 release_version
          CLIENT_VERSION_NUM=${CLIENT_VERSION_NUM:-$RELEASE_VERSION}
          SERVER_VERSION_NUM=${SERVER_VERSION_NUM:-$RELEASE_VERSION}
          
          echo "CLIENT_VERSION=${CLIENT_FULL_VERSION}" >> $GITHUB_OUTPUT
          echo "CLIENT_VERSION_NUM=${CLIENT_VERSION_NUM}" >> $GITHUB_OUTPUT
          echo "CLIENT_FULL_VERSION=${CLIENT_FULL_VERSION}" >> $GITHUB_OUTPUT
          
          echo "SERVER_VERSION=${SERVER_FULL_VERSION}" >> $GITHUB_OUTPUT
          echo "SERVER_VERSION_NUM=${SERVER_VERSION_NUM}" >> $GITHUB_OUTPUT
          echo "SERVER_FULL_VERSION=${SERVER_FULL_VERSION}" >> $GITHUB_OUTPUT
          
          echo "TAG_VERSION=${TAG_VERSION}" >> $GITHUB_OUTPUT
          echo "RELEASE_VERSION=${RELEASE_VERSION}" >> $GITHUB_OUTPUT
          
          echo ""
          echo "Release 信息:"
          echo "  Release 标签: ${TAG_VERSION}"
          echo "  Release 版本: ${RELEASE_VERSION}"
          echo ""
          echo "使用的构建版本:"
          echo "  macOS: ${MACOS_VERSION}"
          echo "  Windows: ${WINDOWS_VERSION}"
          echo "  Android: ${ANDROID_VERSION}"

      - name: Download macOS artifact from build workflow
        uses: actions/download-artifact@v4
        with:
          name: HelloKnightRCC_macos
          path: ./artifacts-temp
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ steps.find_builds.outputs.macos_run_id }}

      - name: Download Windows artifact from build workflow
        uses: actions/download-artifact@v4
        with:
          name: HelloKnightRCC_windows
          path: ./artifacts-temp
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ steps.find_builds.outputs.windows_run_id }}

      - name: Download Android artifact from build workflow
        uses: actions/download-artifact@v4
        with:
          name: helloknightrcc_server_android
          path: ./artifacts-temp
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ steps.find_builds.outputs.android_run_id }}

      - name: Flatten artifacts structure and rename with correct version
        run: |
          mkdir -p artifacts
          
          # 使用传递的版本号（从VERSION文件获取）
          CLIENT_VERSION="${{ steps.get_versions.outputs.CLIENT_FULL_VERSION }}"
          SERVER_VERSION="${{ steps.get_versions.outputs.SERVER_FULL_VERSION }}"
          
          echo "使用版本号重命名文件:"
          echo "  CLIENT_VERSION=$CLIENT_VERSION"
          echo "  SERVER_VERSION=$SERVER_VERSION"
          
          # macOS文件 - zip文件（zip包里包含dmg文件）
          MACOS_ZIP=$(find ./artifacts-temp -name "HelloKnightRCC_macos_*.zip" | head -1)
          if [ -n "$MACOS_ZIP" ]; then
            mv "$MACOS_ZIP" "./artifacts/HelloKnightRCC_macos_${CLIENT_VERSION}.zip"
            echo "重命名macOS ZIP: $(basename "$MACOS_ZIP") -> HelloKnightRCC_macos_${CLIENT_VERSION}.zip"
            echo "注意: macOS ZIP文件包含DMG文件，用户需要解压后打开DMG安装"
          else
            echo "警告: 未找到macOS ZIP文件"
          fi
          
          # Windows文件 - 需要从exe创建zip用于更新
          # 注意：Windows构建只生成exe，需要将其打包为zip
          WINDOWS_EXE=$(find ./artifacts-temp -name "HelloKnightRCC_windows_*_setup.exe" | head -1)
          if [ -n "$WINDOWS_EXE" ]; then
            # 将EXE打包为zip用于更新
            cd artifacts-temp
            zip "../artifacts/HelloKnightRCC_windows_${CLIENT_VERSION}.zip" "$(basename "$WINDOWS_EXE")"
            cd ..
            echo "已创建Windows更新zip: HelloKnightRCC_windows_${CLIENT_VERSION}.zip"
          else
            echo "警告: 未找到Windows EXE文件"
          fi
          
          # Android文件 - 查找并重命名（已经是zip文件）
          ANDROID_ZIP=$(find ./artifacts-temp -name "helloknightrcc_server_android_*.zip" | head -1)
          if [ -n "$ANDROID_ZIP" ]; then
            mv "$ANDROID_ZIP" "./artifacts/helloknightrcc_server_android_${SERVER_VERSION}.zip"
            echo "重命名Android ZIP: $(basename "$ANDROID_ZIP") -> helloknightrcc_server_android_${SERVER_VERSION}.zip"
          else
            echo "警告: 未找到Android ZIP文件"
          fi
          
          rm -rf ./artifacts-temp
          
          echo ""
          echo "重命名后的文件列表（仅zip文件）:"
          ls -la artifacts/

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_versions.outputs.TAG_VERSION }}
          name: Release ${{ steps.get_versions.outputs.RELEASE_VERSION }}
          body: |
            ## Release ${{ steps.get_versions.outputs.RELEASE_VERSION }}

            ### Client
            - **macOS**: HelloKnightRCC_macos_${{ steps.get_versions.outputs.CLIENT_FULL_VERSION }}.zip
            - **Windows**: HelloKnightRCC_windows_${{ steps.get_versions.outputs.CLIENT_FULL_VERSION }}.zip

            ### Server
            - **Android**: helloknightrcc_server_android_${{ steps.get_versions.outputs.SERVER_FULL_VERSION }}.zip

            ### Changes
            - See commit history for details
          files: |
            artifacts/HelloKnightRCC_macos_${{ steps.get_versions.outputs.CLIENT_FULL_VERSION }}.zip
            artifacts/HelloKnightRCC_windows_${{ steps.get_versions.outputs.CLIENT_FULL_VERSION }}.zip
            artifacts/helloknightrcc_server_android_${{ steps.get_versions.outputs.SERVER_FULL_VERSION }}.zip
          draft: false
          prerelease: false

      # 计算文件hash并生成 GitHub 更新配置文件
      - name: Calculate File Hashes and Generate GitHub Update Config
        run: |
          CLIENT_VERSION=${{ steps.get_versions.outputs.CLIENT_FULL_VERSION }}
          CLIENT_VERSION_NUMBER=${{ steps.get_versions.outputs.CLIENT_VERSION_NUM }}
          SERVER_VERSION=${{ steps.get_versions.outputs.SERVER_FULL_VERSION }}
          SERVER_VERSION_NUMBER=${{ steps.get_versions.outputs.SERVER_VERSION_NUM }}
          TAG_VERSION=${{ steps.get_versions.outputs.TAG_VERSION }}
          
          # GitHub Releases 下载链接格式（使用内置变量）
          GITHUB_REPO="${{ github.repository }}"
          BASE_URL="https://github.com/${GITHUB_REPO}/releases/download/${TAG_VERSION}"
          
          # 使用传递的版本号构建文件名（直接使用zip文件，不创建_update.zip）
          MACOS_UPDATE_FILE="HelloKnightRCC_macos_${CLIENT_VERSION}.zip"
          WINDOWS_UPDATE_FILE="HelloKnightRCC_windows_${CLIENT_VERSION}.zip"
          ANDROID_FILE="helloknightrcc_server_android_${SERVER_VERSION}.zip"
          
          echo "使用更新文件名（基于传递的版本号，仅zip文件）:"
          echo "  macOS: $MACOS_UPDATE_FILE"
          echo "  Windows: $WINDOWS_UPDATE_FILE"
          echo "  Android: $ANDROID_FILE"
          
          # 验证文件是否存在
          if [ ! -f "artifacts/$MACOS_UPDATE_FILE" ]; then
            echo "错误: macOS更新文件不存在: artifacts/$MACOS_UPDATE_FILE"
            exit 1
          fi
          
          if [ ! -f "artifacts/$WINDOWS_UPDATE_FILE" ]; then
            echo "错误: Windows更新文件不存在: artifacts/$WINDOWS_UPDATE_FILE"
            exit 1
          fi
          
          if [ ! -f "artifacts/$ANDROID_FILE" ]; then
            echo "错误: Android文件不存在: artifacts/$ANDROID_FILE"
            exit 1
          fi
          
          # 计算文件SHA256 hash（使用zip文件）
          MACOS_HASH=""
          WINDOWS_HASH=""
          ANDROID_HASH=""
          
          if [ -n "$MACOS_UPDATE_FILE" ] && [ -f "artifacts/$MACOS_UPDATE_FILE" ]; then
            MACOS_HASH=$(sha256sum "artifacts/$MACOS_UPDATE_FILE" | cut -d' ' -f1)
            echo "macOS更新文件hash: $MACOS_HASH"
          fi
          
          if [ -n "$WINDOWS_UPDATE_FILE" ] && [ -f "artifacts/$WINDOWS_UPDATE_FILE" ]; then
            WINDOWS_HASH=$(sha256sum "artifacts/$WINDOWS_UPDATE_FILE" | cut -d' ' -f1)
            echo "Windows更新文件hash: $WINDOWS_HASH"
          fi
          
          if [ -n "$ANDROID_FILE" ] && [ -f "artifacts/$ANDROID_FILE" ]; then
            ANDROID_HASH=$(sha256sum "artifacts/$ANDROID_FILE" | cut -d' ' -f1)
            echo "Android文件hash: $ANDROID_HASH"
          fi
          
          cat > update_config_github.json <<EOF
          {
            "client": {
              "version": "${CLIENT_VERSION}",
              "versionNumber": "${CLIENT_VERSION_NUMBER}",
              "platforms": {
                "macos": {
                  "version": "${CLIENT_VERSION}",
                  "versionNumber": "${CLIENT_VERSION_NUMBER}",
                  "downloadUrl": "${BASE_URL}/${MACOS_UPDATE_FILE}",
                  "fileName": "${MACOS_UPDATE_FILE}",
                  "fileType": "zip",
                  "platform": "macos",
                  "fileHash": "${MACOS_HASH}"
                },
                "windows": {
                  "version": "${CLIENT_VERSION}",
                  "versionNumber": "${CLIENT_VERSION_NUMBER}",
                  "downloadUrl": "${BASE_URL}/${WINDOWS_UPDATE_FILE}",
                  "fileName": "${WINDOWS_UPDATE_FILE}",
                  "fileType": "zip",
                  "platform": "windows",
                  "fileHash": "${WINDOWS_HASH}"
                }
              }
            },
            "server": {
              "version": "${SERVER_VERSION}",
              "versionNumber": "${SERVER_VERSION_NUMBER}",
              "platforms": {
                "android": {
                  "version": "${SERVER_VERSION}",
                  "versionNumber": "${SERVER_VERSION_NUMBER}",
                  "downloadUrl": "${BASE_URL}/${ANDROID_FILE}",
                  "fileName": "${ANDROID_FILE}",
                  "fileType": "zip",
                  "platform": "android",
                  "fileHash": "${ANDROID_HASH}"
                }
              }
            },
            "updateCheckUrl": "https://raw.githubusercontent.com/${{ github.repository }}/main/update_config_github.json",
            "lastUpdated": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          }
          EOF
          
          echo "GitHub 更新配置文件已生成:"
          cat update_config_github.json

      - name: Save update config as artifact
        uses: actions/upload-artifact@v4
        with:
          name: update-config
          path: update_config_github.json
          retention-days: 1

      - name: Checkout main branch for config update
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: main
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Download update config artifact
        uses: actions/download-artifact@v4
        with:
          name: update-config
          path: .

      - name: Commit and Push Update Config
        run: |
          # 配置 Git
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
          # 添加并提交更新配置文件
          git add update_config_github.json
          if git diff --staged --quiet; then
            echo "没有更改，跳过提交"
          else
            CLIENT_VERSION=${{ steps.get_versions.outputs.CLIENT_FULL_VERSION }}
            SERVER_VERSION=${{ steps.get_versions.outputs.SERVER_FULL_VERSION }}
            git commit -m "Release ${CLIENT_VERSION}/${SERVER_VERSION} - 更新 GitHub 自动更新配置"
            git push origin main || echo "推送失败，可能已是最新版本"
          fi

