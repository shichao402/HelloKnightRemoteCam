name: Create Release

# Release å·¥ä½œæµï¼šæ‰‹åŠ¨è§¦å‘ï¼Œæ ¹æ®ç‰ˆæœ¬å·è‡ªåŠ¨æŸ¥æ‰¾æ„å»ºäº§ç‰©
on:
  workflow_dispatch:
    inputs:
      version:
        description: 'ç‰ˆæœ¬å·ï¼ˆå¦‚ 1.0.7ï¼‰ï¼Œç•™ç©ºåˆ™ä½¿ç”¨æœ€æ–°æ„å»ºç»“æœï¼ŒæŒ‡å®šç‰ˆæœ¬åˆ™æŸ¥æ‰¾å°äºç­‰äºè¯¥ç‰ˆæœ¬çš„æœ€å¤§æ„å»ºæ ‡ç­¾'
        required: false
        type: string

env:
  FLUTTER_VERSION: '3.24.0'

jobs:
  create-release:
    name: Create Release
    runs-on: ubuntu-latest
    permissions:
      contents: write  # åˆ›å»º release éœ€è¦å†™å…¥æƒé™
      actions: read    # è¯»å–å…¶ä»– workflow run çš„ artifacts
      pull-requests: read  # è¯»å–æ ‡ç­¾ä¿¡æ¯
    outputs:
      release_tag: ${{ steps.set_outputs.outputs.release_tag }}
      release_version: ${{ steps.set_outputs.outputs.release_version }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1
          ref: main

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Find build tags and workflow runs
        id: find_builds
        uses: actions/github-script@v7
        with:
          script: |
            const targetVersion = '${{ github.event.inputs.version }}';
            const useLatest = !targetVersion || targetVersion.trim() === '';
            
            // ç‰ˆæœ¬å·æ¯”è¾ƒå‡½æ•°
            function compareVersions(v1, v2) {
              const parts1 = v1.split('.').map(Number);
              const parts2 = v2.split('.').map(Number);
              const maxLength = Math.max(parts1.length, parts2.length);
              
              for (let i = 0; i < maxLength; i++) {
                const part1 = parts1[i] || 0;
                const part2 = parts2[i] || 0;
                if (part1 < part2) return -1;
                if (part1 > part2) return 1;
              }
              return 0;
            }
            
            if (useLatest) {
              console.log('æœªæŒ‡å®šç‰ˆæœ¬å·ï¼ŒæŸ¥æ‰¾æœ€æ–°çš„æ„å»ºç»“æœ...');
            } else {
              console.log(`æŸ¥æ‰¾ç‰ˆæœ¬å· <= ${targetVersion} çš„æ„å»ºæ ‡ç­¾...`);
            }
            
            // ä»æ ‡ç­¾åæå–ç‰ˆæœ¬å·
            function extractVersion(tagName, prefix) {
              if (tagName.startsWith(prefix)) {
                return tagName.substring(prefix.length);
              }
              return null;
            }
            
            // è·å–æ‰€æœ‰æ ‡ç­¾
            const tags = [];
            let page = 1;
            let hasMore = true;
            
            while (hasMore) {
              const { data } = await github.rest.repos.listTags({
                owner: context.repo.owner,
                repo: context.repo.repo,
                per_page: 100,
                page: page
              });
              
              if (data.length === 0) {
                hasMore = false;
              } else {
                tags.push(...data);
                page++;
                if (data.length < 100) hasMore = false;
              }
            }
            
            console.log(`æ‰¾åˆ° ${tags.length} ä¸ªæ ‡ç­¾`);
            
            // æŸ¥æ‰¾ç¬¦åˆæ¡ä»¶çš„æ„å»ºæ ‡ç­¾ï¼ˆæ–°æ ¼å¼ï¼šbuild*ï¼‰
            // ä» build* æ ‡ç­¾ä¸­æå–ç‰ˆæœ¬å·ï¼ˆå¦‚ build1.0.7 -> 1.0.7ï¼‰
            function extractBuildVersion(tagName) {
              if (tagName.startsWith('build')) {
                return tagName.substring(5); // å»æ‰ 'build' å‰ç¼€
              }
              return null;
            }
            
            let foundBuildTag = null;
            let foundVersion = null;
            
            let foundTagObject = null;
            
            // éå†æ‰€æœ‰æ ‡ç­¾ï¼Œæ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ build* æ ‡ç­¾
            for (const tag of tags) {
              const tagName = tag.name;
              const version = extractBuildVersion(tagName);
              
              if (version) {
                let shouldInclude = false;
                
                if (useLatest) {
                  // ä½¿ç”¨æœ€æ–°ç‰ˆæœ¬ï¼šæ€»æ˜¯åŒ…å«
                  shouldInclude = true;
                } else {
                  // ä½¿ç”¨æŒ‡å®šç‰ˆæœ¬ï¼šåªåŒ…å« <= targetVersion çš„ç‰ˆæœ¬
                  shouldInclude = compareVersions(version, targetVersion) <= 0;
                }
                
                if (shouldInclude) {
                  if (!foundVersion || compareVersions(version, foundVersion) > 0) {
                    foundBuildTag = tagName;
                    foundVersion = version;
                    foundTagObject = tag; // ä¿å­˜æ ‡ç­¾å¯¹è±¡ï¼ŒåŒ…å«commitä¿¡æ¯
                  }
                }
              }
            }
            
            // ä¸ºäº†å…¼å®¹ï¼Œè®¾ç½®æ¯ä¸ªå¹³å°çš„æ ‡ç­¾å’Œç‰ˆæœ¬ï¼ˆéƒ½ä½¿ç”¨åŒä¸€ä¸ª build æ ‡ç­¾ï¼‰
            const foundTags = {
              macos: foundBuildTag,
              windows: foundBuildTag,
              android: foundBuildTag
            };
            
            const foundVersions = {
              macos: foundVersion,
              windows: foundVersion,
              android: foundVersion
            };
            
            // ç¡®å®š release ç‰ˆæœ¬å·
            let releaseVersion;
            if (useLatest) {
              // ä½¿ç”¨æ‰¾åˆ°çš„æœ€æ–°ç‰ˆæœ¬å·ï¼ˆå–ä¸‰ä¸ªå¹³å°ä¸­æœ€å¤§çš„ï¼‰
              releaseVersion = Object.values(foundVersions).reduce((max, v) => {
                if (!v) return max;
                if (!max) return v;
                return compareVersions(v, max) > 0 ? v : max;
              }, null);
              
              if (!releaseVersion) {
                core.setFailed('æœªæ‰¾åˆ°ä»»ä½•æ„å»ºæ ‡ç­¾');
                return;
              }
            } else {
              releaseVersion = targetVersion;
            }
            
            const releaseTag = `v${releaseVersion}`;
            console.log(`Release æ ‡ç­¾: ${releaseTag}`);
            
            // è¾“å‡ºæ‰¾åˆ°çš„æ ‡ç­¾
            if (foundBuildTag) {
              console.log(`æ‰¾åˆ°æ„å»ºæ ‡ç­¾: ${foundBuildTag} (ç‰ˆæœ¬: ${foundVersion})`);
            } else {
              const errorMsg = useLatest 
                ? 'æœªæ‰¾åˆ°ä»»ä½•æ„å»ºæ ‡ç­¾'
                : `æœªæ‰¾åˆ°æ„å»ºæ ‡ç­¾ï¼ˆç‰ˆæœ¬ <= ${targetVersion}ï¼‰`;
              core.setFailed(errorMsg);
              return;
            }
            
            // è·å–æ ‡ç­¾å¯¹åº”çš„ commit SHAï¼ˆlistTagsè¿”å›çš„tagå¯¹è±¡å·²ç»åŒ…å«commit.shaï¼‰
            const commitSha = foundTagObject.commit.sha;
            console.log(`æ ‡ç­¾ ${foundBuildTag} å¯¹åº”çš„ commit: ${commitSha.substring(0, 7)}`);
            
            // æŸ¥æ‰¾è¯¥ commit å¯¹åº”çš„æ€»æ„å»ºå·¥ä½œæµè¿è¡Œ
            const mainWorkflowFile = 'build.yml';
            let mainWorkflowRun = null;
            let mainPage = 1;
            let mainFound = false;
            
            while (!mainFound && mainPage <= 5) {
              const { data: runs } = await github.rest.actions.listWorkflowRuns({
                owner: context.repo.owner,
                repo: context.repo.repo,
                workflow_id: mainWorkflowFile,
                per_page: 30,
                page: mainPage
              });
              
              if (runs.workflow_runs.length === 0) break;
              
              // æŸ¥æ‰¾è¯¥ commit å¯¹åº”çš„æˆåŠŸè¿è¡Œ
              mainWorkflowRun = runs.workflow_runs.find(run => 
                run.head_sha === commitSha && 
                run.status === 'completed' && 
                run.conclusion === 'success'
              );
              
              if (mainWorkflowRun) {
                mainFound = true;
              } else {
                mainPage++;
              }
            }
            
            if (!mainWorkflowRun) {
              core.setFailed(`æœªæ‰¾åˆ°æ ‡ç­¾ ${foundBuildTag} å¯¹åº”çš„æˆåŠŸæ„å»ºè¿è¡Œ`);
              return;
            }
            
            console.log(`æ€»æ„å»ºå·¥ä½œæµè¿è¡Œ ID: ${mainWorkflowRun.id} (è¿è¡Œå·: ${mainWorkflowRun.run_number})`);
            
            // ä»ä¸»å·¥ä½œæµè¿è¡Œä¸­è·å–æ‰€æœ‰ä½œä¸šï¼ˆjobsï¼‰
            const { data: jobsData } = await github.rest.actions.listJobsForWorkflowRun({
              owner: context.repo.owner,
              repo: context.repo.repo,
              run_id: mainWorkflowRun.id
            });
            
            const workflowRuns = {
              macos: null,
              windows: null,
              android: null
            };
            
            // ä»ä½œä¸šä¸­æŸ¥æ‰¾ä¸‰ä¸ªå¹³å°çš„æ„å»ºä½œä¸š
            const platformKeywords = {
              macos: ['macos', 'client-macos'],
              windows: ['windows', 'client-windows'],
              android: ['android', 'server-android']
            };
            
            for (const job of jobsData.jobs) {
              const jobName = job.name.toLowerCase();
              
              // æŸ¥æ‰¾åŒ¹é…çš„å¹³å°ï¼ˆåªåŒ¹é…ä¸€æ¬¡ï¼Œé¿å…é‡å¤åŒ¹é…ï¼‰
              for (const [platform, keywords] of Object.entries(platformKeywords)) {
                // å¦‚æœå·²ç»æ‰¾åˆ°è¯¥å¹³å°çš„ä½œä¸šï¼Œè·³è¿‡
                if (workflowRuns[platform]) continue;
                
                if (keywords.some(keyword => jobName.includes(keyword))) {
                  if (job.status === 'completed' && job.conclusion === 'success') {
                    workflowRuns[platform] = mainWorkflowRun.id; // ä½¿ç”¨ä¸»å·¥ä½œæµè¿è¡ŒID
                    console.log(`  ${platform} ä½œä¸š: ${job.name} (ä½œä¸š ID: ${job.id}, çŠ¶æ€: ${job.status}, ç»“è®º: ${job.conclusion})`);
                  } else {
                    core.setFailed(`${platform} å¹³å°æ„å»ºæœªæˆåŠŸå®Œæˆï¼ˆçŠ¶æ€: ${job.status}, ç»“è®º: ${job.conclusion}ï¼‰`);
                    return;
                  }
                  break; // æ‰¾åˆ°åŒ¹é…åè·³å‡ºå†…å±‚å¾ªç¯
                }
              }
            }
            
            // æ£€æŸ¥æ˜¯å¦æ‰€æœ‰å¹³å°éƒ½æ‰¾åˆ°äº†
            for (const [platform, runId] of Object.entries(workflowRuns)) {
              if (!runId) {
                core.setFailed(`æœªæ‰¾åˆ° ${platform} å¹³å°çš„æˆåŠŸæ„å»ºä½œä¸š`);
                return;
              }
            }
            
            // è®¾ç½®è¾“å‡º
            core.setOutput('build_tag', foundBuildTag || '');
            core.setOutput('macos_run_id', workflowRuns.macos || '');
            core.setOutput('windows_run_id', workflowRuns.windows || '');
            core.setOutput('android_run_id', workflowRuns.android || '');
            core.setOutput('macos_tag', foundTags.macos || '');
            core.setOutput('windows_tag', foundTags.windows || '');
            core.setOutput('android_tag', foundTags.android || '');
            core.setOutput('macos_version', foundVersions.macos || '');
            core.setOutput('windows_version', foundVersions.windows || '');
            core.setOutput('android_version', foundVersions.android || '');
            core.setOutput('release_tag', releaseTag);
            core.setOutput('release_version', releaseVersion);
            
            return {
              workflowRuns,
              foundTags,
              foundVersions,
              releaseTag
            };

      - name: Checkout build tag and extract VERSION.yaml
        id: get_versions_from_tag
        run: |
          # è·å–æ‰¾åˆ°çš„ build tag
          BUILD_TAG="${{ steps.find_builds.outputs.build_tag }}"
          
          if [ -z "$BUILD_TAG" ] || [ "$BUILD_TAG" == "" ]; then
            echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° build tag"
            exit 1
          fi
          
          echo "ğŸ” ä» build tag è¯»å– VERSION.yaml..."
          echo "  Build Tag: ${BUILD_TAG}"
          
          # Checkout build tag ä»¥è·å– VERSION.yaml
          git fetch --tags --force
          git checkout "${BUILD_TAG}" -- VERSION.yaml 2>/dev/null || {
            echo "âš ï¸ æ— æ³• checkout VERSION.yamlï¼Œå°è¯•ä»å½“å‰å·¥ä½œåŒºè¯»å–"
            if [ ! -f "VERSION.yaml" ]; then
              echo "âŒ é”™è¯¯: æœªæ‰¾åˆ° VERSION.yaml"
              exit 1
            fi
          }
          
          # å®‰è£… PyYAML
          python3 -m pip install --user pyyaml --quiet || \
          python3 -c "import yaml" 2>/dev/null || python3 -m pip install pyyaml --quiet
          
          # ä» VERSION.yaml è¯»å–ç‰ˆæœ¬ä¿¡æ¯
          CLIENT_FULL_VERSION=$(python3 -c "import yaml; print(yaml.safe_load(open('VERSION.yaml'))['client']['version'])")
          SERVER_FULL_VERSION=$(python3 -c "import yaml; print(yaml.safe_load(open('VERSION.yaml'))['server']['version'])")
          
          # æå–ä¸»ç‰ˆæœ¬å·ï¼ˆå»é™¤build numberï¼‰
          CLIENT_VERSION_NUM=$(echo "${CLIENT_FULL_VERSION}" | sed 's/+.*//')
          SERVER_VERSION_NUM=$(echo "${SERVER_FULL_VERSION}" | sed 's/+.*//')
          
          # è®¾ç½® Release æ ‡ç­¾å’Œç‰ˆæœ¬å·
          TAG_VERSION="v${CLIENT_VERSION_NUM}"
          RELEASE_VERSION="${CLIENT_VERSION_NUM}"
          
          echo ""
          echo "âœ… ä» build tag (${BUILD_TAG}) çš„ VERSION.yaml æå–çš„ç‰ˆæœ¬ä¿¡æ¯:"
          echo "  Client Full Version: ${CLIENT_FULL_VERSION}"
          echo "  Client Version Number: ${CLIENT_VERSION_NUM}"
          echo "  Server Full Version: ${SERVER_FULL_VERSION}"
          echo "  Server Version Number: ${SERVER_VERSION_NUM}"
          echo "  Release Tag: ${TAG_VERSION}"
          echo "  Release Version: ${RELEASE_VERSION}"
          
          # è¾“å‡ºç‰ˆæœ¬å·ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          echo "CLIENT_VERSION=${CLIENT_FULL_VERSION}" >> $GITHUB_OUTPUT
          echo "CLIENT_VERSION_NUM=${CLIENT_VERSION_NUM}" >> $GITHUB_OUTPUT
          echo "CLIENT_FULL_VERSION=${CLIENT_FULL_VERSION}" >> $GITHUB_OUTPUT
          
          echo "SERVER_VERSION=${SERVER_FULL_VERSION}" >> $GITHUB_OUTPUT
          echo "SERVER_VERSION_NUM=${SERVER_VERSION_NUM}" >> $GITHUB_OUTPUT
          echo "SERVER_FULL_VERSION=${SERVER_FULL_VERSION}" >> $GITHUB_OUTPUT
          
          echo "TAG_VERSION=${TAG_VERSION}" >> $GITHUB_OUTPUT
          echo "RELEASE_VERSION=${RELEASE_VERSION}" >> $GITHUB_OUTPUT
          
          # ä¿å­˜ VERSION.yaml ä¾›åç»­æ­¥éª¤ä½¿ç”¨
          mkdir -p artifacts-temp
          cp VERSION.yaml ./artifacts-temp/VERSION.yaml

      - name: Download macOS artifact from build workflow
        uses: actions/download-artifact@v4
        with:
          name: HelloKnightRCC_macos
          path: ./artifacts-temp
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ steps.find_builds.outputs.macos_run_id }}
        continue-on-error: false

      - name: Download Windows artifact from build workflow
        uses: actions/download-artifact@v4
        with:
          name: HelloKnightRCC_windows
          path: ./artifacts-temp
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ steps.find_builds.outputs.windows_run_id }}
        continue-on-error: false

      - name: Download Android artifact from build workflow
        uses: actions/download-artifact@v4
        with:
          name: helloknightrcc_server_android
          path: ./artifacts-temp
          github-token: ${{ secrets.GITHUB_TOKEN }}
          run-id: ${{ steps.find_builds.outputs.android_run_id }}
        continue-on-error: false

      - name: Flatten artifacts structure and rename with correct version
        id: extract_versions_from_artifacts
        run: |
          mkdir -p artifacts
          
          # ä½¿ç”¨ä» build tag æå–çš„ç‰ˆæœ¬å·
          CLIENT_FULL_VERSION="${{ steps.get_versions_from_tag.outputs.CLIENT_FULL_VERSION }}"
          CLIENT_VERSION_NUM="${{ steps.get_versions_from_tag.outputs.CLIENT_VERSION_NUM }}"
          SERVER_FULL_VERSION="${{ steps.get_versions_from_tag.outputs.SERVER_FULL_VERSION }}"
          SERVER_VERSION_NUM="${{ steps.get_versions_from_tag.outputs.SERVER_VERSION_NUM }}"
          
          echo "ä½¿ç”¨ç‰ˆæœ¬å·é‡å‘½åæ–‡ä»¶ï¼ˆä» build tag çš„ VERSION.yaml è·å–ï¼‰:"
          echo "  CLIENT_VERSION=${CLIENT_FULL_VERSION}"
          echo "  SERVER_VERSION=${SERVER_FULL_VERSION}"
          
          # è¾“å‡ºç‰ˆæœ¬å·ä¾›åç»­æ­¥éª¤ä½¿ç”¨ï¼ˆç›´æ¥ä¼ é€’ï¼Œä¸ä¿®æ”¹ï¼‰
          echo "CLIENT_VERSION=${CLIENT_FULL_VERSION}" >> $GITHUB_OUTPUT
          echo "CLIENT_VERSION_NUM=${CLIENT_VERSION_NUM}" >> $GITHUB_OUTPUT
          echo "CLIENT_FULL_VERSION=${CLIENT_FULL_VERSION}" >> $GITHUB_OUTPUT
          
          echo "SERVER_VERSION=${SERVER_FULL_VERSION}" >> $GITHUB_OUTPUT
          echo "SERVER_VERSION_NUM=${SERVER_VERSION_NUM}" >> $GITHUB_OUTPUT
          echo "SERVER_FULL_VERSION=${SERVER_FULL_VERSION}" >> $GITHUB_OUTPUT
          
          # macOSæ–‡ä»¶ - zipæ–‡ä»¶ï¼ˆzipåŒ…é‡ŒåŒ…å«dmgæ–‡ä»¶ï¼‰
          MACOS_ZIP_COUNT=$(find ./artifacts-temp -name "HelloKnightRCC_macos_*.zip" | wc -l)
          if [ "$MACOS_ZIP_COUNT" -eq 0 ]; then
            echo "é”™è¯¯: æœªæ‰¾åˆ°macOS ZIPæ–‡ä»¶"
            exit 1
          elif [ "$MACOS_ZIP_COUNT" -gt 1 ]; then
            echo "é”™è¯¯: æ‰¾åˆ°å¤šä¸ªmacOS ZIPæ–‡ä»¶ï¼Œè¯·æ£€æŸ¥æ„å»ºäº§ç‰©"
            find ./artifacts-temp -name "HelloKnightRCC_macos_*.zip"
            exit 1
          fi
          MACOS_ZIP=$(find ./artifacts-temp -name "HelloKnightRCC_macos_*.zip" | head -1)
          # ä½¿ç”¨ä»æ–‡ä»¶åæå–çš„ç‰ˆæœ¬å·
          CLIENT_VERSION="${CLIENT_FULL_VERSION}"
          mv "$MACOS_ZIP" "./artifacts/HelloKnightRCC_macos_${CLIENT_VERSION}.zip"
          echo "é‡å‘½åmacOS ZIP: $(basename "$MACOS_ZIP") -> HelloKnightRCC_macos_${CLIENT_VERSION}.zip"
          echo "æ³¨æ„: macOS ZIPæ–‡ä»¶åŒ…å«DMGæ–‡ä»¶ï¼ˆå›ºå®šå‘½åï¼‰ï¼Œç”¨æˆ·éœ€è¦è§£å‹åæ‰“å¼€DMGå®‰è£…"
          
          # Windowsæ–‡ä»¶ - éœ€è¦ä»exeåˆ›å»ºzipç”¨äºæ›´æ–°
          # æ³¨æ„ï¼šWindowsæ„å»ºåªç”Ÿæˆexeï¼ˆå›ºå®šå‘½åï¼‰ï¼Œéœ€è¦å°†å…¶æ‰“åŒ…ä¸ºzip
          WINDOWS_EXE_COUNT=$(find ./artifacts-temp -name "HelloKnightRCC_windows_setup.exe" | wc -l)
          if [ "$WINDOWS_EXE_COUNT" -eq 0 ]; then
            echo "é”™è¯¯: æœªæ‰¾åˆ°Windows EXEæ–‡ä»¶"
            exit 1
          elif [ "$WINDOWS_EXE_COUNT" -gt 1 ]; then
            echo "é”™è¯¯: æ‰¾åˆ°å¤šä¸ªWindows EXEæ–‡ä»¶ï¼Œè¯·æ£€æŸ¥æ„å»ºäº§ç‰©"
            find ./artifacts-temp -name "HelloKnightRCC_windows_setup.exe"
            exit 1
          fi
          WINDOWS_EXE=$(find ./artifacts-temp -name "HelloKnightRCC_windows_setup.exe" | head -1)
          # å°†EXEæ‰“åŒ…ä¸ºzipç”¨äºæ›´æ–°ï¼ˆZIPæ–‡ä»¶ååŒ…å«ç‰ˆæœ¬å·ï¼Œå†…éƒ¨EXEä½¿ç”¨å›ºå®šå‘½åï¼‰
          cd artifacts-temp
          zip "../artifacts/HelloKnightRCC_windows_${CLIENT_VERSION}.zip" "$(basename "$WINDOWS_EXE")"
          cd ..
          echo "å·²åˆ›å»ºWindowsæ›´æ–°zip: HelloKnightRCC_windows_${CLIENT_VERSION}.zip (contains EXE file with fixed name: $(basename "$WINDOWS_EXE"))"
          
          # Androidæ–‡ä»¶ - æŸ¥æ‰¾å¹¶é‡å‘½åï¼ˆå·²ç»æ˜¯zipæ–‡ä»¶ï¼Œå†…éƒ¨APKä½¿ç”¨å›ºå®šå‘½åï¼‰
          ANDROID_ZIP_COUNT=$(find ./artifacts-temp -name "helloknightrcc_server_android_*.zip" | wc -l)
          if [ "$ANDROID_ZIP_COUNT" -eq 0 ]; then
            echo "é”™è¯¯: æœªæ‰¾åˆ°Android ZIPæ–‡ä»¶"
            exit 1
          elif [ "$ANDROID_ZIP_COUNT" -gt 1 ]; then
            echo "é”™è¯¯: æ‰¾åˆ°å¤šä¸ªAndroid ZIPæ–‡ä»¶ï¼Œè¯·æ£€æŸ¥æ„å»ºäº§ç‰©"
            find ./artifacts-temp -name "helloknightrcc_server_android_*.zip"
            exit 1
          fi
          ANDROID_ZIP=$(find ./artifacts-temp -name "helloknightrcc_server_android_*.zip" | head -1)
          # ä½¿ç”¨ä»æ–‡ä»¶åæå–çš„ç‰ˆæœ¬å·
          SERVER_VERSION="${SERVER_FULL_VERSION}"
          mv "$ANDROID_ZIP" "./artifacts/helloknightrcc_server_android_${SERVER_VERSION}.zip"
          echo "é‡å‘½åAndroid ZIP: $(basename "$ANDROID_ZIP") -> helloknightrcc_server_android_${SERVER_VERSION}.zip"
          echo "æ³¨æ„: Android ZIPæ–‡ä»¶åŒ…å«APKæ–‡ä»¶ï¼ˆå›ºå®šå‘½åï¼‰ï¼Œç”¨æˆ·éœ€è¦è§£å‹åå®‰è£…APK"
          
          rm -rf ./artifacts-temp
          
          echo ""
          echo "é‡å‘½ååçš„æ–‡ä»¶åˆ—è¡¨ï¼ˆä»…zipæ–‡ä»¶ï¼‰:"
          ls -la artifacts/

      - name: Verify artifacts exist before creating release
        run: |
          echo "ğŸ” éªŒè¯æ„å»ºäº§ç‰©æ–‡ä»¶æ˜¯å¦å­˜åœ¨..."
          
          # ä½¿ç”¨ä»æ„å»ºäº§ç‰©æ–‡ä»¶åæå–çš„ç‰ˆæœ¬å·
          CLIENT_VERSION="${{ steps.extract_versions_from_artifacts.outputs.CLIENT_FULL_VERSION }}"
          SERVER_VERSION="${{ steps.extract_versions_from_artifacts.outputs.SERVER_FULL_VERSION }}"
          
          MACOS_FILE="artifacts/HelloKnightRCC_macos_${CLIENT_VERSION}.zip"
          WINDOWS_FILE="artifacts/HelloKnightRCC_windows_${CLIENT_VERSION}.zip"
          ANDROID_FILE="artifacts/helloknightrcc_server_android_${SERVER_VERSION}.zip"
          
          ALL_FILES_EXIST=true
          
          if [ ! -f "$MACOS_FILE" ]; then
            echo "âŒ é”™è¯¯: macOS æ–‡ä»¶ä¸å­˜åœ¨: ${MACOS_FILE}"
            ls -la artifacts/ || echo "artifacts ç›®å½•ä¸å­˜åœ¨"
            ALL_FILES_EXIST=false
          else
            MACOS_SIZE=$(du -h "$MACOS_FILE" | cut -f1)
            echo "âœ… macOS æ–‡ä»¶å­˜åœ¨: ${MACOS_FILE} (${MACOS_SIZE})"
          fi
          
          if [ ! -f "$WINDOWS_FILE" ]; then
            echo "âŒ é”™è¯¯: Windows æ–‡ä»¶ä¸å­˜åœ¨: ${WINDOWS_FILE}"
            ls -la artifacts/ || echo "artifacts ç›®å½•ä¸å­˜åœ¨"
            ALL_FILES_EXIST=false
          else
            WINDOWS_SIZE=$(du -h "$WINDOWS_FILE" | cut -f1)
            echo "âœ… Windows æ–‡ä»¶å­˜åœ¨: ${WINDOWS_FILE} (${WINDOWS_SIZE})"
          fi
          
          if [ ! -f "$ANDROID_FILE" ]; then
            echo "âŒ é”™è¯¯: Android æ–‡ä»¶ä¸å­˜åœ¨: ${ANDROID_FILE}"
            ls -la artifacts/ || echo "artifacts ç›®å½•ä¸å­˜åœ¨"
            ALL_FILES_EXIST=false
          else
            ANDROID_SIZE=$(du -h "$ANDROID_FILE" | cut -f1)
            echo "âœ… Android æ–‡ä»¶å­˜åœ¨: ${ANDROID_FILE} (${ANDROID_SIZE})"
          fi
          
          if [ "$ALL_FILES_EXIST" = false ]; then
            echo ""
            echo "âŒ éƒ¨åˆ†æ„å»ºäº§ç‰©æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•åˆ›å»º Release"
            echo "è¯·æ£€æŸ¥æ„å»ºå·¥ä½œæµæ˜¯å¦æˆåŠŸå®Œæˆ"
            exit 1
          fi

          echo ""
          echo "âœ… æ‰€æœ‰æ„å»ºäº§ç‰©æ–‡ä»¶éªŒè¯é€šè¿‡"

      # è®¡ç®—æ–‡ä»¶hashå¹¶ç”Ÿæˆ GitHub æ›´æ–°é…ç½®æ–‡ä»¶ï¼ˆå¿…é¡»åœ¨ Create Release ä¹‹å‰ï¼‰
      - name: Calculate File Hashes and Generate GitHub Update Config
        run: |
          # ä½¿ç”¨ä»æ„å»ºäº§ç‰©æ–‡ä»¶åæå–çš„ç‰ˆæœ¬å·ï¼ˆä»extract_versions_from_artifactsæ­¥éª¤è·å–ï¼‰
          CLIENT_VERSION=${{ steps.extract_versions_from_artifacts.outputs.CLIENT_FULL_VERSION }}
          CLIENT_VERSION_NUMBER=${{ steps.extract_versions_from_artifacts.outputs.CLIENT_VERSION_NUM }}
          SERVER_VERSION=${{ steps.extract_versions_from_artifacts.outputs.SERVER_FULL_VERSION }}
          SERVER_VERSION_NUMBER=${{ steps.extract_versions_from_artifacts.outputs.SERVER_VERSION_NUM }}
          TAG_VERSION=${{ steps.get_versions.outputs.TAG_VERSION }}
          
          # GitHub Releases ä¸‹è½½é“¾æ¥æ ¼å¼ï¼ˆä½¿ç”¨å†…ç½®å˜é‡ï¼‰
          GITHUB_REPO="${{ github.repository }}"
          BASE_URL="https://github.com/${GITHUB_REPO}/releases/download/${TAG_VERSION}"
          
          # ä½¿ç”¨ä¼ é€’çš„ç‰ˆæœ¬å·æ„å»ºæ–‡ä»¶åï¼ˆç›´æ¥ä½¿ç”¨zipæ–‡ä»¶ï¼Œä¸åˆ›å»º_update.zipï¼‰
          MACOS_UPDATE_FILE="HelloKnightRCC_macos_${CLIENT_VERSION}.zip"
          WINDOWS_UPDATE_FILE="HelloKnightRCC_windows_${CLIENT_VERSION}.zip"
          ANDROID_FILE="helloknightrcc_server_android_${SERVER_VERSION}.zip"
          
          echo "ä½¿ç”¨æ›´æ–°æ–‡ä»¶åï¼ˆåŸºäºä¼ é€’çš„ç‰ˆæœ¬å·ï¼Œä»…zipæ–‡ä»¶ï¼‰:"
          echo "  macOS: $MACOS_UPDATE_FILE"
          echo "  Windows: $WINDOWS_UPDATE_FILE"
          echo "  Android: $ANDROID_FILE"
          
          # éªŒè¯æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "artifacts/$MACOS_UPDATE_FILE" ]; then
            echo "é”™è¯¯: macOSæ›´æ–°æ–‡ä»¶ä¸å­˜åœ¨: artifacts/$MACOS_UPDATE_FILE"
            exit 1
          fi
          
          if [ ! -f "artifacts/$WINDOWS_UPDATE_FILE" ]; then
            echo "é”™è¯¯: Windowsæ›´æ–°æ–‡ä»¶ä¸å­˜åœ¨: artifacts/$WINDOWS_UPDATE_FILE"
            exit 1
          fi
          
          if [ ! -f "artifacts/$ANDROID_FILE" ]; then
            echo "é”™è¯¯: Androidæ–‡ä»¶ä¸å­˜åœ¨: artifacts/$ANDROID_FILE"
            exit 1
          fi
          
          # è®¡ç®—æ–‡ä»¶SHA256 hashï¼ˆä½¿ç”¨zipæ–‡ä»¶ï¼‰
          MACOS_HASH=""
          WINDOWS_HASH=""
          ANDROID_HASH=""
          
          if [ -n "$MACOS_UPDATE_FILE" ] && [ -f "artifacts/$MACOS_UPDATE_FILE" ]; then
            MACOS_HASH=$(sha256sum "artifacts/$MACOS_UPDATE_FILE" | cut -d' ' -f1)
            echo "macOSæ›´æ–°æ–‡ä»¶hash: $MACOS_HASH"
          fi
          
          if [ -n "$WINDOWS_UPDATE_FILE" ] && [ -f "artifacts/$WINDOWS_UPDATE_FILE" ]; then
            WINDOWS_HASH=$(sha256sum "artifacts/$WINDOWS_UPDATE_FILE" | cut -d' ' -f1)
            echo "Windowsæ›´æ–°æ–‡ä»¶hash: $WINDOWS_HASH"
          fi
          
          if [ -n "$ANDROID_FILE" ] && [ -f "artifacts/$ANDROID_FILE" ]; then
            ANDROID_HASH=$(sha256sum "artifacts/$ANDROID_FILE" | cut -d' ' -f1)
            echo "Androidæ–‡ä»¶hash: $ANDROID_HASH"
          fi
          
          cat > update_config_github.json <<EOF
          {
            "client": {
              "version": "${CLIENT_VERSION}",
              "versionNumber": "${CLIENT_VERSION_NUMBER}",
              "platforms": {
                "macos": {
                  "version": "${CLIENT_VERSION}",
                  "versionNumber": "${CLIENT_VERSION_NUMBER}",
                  "downloadUrl": "${BASE_URL}/${MACOS_UPDATE_FILE}",
                  "fileName": "${MACOS_UPDATE_FILE}",
                  "fileType": "zip",
                  "platform": "macos",
                  "fileHash": "${MACOS_HASH}"
                },
                "windows": {
                  "version": "${CLIENT_VERSION}",
                  "versionNumber": "${CLIENT_VERSION_NUMBER}",
                  "downloadUrl": "${BASE_URL}/${WINDOWS_UPDATE_FILE}",
                  "fileName": "${WINDOWS_UPDATE_FILE}",
                  "fileType": "zip",
                  "platform": "windows",
                  "fileHash": "${WINDOWS_HASH}"
                }
              }
            },
            "server": {
              "version": "${SERVER_VERSION}",
              "versionNumber": "${SERVER_VERSION_NUMBER}",
              "platforms": {
                "android": {
                  "version": "${SERVER_VERSION}",
                  "versionNumber": "${SERVER_VERSION_NUMBER}",
                  "downloadUrl": "${BASE_URL}/${ANDROID_FILE}",
                  "fileName": "${ANDROID_FILE}",
                  "fileType": "zip",
                  "platform": "android",
                  "fileHash": "${ANDROID_HASH}"
                }
              }
            },
            "updateCheckUrl": "https://github.com/${{ github.repository }}/releases/download/UpdateConfig/update_config_github.json",
            "lastUpdated": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")"
          }
          EOF
          
          echo "GitHub æ›´æ–°é…ç½®æ–‡ä»¶å·²ç”Ÿæˆ:"
          cat update_config_github.json
          echo ""
          echo "âœ… é…ç½®æ–‡ä»¶å°†ä¸Šä¼ åˆ°å›ºå®šçš„ Release: UpdateConfig/update_config_github.json"
          
          # éªŒè¯é…ç½®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          if [ ! -f "update_config_github.json" ]; then
            echo "âŒ é”™è¯¯: update_config_github.json æ–‡ä»¶æœªç”Ÿæˆï¼"
            exit 1
          fi
          
          CONFIG_FILE_SIZE=$(stat -f%z update_config_github.json 2>/dev/null || stat -c%s update_config_github.json 2>/dev/null || echo "0")
          echo "âœ… é…ç½®æ–‡ä»¶å·²ç”Ÿæˆï¼Œå¤§å°: ${CONFIG_FILE_SIZE} bytes"
          
          # éªŒè¯é…ç½®æ–‡ä»¶å†…å®¹æ ¼å¼
          if ! jq empty update_config_github.json 2>/dev/null; then
            echo "âŒ é”™è¯¯: update_config_github.json ä¸æ˜¯æœ‰æ•ˆçš„ JSON æ ¼å¼ï¼"
            exit 1
          fi
          echo "âœ… é…ç½®æ–‡ä»¶ JSON æ ¼å¼éªŒè¯é€šè¿‡"
          
          # åˆ—å‡ºå½“å‰ç›®å½•çš„æ–‡ä»¶ï¼ˆè°ƒè¯•ç”¨ï¼‰
          echo ""
          echo "ğŸ“‹ å½“å‰ç›®å½•æ–‡ä»¶åˆ—è¡¨:"
          ls -lah update_config_github.json 2>/dev/null || echo "  âš ï¸ update_config_github.json ä¸å­˜åœ¨"

      - name: Delete existing Release if exists (including drafts)
        uses: actions/github-script@v7
        continue-on-error: true
        with:
          script: |
            const tagName = '${{ steps.get_versions.outputs.TAG_VERSION }}';
            console.log(`æŸ¥æ‰¾å¹¶åˆ é™¤æ ‡ç­¾ä¸º ${tagName} çš„æ‰€æœ‰ Releaseï¼ˆåŒ…æ‹¬ draftï¼‰...`);
            
            try {
              // é¦–å…ˆå°è¯•é€šè¿‡ tag è·å– releaseï¼ˆä¸åŒ…æ‹¬ draftï¼‰
              try {
                const release = await github.rest.repos.getReleaseByTag({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  tag: tagName
                });
                
                if (release.data) {
                  console.log(`æ‰¾åˆ°å·²å‘å¸ƒçš„ Release: ${release.data.id} (draft: ${release.data.draft})`);
                  await github.rest.repos.deleteRelease({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    release_id: release.data.id
                  });
                  console.log(`âœ“ å·²åˆ é™¤ Release: ${release.data.id}`);
                }
              } catch (tagError) {
                if (tagError.status !== 404) {
                  console.log(`é€šè¿‡ tag æŸ¥æ‰¾ Release æ—¶å‡ºé”™: ${tagError.message}`);
                }
              }
              
              // åˆ—å‡ºæ‰€æœ‰ releaseï¼ˆåŒ…æ‹¬ draftï¼‰ï¼ŒæŸ¥æ‰¾åŒ¹é… tag çš„ release
              let page = 1;
              let hasMore = true;
              let deletedCount = 0;
              
              while (hasMore) {
                const { data: releases } = await github.rest.repos.listReleases({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  per_page: 100,
                  page: page
                });
                
                if (releases.length === 0) {
                  hasMore = false;
                  break;
                }
                
                // æŸ¥æ‰¾åŒ¹é… tag çš„ releaseï¼ˆåŒ…æ‹¬ draftï¼‰
                for (const release of releases) {
                  if (release.tag_name === tagName) {
                    console.log(`æ‰¾åˆ°åŒ¹é…çš„ Release: ${release.id} (tag: ${release.tag_name}, draft: ${release.draft}, published: ${release.published_at || 'æœªå‘å¸ƒ'})`);
                    try {
                      await github.rest.repos.deleteRelease({
                        owner: context.repo.owner,
                        repo: context.repo.repo,
                        release_id: release.id
                      });
                      console.log(`âœ“ å·²åˆ é™¤ Release: ${release.id} (${release.draft ? 'draft' : 'published'})`);
                      deletedCount++;
                    } catch (deleteError) {
                      console.log(`åˆ é™¤ Release ${release.id} å¤±è´¥: ${deleteError.message}`);
                    }
                  }
                }
                
                if (releases.length < 100) {
                  hasMore = false;
                } else {
                  page++;
                }
              }
              
              if (deletedCount > 0) {
                console.log(`âœ“ å…±åˆ é™¤äº† ${deletedCount} ä¸ª Release`);
              } else {
                console.log('æœªæ‰¾åˆ°éœ€è¦åˆ é™¤çš„ Release');
              }
            } catch (error) {
              console.log(`æ£€æŸ¥ Release æ—¶å‡ºé”™: ${error.message}`);
              // ä¸æŠ›å‡ºé”™è¯¯ï¼Œç»§ç»­æ‰§è¡Œ
            }

      - name: Verify update_config_github.json exists
        run: |
          echo "ğŸ” éªŒè¯ update_config_github.json æ˜¯å¦å­˜åœ¨ï¼ˆå°†ä¸Šä¼ åˆ° UpdateConfig Releaseï¼‰..."
          if [ ! -f "update_config_github.json" ]; then
            echo "âŒ é”™è¯¯: update_config_github.json æ–‡ä»¶ä¸å­˜åœ¨ï¼"
            echo "å½“å‰ç›®å½•: $(pwd)"
            echo "æ–‡ä»¶åˆ—è¡¨:"
            ls -lah | head -20
            exit 1
          fi
          
          CONFIG_FILE_SIZE=$(stat -f%z update_config_github.json 2>/dev/null || stat -c%s update_config_github.json 2>/dev/null || echo "0")
          echo "âœ… update_config_github.json å­˜åœ¨ï¼Œå¤§å°: ${CONFIG_FILE_SIZE} bytes"
          
          # éªŒè¯ JSON æ ¼å¼
          if ! jq empty update_config_github.json 2>/dev/null; then
            echo "âŒ é”™è¯¯: update_config_github.json ä¸æ˜¯æœ‰æ•ˆçš„ JSON æ ¼å¼ï¼"
            exit 1
          fi
          echo "âœ… JSON æ ¼å¼éªŒè¯é€šè¿‡"
          echo "â„¹ï¸  é…ç½®æ–‡ä»¶å°†ä¸Šä¼ åˆ°å›ºå®šçš„ UpdateConfig Release"

      - name: Create Release
        id: create_release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ steps.get_versions.outputs.TAG_VERSION }}
          name: Release ${{ steps.get_versions.outputs.RELEASE_VERSION }}
          body: |
            ## Release ${{ steps.get_versions.outputs.RELEASE_VERSION }}

            ### Client
            - **macOS**: HelloKnightRCC_macos_${{ steps.extract_versions_from_artifacts.outputs.CLIENT_FULL_VERSION }}.zip
            - **Windows**: HelloKnightRCC_windows_${{ steps.extract_versions_from_artifacts.outputs.CLIENT_FULL_VERSION }}.zip

            ### Server
            - **Android**: helloknightrcc_server_android_${{ steps.extract_versions_from_artifacts.outputs.SERVER_FULL_VERSION }}.zip

            ### Changes
            - See commit history for details
          files: |
            artifacts/HelloKnightRCC_macos_${{ steps.extract_versions_from_artifacts.outputs.CLIENT_FULL_VERSION }}.zip
            artifacts/HelloKnightRCC_windows_${{ steps.extract_versions_from_artifacts.outputs.CLIENT_FULL_VERSION }}.zip
            artifacts/helloknightrcc_server_android_${{ steps.extract_versions_from_artifacts.outputs.SERVER_FULL_VERSION }}.zip
          # æ³¨æ„ï¼šupdate_config_github.json ä¸å†ä¸Šä¼ åˆ°ç‰ˆæœ¬ Releaseï¼Œè€Œæ˜¯ä¸Šä¼ åˆ°å›ºå®šçš„ UpdateConfig Release
          draft: false
          prerelease: false
          fail_on_unmatched_files: true
          generate_release_notes: false

      - name: Verify Release created successfully (not draft)
        run: |
          TAG_NAME="${{ steps.get_versions.outputs.TAG_VERSION }}"
          echo "ğŸ” éªŒè¯ GitHub Release æ˜¯å¦åˆ›å»ºæˆåŠŸï¼ˆé draftï¼‰..."
          echo "  æ ‡ç­¾: ${TAG_NAME}"
          
          # ç­‰å¾…ä¸€ä¸‹ï¼Œç¡®ä¿ Release å®Œå…¨åˆ›å»º
          sleep 5
          
          # æ£€æŸ¥ Release æ˜¯å¦å­˜åœ¨ï¼ˆé€šè¿‡ tagï¼Œä¸åŒ…æ‹¬ draftï¼‰
          RELEASE_INFO=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/${TAG_NAME}")
          
          if echo "${RELEASE_INFO}" | grep -q '"id"'; then
            RELEASE_ID=$(echo "${RELEASE_INFO}" | jq -r '.id')
            RELEASE_NAME=$(echo "${RELEASE_INFO}" | jq -r '.name')
            RELEASE_DRAFT=$(echo "${RELEASE_INFO}" | jq -r '.draft')
            RELEASE_PUBLISHED=$(echo "${RELEASE_INFO}" | jq -r '.published_at // empty')
            ASSETS_COUNT=$(echo "${RELEASE_INFO}" | jq -r '.assets | length')
            
            if [ "$RELEASE_DRAFT" = "true" ]; then
              echo "âŒ é”™è¯¯: Release åˆ›å»ºä¸º draft çŠ¶æ€ï¼"
              echo "  Release ID: ${RELEASE_ID}"
              echo "  Release åç§°: ${RELEASE_NAME}"
              echo "  çŠ¶æ€: draft"
              echo ""
              echo "è¿™é€šå¸¸æ˜¯å› ä¸ºæ–‡ä»¶ä¸Šä¼ å¤±è´¥å¯¼è‡´çš„ã€‚è¯·æ£€æŸ¥ï¼š"
              echo "  1. æ„å»ºäº§ç‰©æ–‡ä»¶æ˜¯å¦å­˜åœ¨"
              echo "  2. æ–‡ä»¶å¤§å°æ˜¯å¦è¶…è¿‡é™åˆ¶"
              echo "  3. GitHub API æ˜¯å¦æœ‰é”™è¯¯"
              exit 1
            fi
            
            if [ -z "$RELEASE_PUBLISHED" ]; then
              echo "âŒ é”™è¯¯: Release æœªå‘å¸ƒï¼"
              echo "  Release ID: ${RELEASE_ID}"
              echo "  Release åç§°: ${RELEASE_NAME}"
              exit 1
            fi
            
            echo "âœ… GitHub Release åˆ›å»ºæˆåŠŸ"
            echo "  Release ID: ${RELEASE_ID}"
            echo "  Release åç§°: ${RELEASE_NAME}"
            echo "  çŠ¶æ€: published (é draft)"
            echo "  å‘å¸ƒæ—¶é—´: ${RELEASE_PUBLISHED}"
            echo "  æ„å»ºäº§ç‰©æ•°é‡: ${ASSETS_COUNT}"
            echo ""
            echo "â„¹ï¸  æ³¨æ„: update_config_github.json å°†ä¸Šä¼ åˆ°å›ºå®šçš„ UpdateConfig Release"
          else
            # å¦‚æœé€šè¿‡ tag æ‰¾ä¸åˆ°ï¼Œå°è¯•åˆ—å‡ºæ‰€æœ‰ release æŸ¥æ‰¾ï¼ˆåŒ…æ‹¬ draftï¼‰
            echo "âš ï¸  é€šè¿‡ tag æœªæ‰¾åˆ° Releaseï¼Œå°è¯•æŸ¥æ‰¾æ‰€æœ‰ Releaseï¼ˆåŒ…æ‹¬ draftï¼‰..."
            ALL_RELEASES=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
              "https://api.github.com/repos/${{ github.repository }}/releases?per_page=100")
            
            MATCHED_RELEASE=$(echo "${ALL_RELEASES}" | jq -r ".[] | select(.tag_name == \"${TAG_NAME}\") | .id" | head -1)
            
            if [ -n "$MATCHED_RELEASE" ] && [ "$MATCHED_RELEASE" != "null" ]; then
              RELEASE_DETAIL=$(echo "${ALL_RELEASES}" | jq -r ".[] | select(.id == ${MATCHED_RELEASE})")
              RELEASE_DRAFT=$(echo "${RELEASE_DETAIL}" | jq -r '.draft')
              
              if [ "$RELEASE_DRAFT" = "true" ]; then
                echo "âŒ é”™è¯¯: Release åˆ›å»ºä¸º draft çŠ¶æ€ï¼"
                echo "  Release ID: ${MATCHED_RELEASE}"
                echo "  æ ‡ç­¾: ${TAG_NAME}"
                echo "  çŠ¶æ€: draft"
                echo ""
                echo "è¿™é€šå¸¸æ˜¯å› ä¸ºæ–‡ä»¶ä¸Šä¼ å¤±è´¥å¯¼è‡´çš„ã€‚è¯·æ£€æŸ¥æ„å»ºäº§ç‰©ã€‚"
                exit 1
              else
                echo "âœ… æ‰¾åˆ° Release: ${MATCHED_RELEASE}"
              fi
            else
              echo "âŒ GitHub Release åˆ›å»ºå¤±è´¥æˆ–æœªæ‰¾åˆ°"
              echo "  æ ‡ç­¾: ${TAG_NAME}"
              echo "  å“åº”: ${RELEASE_INFO}"
              exit 1
            fi
          fi

      - name: Get current timestamp
        id: get_timestamp
        run: |
          echo "timestamp=$(date -u +'%Y-%m-%d %H:%M:%S UTC')" >> $GITHUB_OUTPUT

      - name: Create or Update UpdateConfig Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: UpdateConfig
          name: UpdateConfig
          body: |
            ## UpdateConfig Release
            
            This release contains the update configuration file for the application.
            
            The configuration file is automatically updated when a new version is released.
            
            **Latest Version**: ${{ steps.get_versions.outputs.RELEASE_VERSION }}
            **Last Updated**: ${{ steps.get_timestamp.outputs.timestamp }}
          files: |
            update_config_github.json
          draft: false
          prerelease: false
          fail_on_unmatched_files: true
          generate_release_notes: false

      - name: Verify UpdateConfig Release created successfully
        run: |
          echo "ğŸ” éªŒè¯ UpdateConfig Release æ˜¯å¦åˆ›å»ºæˆåŠŸ..."
          
          # ç­‰å¾…ä¸€ä¸‹ï¼Œç¡®ä¿ Release å®Œå…¨åˆ›å»º
          sleep 5
          
          # æ£€æŸ¥ UpdateConfig Release æ˜¯å¦å­˜åœ¨
          RELEASE_INFO=$(curl -s -H "Authorization: token ${{ secrets.GITHUB_TOKEN }}" \
            "https://api.github.com/repos/${{ github.repository }}/releases/tags/UpdateConfig")
          
          if echo "${RELEASE_INFO}" | grep -q '"id"'; then
            RELEASE_ID=$(echo "${RELEASE_INFO}" | jq -r '.id')
            RELEASE_NAME=$(echo "${RELEASE_INFO}" | jq -r '.name')
            RELEASE_DRAFT=$(echo "${RELEASE_INFO}" | jq -r '.draft')
            ASSETS_COUNT=$(echo "${RELEASE_INFO}" | jq -r '.assets | length')
            
            if [ "$RELEASE_DRAFT" = "true" ]; then
              echo "âŒ é”™è¯¯: UpdateConfig Release åˆ›å»ºä¸º draft çŠ¶æ€ï¼"
              exit 1
            fi
            
            echo "âœ… UpdateConfig Release åˆ›å»ºæˆåŠŸ"
            echo "  Release ID: ${RELEASE_ID}"
            echo "  Release åç§°: ${RELEASE_NAME}"
            echo "  çŠ¶æ€: published (é draft)"
            echo "  æ–‡ä»¶æ•°é‡: ${ASSETS_COUNT}"
            
            # æ£€æŸ¥ update_config_github.json æ˜¯å¦åœ¨ Release ä¸­
            ASSETS=$(echo "${RELEASE_INFO}" | jq -r '.assets[] | "\(.name)|\(.size)"' 2>/dev/null || echo "")
            if echo "$ASSETS" | grep -q "update_config_github.json"; then
              echo "  âœ… update_config_github.json å·²æˆåŠŸä¸Šä¼ åˆ° UpdateConfig Release"
              echo "$ASSETS" | while IFS='|' read -r asset_name asset_size; do
                if [ "$asset_name" = "update_config_github.json" ]; then
                  echo "    æ–‡ä»¶: ${asset_name} (${asset_size} bytes)"
                fi
              done
            else
              echo "  âŒ é”™è¯¯: update_config_github.json æœªåœ¨ UpdateConfig Release ä¸­æ‰¾åˆ°ï¼"
              echo "  å·²ä¸Šä¼ çš„æ–‡ä»¶åˆ—è¡¨:"
              echo "$ASSETS" | while IFS='|' read -r asset_name asset_size; do
                echo "    - ${asset_name} (${asset_size} bytes)"
              done
              exit 1
            fi
          else
            echo "âŒ UpdateConfig Release åˆ›å»ºå¤±è´¥æˆ–æœªæ‰¾åˆ°"
            echo "  å“åº”: ${RELEASE_INFO}"
            exit 1
          fi

      - name: Set job outputs
        id: set_outputs
        run: |
          TAG_VERSION="${{ steps.get_versions.outputs.TAG_VERSION }}"
          RELEASE_VERSION="${{ steps.get_versions.outputs.RELEASE_VERSION }}"
          
          # è°ƒè¯•ä¿¡æ¯
          echo "ğŸ” è®¾ç½® job è¾“å‡º:"
          echo "  TAG_VERSION: ${TAG_VERSION}"
          echo "  RELEASE_VERSION: ${RELEASE_VERSION}"
          
          # ç¡®ä¿ TAG_VERSION ä¸ä¸ºç©º
          if [ -z "$TAG_VERSION" ] || [ "$TAG_VERSION" == "" ]; then
            echo "âš ï¸  è­¦å‘Š: TAG_VERSION ä¸ºç©ºï¼Œå°è¯•ä» find_builds è·å–..."
            TAG_VERSION="${{ steps.find_builds.outputs.release_tag }}"
            echo "  ä» find_builds è·å–: ${TAG_VERSION}"
          fi
          
          # å¦‚æœè¿˜æ˜¯ä¸ºç©ºï¼ŒæŠ¥é”™
          if [ -z "$TAG_VERSION" ] || [ "$TAG_VERSION" == "" ]; then
            echo "âŒ é”™è¯¯: æ— æ³•è·å– release_tag"
            exit 1
          fi
          
          echo "release_tag=${TAG_VERSION}" >> $GITHUB_OUTPUT
          echo "release_version=${RELEASE_VERSION}" >> $GITHUB_OUTPUT
          
          echo "âœ… è¾“å‡ºå·²è®¾ç½®:"
          echo "  release_tag: ${TAG_VERSION}"
          echo "  release_version: ${RELEASE_VERSION}"

  sync-to-gitee:
    name: Sync Release to Gitee
    needs: create-release
    if: success()  # åªæœ‰åœ¨ create-release æˆåŠŸåæ‰æ‰§è¡Œ
    uses: ./.github/workflows/sync-to-gitee.yml
    with:
      release_tag: ${{ needs.create-release.outputs.release_tag }}
    secrets: inherit

