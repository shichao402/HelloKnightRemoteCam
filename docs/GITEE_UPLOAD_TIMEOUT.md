# Gitee API 上传超时问题解决方案

## 问题描述

在 GitHub Actions 中调用 Gitee API 上传文件时，经常遇到超时问题。主要原因包括：

1. **网络延迟和不稳定**：GitHub Actions 运行环境与 Gitee 服务器之间的网络延迟
2. **Gitee API 限流**：频繁请求可能触发限流机制
3. **文件大小**：大文件上传需要更长时间
4. **服务器负载**：Gitee 服务器负载高时响应变慢

## 解决方案

### 1. 增加超时时间

#### 连接超时（`--connect-timeout`）
- **设置值**：30 秒
- **作用**：建立连接的最大等待时间
- **说明**：如果 30 秒内无法建立连接，立即失败

#### 传输超时（`--max-time`）
- **计算公式**：`文件大小 / 50KB/s + 600秒（10分钟缓冲）`
- **最小值**：600 秒（10 分钟）
- **最大值**：3600 秒（60 分钟）
- **说明**：
  - 假设平均上传速度 50KB/s（保守估计，考虑网络波动）
  - 加上 10 分钟缓冲时间，应对网络不稳定
  - 对于 20MB 文件：`20*1024*1024/51200 + 600 = 409 + 600 = 1009秒`（约 17 分钟）

### 2. 自动重试机制

使用 curl 的内置重试功能：

```bash
--retry 2                    # 失败后重试 2 次
--retry-delay 3              # 重试前等待 3 秒
--retry-connrefused          # 连接被拒绝时也重试
```

**说明**：
- 对于临时网络错误，自动重试可以避免因短暂网络波动导致的失败
- 重试延迟避免立即重试，给服务器恢复时间

### 3. 请求间隔控制

在多个文件上传之间添加延迟，避免触发 API 限流：

```bash
# 每个文件上传前等待 2 秒（第一个文件除外）
if [ $FILE_INDEX -gt 1 ]; then
  echo "   ⏸️  等待 2 秒以避免 API 限流..."
  sleep 2
fi
```

**说明**：
- Gitee API 可能有速率限制
- 添加延迟可以避免短时间内发送过多请求
- 2 秒间隔在速度和稳定性之间取得平衡

### 4. 应用层重试机制

除了 curl 的内置重试，还实现了应用层重试：

```bash
MAX_RETRIES=3        # 最多重试 3 次
RETRY_DELAY=5        # 重试前等待 5 秒
```

**重试策略**：
- 只对可重试的错误进行重试（429, 500, 502, 503, 504）
- 认证错误（401, 403）和资源不存在（404）不重试
- 每次重试前等待 5 秒

## 当前实现

### 文件上传超时设置

```bash
# 连接超时
CONNECT_TIMEOUT=30

# 传输超时（动态计算）
MAX_TIMEOUT=$((filesize_bytes / 51200 + 600))
if [ $MAX_TIMEOUT -lt 600 ]; then
  MAX_TIMEOUT=600  # 最小 10 分钟
fi
if [ $MAX_TIMEOUT -gt 3600 ]; then
  MAX_TIMEOUT=3600  # 最大 60 分钟
fi

# curl 命令
curl --progress-bar --show-error \
  --connect-timeout ${CONNECT_TIMEOUT} \
  --max-time ${MAX_TIMEOUT} \
  --retry 2 \
  --retry-delay 3 \
  --retry-connrefused \
  ...
```

### 配置文件上传超时设置

```bash
CONNECT_TIMEOUT=30
MAX_TIMEOUT=600  # 固定 10 分钟（配置文件通常较小）
```

## 超时时间参考

| 文件大小 | 计算超时 | 实际超时 | 说明 |
|---------|---------|---------|------|
| 1MB | 20 + 600 = 620秒 | 600秒（最小值） | 约 10 分钟 |
| 10MB | 200 + 600 = 800秒 | 800秒 | 约 13 分钟 |
| 20MB | 409 + 600 = 1009秒 | 1009秒 | 约 17 分钟 |
| 50MB | 1024 + 600 = 1624秒 | 1624秒 | 约 27 分钟 |
| 100MB | 2048 + 600 = 2648秒 | 2648秒 | 约 44 分钟 |
| 200MB+ | 4096+ + 600 = 4696+秒 | 3600秒（最大值） | 60 分钟 |

## 最佳实践

1. **监控上传速度**：通过进度条观察实际上传速度
2. **调整超时时间**：如果经常超时，可以增加缓冲时间
3. **分批上传**：对于大量文件，考虑分批上传
4. **错误处理**：区分可重试和不可重试的错误
5. **日志记录**：记录上传耗时，便于分析问题

## 相关文件

- `.github/workflows/sync-to-gitee.yml`: Gitee 同步工作流
- `docs/CURL_PROGRESS_BAR.md`: curl 进度条显示最佳实践

## 历史问题

- **问题**：GitHub Actions 调用 Gitee API 上传文件时经常超时
- **原因**：
  - 超时时间设置过短（最大 30 分钟）
  - 没有区分连接超时和传输超时
  - 缺少请求间隔控制
- **解决方案**：
  - 增加传输超时时间（最大 60 分钟）
  - 添加连接超时设置（30 秒）
  - 添加请求间隔（2 秒）
  - 使用 curl 内置重试机制
  - 优化超时计算公式（更保守的速度估计）

