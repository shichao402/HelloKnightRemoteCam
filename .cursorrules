# HelloKnightRemoteCam 项目规则

## 日志规则 - 最高优先级

### 1. 独立日志文件（强制）
所有组件必须将日志写入独立的日志文件，不依赖系统日志。

**手机端：** `/data/data/com.example.remote_cam_server/app_flutter/logs/debug_*.log`
**客户端：** `~/Library/Application Support/com.example.helloKnightRCC/logs/client_debug_*.log`

### 2. 自动化日志收集（强制）
开发调试时，AI必须主动收集日志，不要求用户手动操作。

**强制使用脚本：** `scripts/collect_all_logs.sh`

**禁止手动操作：**
- ❌ 禁止手动使用adb命令
- ❌ 禁止手动访问日志文件路径
- ❌ 禁止手动执行任何日志收集命令
- ✅ 必须使用`./scripts/collect_all_logs.sh`脚本
- 不需要使用tail命令查看日志，直接使用脚本收集所有日志

### 3. 日志查阅优先级（强制）
1. 应用独立日志文件（第一优先级）
2. Flutter print输出
3. 系统日志（最后手段）

### 4. 错误日志标准（强制）
所有catch必须包含堆栈跟踪：
```dart
catch (e, stackTrace) {
  logger.logError('操作失败', error: e, stackTrace: stackTrace);
}
```

### 5. 关键操作必须记录（强制）
- 操作开始
- 操作成功
- 操作失败（含错误详情）

## 测试流程规则

### 测试时AI必须主动（强制使用脚本）：
1. **使用部署脚本部署手机端和客户端**
   - 手机端：`cd server && ./scripts/deploy_android.sh`
   - Mac客户端：`cd client && ./scripts/deploy_mac.sh`
   - Windows客户端：`cd client && scripts\deploy_windows.bat`
2. 执行测试操作
3. **立即使用日志收集脚本收集所有日志**
   - 执行：`./scripts/collect_all_logs.sh`
4. 分析日志定位问题
5. 修复问题
6. **重新部署和收集日志验证修复**

### 禁止行为：
- ❌ 要求用户手动复制日志
- ❌ 要求用户截图
- ❌ 依赖系统日志而不查看应用日志
- ❌ 等待用户提供信息而不主动收集
- ❌ 手动执行任何命令（必须使用脚本）

## 开发规则

### 日志服务优先
每个新组件必须首先实现日志系统。

### 调试模式
开发阶段默认启用调试模式和日志文件写入。

### 日志自动清理
- 保留最近10个日志文件
- 单个文件<10MB
- 总大小<50MB

## 调试规则（强制）- 最高优先级

### 强制使用预置脚本（强制）
**所有调试操作必须使用项目中已有的脚本，禁止手动执行命令。**

### 可用脚本列表

#### 1. 日志收集脚本（强制使用）
**路径：** `scripts/collect_all_logs.sh`

**用途：** 收集手机端和客户端的全部日志

**使用方式：**
```bash
./scripts/collect_all_logs.sh
```

**何时使用：**
- 调试任何问题时
- 测试完成后
- 出现错误时
- 需要查看日志时

#### 2. 手机端部署脚本（强制使用）
**路径：** `server/scripts/deploy.sh` 或 `server/scripts/deploy_android.sh`（向后兼容）

**用途：** 构建并部署手机端Android应用

**使用方式：**
```bash
cd server && ./scripts/deploy.sh --debug
# 或使用向后兼容脚本
cd server && ./scripts/deploy_android.sh
```

**功能：**
- 自动查找Flutter
- 构建APK
- 检查设备连接
- 安装APK
- 可选启动应用

#### 3. Mac客户端部署脚本（强制使用）
**路径：** `client/scripts/deploy.sh` 或 `client/scripts/deploy_mac.sh`（向后兼容）

**用途：** 构建并部署Mac客户端应用

**使用方式：**
```bash
cd client && ./scripts/deploy.sh --debug --macos
# 或使用向后兼容脚本
cd client && ./scripts/deploy_mac.sh
```

**功能：**
- 自动查找Flutter
- 构建macOS应用
- 可选启动应用

#### 4. Windows客户端部署脚本（强制使用）
**路径：** `client/scripts/deploy.sh` 或 `client/scripts/deploy_windows.bat`（向后兼容）

**用途：** 构建并部署Windows客户端应用

**使用方式：**
```bash
cd client && bash scripts/deploy.sh --debug --windows
# 或使用向后兼容脚本（需要 Git Bash 或 WSL）
cd client && scripts\deploy_windows.bat
```

### 调试流程强制规则

1. **部署应用：** 必须使用部署脚本，不得手动执行flutter命令
2. **收集日志：** 必须使用`collect_all_logs.sh`脚本，不得手动使用adb或文件系统命令
3. **分析问题：** 基于脚本收集的日志进行分析
4. **修复问题：** 修复后必须重新部署和收集日志验证

### 严格禁止的行为：
- ❌ 手动查找flutter路径
- ❌ 手动执行flutter命令（build、run、install等）
- ❌ 手动使用adb命令收集日志
- ❌ 手动访问日志文件路径
- ❌ 不使用预置脚本进行任何调试操作
- ❌ 要求用户手动执行命令
- ❌ 绕过脚本直接操作

### 必须遵守：
- ✅ 所有部署必须使用部署脚本
- ✅ 所有日志收集必须使用`collect_all_logs.sh`
- ✅ 调试流程必须遵循：部署 → 测试 → 收集日志 → 分析 → 修复
- ✅ AI必须主动执行脚本，不要求用户操作

### 脚本维护规则（强制）
**如果预置脚本无法完成工作，必须修改脚本使其符合预期正常工作。**

#### 脚本问题处理流程：
1. **发现问题：** 当脚本执行失败或无法完成预期功能时
2. **分析问题：** 检查脚本错误信息，定位问题原因
3. **修复脚本：** 直接修改脚本文件，使其能够正常工作
4. **验证修复：** 重新执行脚本，确保问题已解决
5. **继续工作：** 使用修复后的脚本继续完成调试任务

#### 禁止行为：
- ❌ 脚本失败后不使用脚本，改为手动执行命令
- ❌ 要求用户手动修复脚本
- ❌ 跳过脚本直接操作
- ❌ 不修复脚本而使用临时方案

#### 必须遵守：
- ✅ 脚本出现问题必须立即修复
- ✅ 修复脚本是AI的责任，不得推给用户
- ✅ 修复后的脚本必须能够正常完成预期功能
- ✅ 修复脚本后必须验证脚本能够正常工作
- ✅ 保持脚本的健壮性和可维护性

## 构建和部署规则（强制）

### 使用预置脚本（强制）
AI必须使用项目中已有的脚本，不得手动查找工具路径。

**手机端部署：**
```bash
cd server && ./scripts/deploy_android.sh
```

**Mac客户端部署：**
```bash
cd client && ./scripts/deploy_mac.sh
```

**Windows客户端部署：**
```bash
cd client && scripts\deploy_windows.bat
```

### 禁止行为：
- ❌ 手动查找flutter路径
- ❌ 手动执行flutter命令
- ❌ 不使用预置脚本
- ✅ 必须使用scripts目录中的部署脚本

## 实施状态

### 手机端（Server）
- [x] LoggerService
- [x] 独立日志文件
- [x] HTTP日志
- [x] 相机日志
- [x] 错误堆栈跟踪
- [x] adb可获取

### 客户端（Client）
- [x] ClientLoggerService
- [x] 独立日志文件
- [x] API调用日志
- [x] 错误堆栈跟踪
- [x] 文件系统可访问

### 日志收集
- [x] collect_all_logs.sh脚本
- [x] 自动收集手机端日志
- [x] 自动收集客户端日志

